<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryMagic Pro - Photo Cartoonization System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 25px;
            box-shadow: 0 25px 70px rgba(0,0,0,0.4);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #ff6b6b, #ffa726, #4ecdc4);
            color: white;
            text-align: center;
            padding: 25px;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 800;
        }

        .header p {
            font-size: 1.3em;
            opacity: 0.95;
            font-weight: 500;
        }

        .main-content {
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 0;
            min-height: 900px;
        }

        .form-section {
            padding: 30px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-right: 3px solid #dee2e6;
        }

        .preview-section {
            padding: 20px;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.9em;
            font-family: inherit;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.2);
        }

        .photo-upload-section {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 5px solid #4caf50;
        }

        .photo-upload-section h4 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-weight: 700;
            text-align: center;
        }

        .photo-preview {
            text-align: center;
            margin-top: 15px;
        }

        .photo-preview img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #4caf50;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .photo-status {
            margin-top: 10px;
            font-weight: 600;
            color: #2e7d32;
        }

        .detail-section {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 5px solid #2196f3;
        }

        .detail-section h4 {
            color: #1976d2;
            margin-bottom: 10px;
            font-size: 1em;
            font-weight: 700;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .generate-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 18px 25px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            position: relative;
            overflow: hidden;
            margin-top: 15px;
            box-shadow: 0 8px 20px rgba(78, 205, 196, 0.3);
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 25px rgba(78, 205, 196, 0.4);
        }

        .generate-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .loading-spinner {
            display: none;
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translateY(-50%) rotate(0deg); }
            100% { transform: translateY(-50%) rotate(360deg); }
        }

        .book-display {
            display: none;
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            border: 3px solid #f0f0f0;
        }

        .book-image {
            width: 100%;
            height: 600px;
            object-fit: cover;
            background: #f8f9fa;
            border-bottom: 2px solid #eee;
        }

        .book-content {
            padding: 25px 35px 20px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }

        .book-title {
            font-size: 1.6em;
            color: #2c3e50;
            margin-bottom: 12px;
            font-weight: 700;
            text-align: center;
        }

        .book-text {
            font-size: 1.1em;
            line-height: 1.6;
            color: #495057;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 500;
            font-family: 'Georgia', serif;
        }

        .moral-lesson {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 5px solid #ffb74d;
            text-align: center;
        }

        .book-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 35px;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .nav-btn {
            background: rgba(255,255,255,0.15);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .page-indicator {
            font-weight: 700;
            color: white;
            font-size: 1.1em;
        }

        .message {
            padding: 12px 15px;
            border-radius: 10px;
            margin-top: 12px;
            display: none;
            font-weight: 500;
            font-size: 0.9em;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }

        .default-preview {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }

        .preview-placeholder {
            width: 280px;
            height: 280px;
            border-radius: 20px;
            background: linear-gradient(45deg, #ff9a9e, #fecfef, #ffecd2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 6em;
            margin: 30px auto;
            border: 5px solid white;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: float 4s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }

        .cartoonization-info {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            border-left: 5px solid #ff9800;
        }

        .cartoonization-info h4 {
            color: #e65100;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .cartoonization-info ul {
            list-style: none;
            padding: 0;
        }

        .cartoonization-info li {
            color: #bf360c;
            margin-bottom: 8px;
            font-size: 0.9em;
            padding-left: 20px;
            position: relative;
        }

        .cartoonization-info li:before {
            content: "üé®";
            position: absolute;
            left: 0;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö StoryMagic Pro</h1>
            <p>Photo-to-Cartoon Children's Books - Your Child as the Hero!</p>
        </div>

        <div class="main-content">
            <div class="form-section">
                <h2 style="color: #333; margin-bottom: 20px; text-align: center; font-weight: 700;">Create Personalized Story Book</h2>
                
                <div class="photo-upload-section">
                    <h4>üì∏ Upload Your Child's Photo</h4>
                    <div class="form-group">
                        <input type="file" id="childPhoto" accept="image/*" onchange="handlePhotoUpload(event)">
                        <small style="color: #666; font-size: 0.8em;">Upload a clear photo of your child's face for AI cartoonization!</small>
                    </div>

                    <div class="photo-preview" id="photoPreview" style="display: none;">
                        <img id="uploadedPhoto" alt="Child's photo">
                        <div class="photo-status">‚úÖ Photo Ready for Cartoonization!</div>
                    </div>
                </div>

                <div class="detail-section">
                    <h4>üë∂ Child Information</h4>
                    
                    <div class="form-group">
                        <label for="childName">Child's Name</label>
                        <input type="text" id="childName" placeholder="Enter child's name" value="Dom">
                    </div>

                    <div class="row">
                        <div class="form-group">
                            <label for="childAge">Age</label>
                            <select id="childAge">
                                <option value="3">3 years old</option>
                                <option value="4" selected>4 years old</option>
                                <option value="5">5 years old</option>
                                <option value="6">6 years old</option>
                                <option value="7">7 years old</option>
                                <option value="8">8 years old</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="childGender">Gender</label>
                            <select id="childGender">
                                <option value="girl" selected>Girl</option>
                                <option value="boy">Boy</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="storyTheme">Story Theme</label>
                        <select id="storyTheme">
                            <option value="kindness">üåª Kindness</option>
                            <option value="courage">ü¶Å Courage</option>
                            <option value="sharing">üéÅ Sharing</option>
                            <option value="friendship">ü§ù Friendship</option>
                        </select>
                    </div>
                </div>

                <button class="generate-btn" onclick="generateCartoonStory()" id="generateBtn">
                    <div class="loading-spinner" id="loadingSpinner"></div>
                    <span id="btnText">üé® Cartoonize & Create Story!</span>
                </button>

                <div class="message success-message" id="successMessage"></div>
                <div class="message error-message" id="errorMessage"></div>

                <div class="cartoonization-info">
                    <h4>üéØ AI Photo Cartoonization Process</h4>
                    <ul>
                        <li>Your child's photo becomes a cartoon character</li>
                        <li>Same character appears in all 6 story pages</li>
                        <li>Maintains facial features and characteristics</li>
                        <li>Professional children's book illustration style</li>
                        <li>Different scenes and backgrounds per page</li>
                        <li>DALL-E powered image generation</li>
                    </ul>
                </div>
            </div>

            <div class="preview-section">
                <div class="book-display" id="bookDisplay">
                    <img class="book-image" id="bookImage" alt="Story scene">
                    <div class="book-content">
                        <div class="book-title" id="bookTitle">Story Title</div>
                        <div class="book-text" id="bookText">Story content...</div>
                        <div class="moral-lesson" id="moralLesson" style="display: none;">
                            <h5>üìñ Life Lesson</h5>
                            <p>Moral lesson will appear here</p>
                        </div>
                    </div>
                    <div class="book-navigation">
                        <button class="nav-btn" onclick="previousPage()" id="prevBtn">‚Üê Previous</button>
                        <span class="page-indicator" id="pageIndicator">Page 1 of 6</span>
                        <button class="nav-btn" onclick="nextPage()" id="nextBtn">Next ‚Üí</button>
                    </div>
                </div>

                <div class="default-preview" id="defaultPreview">
                    <div class="preview-placeholder">üì∏</div>
                    <h3>Photo Cartoonization Preview</h3>
                    <p style="font-size: 1.2em; line-height: 1.6; margin-bottom: 20px;">Upload your child's photo to see them as the cartoon hero of their own story!</p>
                    <p style="font-size: 1em; opacity: 0.8;">AI will transform the photo into beautiful cartoon illustrations across 6 story pages.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStoryData = {};
        let currentPage = 0;
        let uploadedPhotoData = null;

        // Photo upload handler
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedPhotoData = e.target.result;
                    
                    // Show preview
                    const preview = document.getElementById('photoPreview');
                    const img = document.getElementById('uploadedPhoto');
                    img.src = uploadedPhotoData;
                    preview.style.display = 'block';
                    
                    showSuccess('Photo uploaded! Ready for AI cartoonization.');
                };
                reader.readAsDataURL(file);
            }
        }

        // DALL-E Image Generation with Photo Input
        async function generateCartoonImage(prompt, photoData = null) {
            try {
                let requestBody;
                
                if (photoData) {
                    // Photo cartoonization mode
                    requestBody = {
                        prompt: `Convert this child's photo into a cartoon character. ${prompt}. Maintain the child's facial features, expressions, and characteristics. Professional children's book illustration style, vibrant colors, cartoon/anime art style.`,
                        image: photoData,
                        size: '1024x1024',
                        quality: 'hd'
                    };
                } else {
                    // Text-only generation
                    requestBody = {
                        prompt: prompt,
                        size: '1024x1024',
                        quality: 'hd'
                    };
                }

                // Simulate API call (replace with actual DALL-E endpoint)
                const response = await fetch('/_api/generate-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.url || data.data?.[0]?.url || null;
                }
                
                throw new Error('API call failed');
                
            } catch (error) {
                console.error('DALL-E generation failed:', error);
                return null;
            }
        }

        // Story templates
        const storyTemplates = {
            kindness: {
                title: "{name}'s Garden of Kindness",
                pages: [
                    "Meet {name}, a wonderful child who loves helping others. Today will be a special day for kindness!",
                    "{name} found someone who needed help in the garden. The flowers looked sad and needed care.",
                    "With a big heart, {name} decided to help water the flowers and make them beautiful again.",
                    "{name} worked together with friends to plant new seeds and share the joy of gardening.",
                    "Like magic, the garden bloomed with colorful flowers, just like {name}'s kind heart!",
                    "{name} learned that kindness grows like flowers - when you plant it, it makes the world more beautiful."
                ]
            },
            courage: {
                title: "{name} Finds Courage",
                pages: [
                    "This is {name}, a brave child who is learning about courage. Sometimes being brave feels scary!",
                    "{name} saw someone who needed help but felt nervous about stepping forward.",
                    "Taking a deep breath, {name} found the courage to help, even though it felt scary.",
                    "{name} discovered that being brave means doing the right thing when you're afraid.",
                    "Other children saw {name}'s courage and joined in to help too. Courage is contagious!",
                    "{name} learned that courage isn't about not being scared - it's about being helpful even when you are scared."
                ]
            },
            sharing: {
                title: "{name} Learns to Share",
                pages: [
                    "Meet {name}, who has a special toy that brings lots of joy and happiness.",
                    "{name} noticed a friend who looked sad because they didn't have anything fun to play with.",
                    "Even though it was hard, {name} decided to share the special toy with the sad friend.",
                    "{name} discovered that sharing made both friends happy and brought them closer together.",
                    "Soon more friends joined in, and everyone was sharing and playing together happily.",
                    "{name} learned that sharing doesn't make you have less - it makes you have more friends and more fun!"
                ]
            },
            friendship: {
                title: "{name}'s Friendship Adventure",
                pages: [
                    "This is {name}, who loves making friends and playing with others every day.",
                    "{name} met someone new who seemed shy and was playing all alone.",
                    "With a friendly smile, {name} walked over and asked if they wanted to play together.",
                    "{name} and the new friend discovered they both loved the same games and had fun together.",
                    "Soon they were best friends, laughing and playing and having wonderful adventures.",
                    "{name} learned that friendship starts with being kind and welcoming to others."
                ]
            }
        };

        // Main generation function
        async function generateCartoonStory() {
            const name = document.getElementById('childName').value.trim() || 'Dom';
            const age = document.getElementById('childAge').value;
            const gender = document.getElementById('childGender').value;
            const theme = document.getElementById('storyTheme').value;

            const btn = document.getElementById('generateBtn');
            const spinner = document.getElementById('loadingSpinner');
            const btnText = document.getElementById('btnText');
            
            btn.disabled = true;
            spinner.style.display = 'block';
            hideMessages();

            try {
                const template = storyTemplates[theme];
                const personalizedPages = template.pages.map(page => 
                    page.replace(/{name}/g, name)
                        .replace(/{he_she}/g, gender === 'girl' ? 'she' : 'he')
                        .replace(/{his_her}/g, gender === 'girl' ? 'her' : 'his')
                );
                
                if (uploadedPhotoData) {
                    btnText.textContent = 'Cartoonizing Photo...';
                    showSuccess(`Creating cartoon story for ${name} using uploaded photo...`);
                } else {
                    btnText.textContent = 'Creating Story...';
                    showSuccess(`Creating story for ${name} using AI generation...`);
                }

                // Generate images for each page
                const sceneDescriptions = [
                    `A ${age}-year-old ${gender} named ${name} in a happy introduction scene with bright colors and welcoming atmosphere, children's book illustration style`,
                    `A ${age}-year-old ${gender} named ${name} discovering a problem or challenge, showing concern and empathy, children's book illustration style`,
                    `A ${age}-year-old ${gender} named ${name} taking positive action, showing determination and helpfulness, children's book illustration style`, 
                    `A ${age}-year-old ${gender} named ${name} working together with others, showing cooperation and teamwork, children's book illustration style`,
                    `A ${age}-year-old ${gender} named ${name} celebrating success and positive transformation with joy, children's book illustration style`,
                    `A ${age}-year-old ${gender} named ${name} learning important life lesson, showing wisdom and growth, children's book illustration style`
                ];

                const pageImages = [];
                
                for (let i = 0; i < personalizedPages.length; i++) {
                    btnText.textContent = `Creating Page ${i + 1}/6...`;
                    showSuccess(`Working on page ${i + 1}...`);
                    
                    let imageUrl = null;
                    
                    try {
                        if (uploadedPhotoData) {
                            // Try photo cartoonization
                            imageUrl = await generateCartoonImage(sceneDescriptions[i], uploadedPhotoData);
                        } else {
                            // Try text-based generation
                            imageUrl = await generateCartoonImage(sceneDescriptions[i]);
                        }
                    } catch (error) {
                        console.log('AI generation failed, using fallback');
                    }
                    
                    if (imageUrl) {
                        pageImages.push(imageUrl);
                        showSuccess(`‚úÖ Page ${i + 1} generated successfully!`);
                    } else {
                        // Use enhanced fallback
                        pageImages.push(createFallbackImage(name, i));
                        showSuccess(`üìù Page ${i + 1} created with custom illustration`);
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 800));
                }

                // Store story data
                currentStoryData = {
                    title: template.title.replace('{name}', name),
                    pages: personalizedPages.map((text, index) => ({
                        text: text,
                        imageUrl: pageImages[index]
                    }))
                };

                currentPage = 0;
                displayStory();
                
                btnText.textContent = '‚úÖ Story Complete!';
                showSuccess(`üéâ ${name}'s story is ready! Navigate through all pages.`);

            } catch (error) {
                console.error('Generation error:', error);
                showError(`Failed to create story: ${error.message}`);
                btnText.textContent = 'üé® Cartoonize & Create Story!';
            } finally {
                setTimeout(() => {
                    btn.disabled = false;
                    spinner.style.display = 'none';
                    btnText.textContent = 'üé® Cartoonize & Create Story!';
                }, 2000);
            }
        }

        // Enhanced fallback image creation with detailed character
        function createFallbackImage(name, pageIndex) {
            const canvas = document.createElement('canvas');
            canvas.width = 1024;
            canvas.height = 1024;
            const ctx = canvas.getContext('2d');

            // Background colors for different pages
            const backgrounds = [
                ['#FFE4B5', '#FFB6C1'], // Page 1 - warm introduction
                ['#B0C4DE', '#D8BFD8'], // Page 2 - problem discovery
                ['#FFD700', '#FFA500'], // Page 3 - taking action
                ['#98FB98', '#90EE90'], // Page 4 - collaboration
                ['#DDA0DD', '#9370DB'], // Page 5 - transformation
                ['#FF69B4', '#FFB6C1']  // Page 6 - lesson learned
            ];

            const colors = backgrounds[pageIndex] || backgrounds[0];
            
            // Create gradient background
            const gradient = ctx.createLinearGradient(0, 0, 1024, 1024);
            gradient.addColorStop(0, colors[0]);
            gradient.addColorStop(1, colors[1]);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 1024, 1024);

            // Get child info
            const gender = document.getElementById('childGender').value;
            const age = document.getElementById('childAge').value;

            // Character position
            const centerX = 512;
            const centerY = 400;
            const scale = 3;

            // Draw cartoon character
            // Head (skin tone)
            ctx.fillStyle = '#F4C2A1';
            ctx.beginPath();
            ctx.arc(centerX, centerY - 80 * scale, 50 * scale, 0, 2 * Math.PI);
            ctx.fill();

            // Hair
            ctx.fillStyle = gender === 'girl' ? '#8B4513' : '#654321';
            ctx.beginPath();
            if (gender === 'girl') {
                // Long hair for girls
                ctx.arc(centerX, centerY - 100 * scale, 60 * scale, 0, Math.PI);
                ctx.fill();
                // Hair sides
                ctx.arc(centerX - 40 * scale, centerY - 60 * scale, 25 * scale, 0, 2 * Math.PI);
                ctx.fill();
                ctx.arc(centerX + 40 * scale, centerY - 60 * scale, 25 * scale, 0, 2 * Math.PI);
                ctx.fill();
            } else {
                // Short hair for boys
                ctx.arc(centerX, centerY - 95 * scale, 55 * scale, 0, Math.PI);
                ctx.fill();
            }

            // Eyes
            ctx.fillStyle = '#FFFFFF';
            ctx.beginPath();
            ctx.arc(centerX - 15 * scale, centerY - 90 * scale, 8 * scale, 0, 2 * Math.PI);
            ctx.fill();
            ctx.arc(centerX + 15 * scale, centerY - 90 * scale, 8 * scale, 0, 2 * Math.PI);
            ctx.fill();

            // Eye pupils
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(centerX - 15 * scale, centerY - 90 * scale, 4 * scale, 0, 2 * Math.PI);
            ctx.fill();
            ctx.arc(centerX + 15 * scale, centerY - 90 * scale, 4 * scale, 0, 2 * Math.PI);
            ctx.fill();

            // Smile
            ctx.strokeStyle = '#D2691E';
            ctx.lineWidth = 3 * scale;
            ctx.beginPath();
            ctx.arc(centerX, centerY - 70 * scale, 12 * scale, 0, Math.PI);
            ctx.stroke();

            // Body (shirt)
            const shirtColors = ['#FF69B4', '#4169E1', '#32CD32', '#FFD700', '#FF6347'];
            ctx.fillStyle = shirtColors[pageIndex % shirtColors.length];
            ctx.beginPath();
            ctx.arc(centerX, centerY + 10 * scale, 60 * scale, 0, Math.PI);
            ctx.fill();

            // Arms
            ctx.fillStyle = '#F4C2A1';
            ctx.beginPath();
            ctx.arc(centerX - 45 * scale, centerY - 20 * scale, 15 * scale, 0, 2 * Math.PI);
            ctx.fill();
            ctx.arc(centerX + 45 * scale, centerY - 20 * scale, 15 * scale, 0, 2 * Math.PI);
            ctx.fill();

            // Add scene elements based on page
            const sceneEmojis = ['üòä', 'üòü', 'üí™', 'ü§ù', '‚ú®', 'üéâ'];
            ctx.font = '80px serif';
            ctx.fillText(sceneEmojis[pageIndex], centerX + 150, centerY - 100);
            ctx.fillText(sceneEmojis[pageIndex], centerX - 200, centerY + 50);

            // Add child's name
            ctx.fillStyle = '#FFFFFF';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 6;
            ctx.font = 'bold 48px Georgia';
            ctx.textAlign = 'center';
            ctx.strokeText(name, centerX, centerY + 200);
            ctx.fillText(name, centerX, centerY + 200);
            
            // Add page info
            ctx.font = 'bold 32px Georgia';
            ctx.strokeText(`Page ${pageIndex + 1}`, centerX, centerY + 250);
            ctx.fillText(`Page ${pageIndex + 1}`, centerX, centerY + 250);

            return canvas.toDataURL('image/png');
        }

        // Display story
        function displayStory() {
            document.getElementById('defaultPreview').style.display = 'none';
            document.getElementById('bookDisplay').style.display = 'block';
            updatePage();
        }

        // Update current page
        function updatePage() {
            const image = document.getElementById('bookImage');
            const title = document.getElementById('bookTitle');
            const text = document.getElementById('bookText');
            const moral = document.getElementById('moralLesson');
            const indicator = document.getElementById('pageIndicator');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            const currentPageData = currentStoryData.pages[currentPage];
            
            image.src = currentPageData.imageUrl;
            title.textContent = currentStoryData.title;
            text.textContent = currentPageData.text;
            
            // Show moral lesson on last page
            if (currentPage === currentStoryData.pages.length - 1) {
                moral.style.display = 'block';
                moral.innerHTML = '<h5>üìñ Life Lesson</h5><p>Every act of kindness, courage, sharing, and friendship makes the world a better place!</p>';
            } else {
                moral.style.display = 'none';
            }
            
            indicator.textContent = `Page ${currentPage + 1} of ${currentStoryData.pages.length}`;
            
            prevBtn.disabled = currentPage === 0;
            nextBtn.disabled = currentPage === currentStoryData.pages.length - 1;
        }

        // Navigation functions
        function previousPage() {
            if (currentPage > 0) {
                currentPage--;
                updatePage();
            }
        }

        function nextPage() {
            if (currentPage < currentStoryData.pages.length - 1) {
                currentPage++;
                updatePage();
            }
        }

        // Message functions
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        function showSuccess(message) {
            const successEl = document.getElementById('successMessage');
            successEl.textContent = message;
            successEl.style.display = 'block';
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        console.log("Photo Cartoonization System Ready!");
    </script>
</body>
</html>
