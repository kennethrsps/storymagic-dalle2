<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryMagic Pro - Visual Story Books</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
            color: white;
            text-align: center;
            padding: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 600px;
        }

        .form-section {
            padding: 40px;
            background: #f8f9fa;
        }

        .preview-section {
            padding: 40px;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        .generate-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .generate-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .loading-spinner {
            display: none;
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translateY(-50%) rotate(0deg); }
            100% { transform: translateY(-50%) rotate(360deg); }
        }

        .story-book {
            display: none;
            width: 100%;
            height: 500px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .story-page {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .story-overlay {
            background: rgba(0,0,0,0.4);
            color: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 80%;
            text-align: center;
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255,255,255,0.3);
        }

        .story-title {
            font-size: 2em;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .story-text {
            font-size: 1.1em;
            line-height: 1.6;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .character-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto 20px;
            background: linear-gradient(45deg, #ff9a9e, #fecfef);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4em;
            border: 5px solid white;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 5px solid #f44336;
            display: none;
        }

        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 5px solid #4caf50;
            display: none;
        }

        .download-section {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }

        .download-btn {
            background: white;
            color: #28a745;
            border: none;
            padding: 12px 25px;
            border-radius: 20px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé® StoryMagic Pro</h1>
            <p>Create Visual Story Books with AI Characters</p>
        </div>

        <div class="main-content">
            <div class="form-section">
                <h2 style="color: #333; margin-bottom: 30px; text-align: center;">Create Your Story</h2>
                
                <div class="form-group">
                    <label for="childName">Child's Name</label>
                    <input type="text" id="childName" placeholder="Enter your child's name" value="Dom">
                </div>

                <div class="form-group">
                    <label for="childAge">Age</label>
                    <select id="childAge">
                        <option value="3">3 years old</option>
                        <option value="4" selected>4 years old</option>
                        <option value="5">5 years old</option>
                        <option value="6">6 years old</option>
                        <option value="7">7 years old</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="storyTheme">Choose Your Adventure</label>
                    <select id="storyTheme">
                        <option value="garden">üåª Dom's Magic Garden</option>
                        <option value="space">üöÄ Dom Goes to Space</option>
                        <option value="ocean">üåä Dom's Ocean Adventure</option>
                        <option value="castle">üè∞ Dom the Brave Knight</option>
                        <option value="pirate">üè¥‚Äç‚ò†Ô∏è Captain Dom's Treasure</option>
                    </select>
                </div>

                <button class="generate-btn" onclick="generateStory()" id="generateBtn">
                    <div class="loading-spinner" id="loadingSpinner"></div>
                    <span id="btnText">üé® Create Dom's Story!</span>
                </button>

                <div class="success-message" id="successMessage"></div>
                <div class="error-message" id="errorMessage"></div>
                
                <div class="download-section" id="downloadSection">
                    <h4>üìö Your Story Book is Ready!</h4>
                    <p>Download Dom's personalized story with beautiful visuals</p>
                    <button class="download-btn" onclick="downloadPDF()">üìÑ Download PDF Story Book</button>
                </div>
            </div>

            <div class="preview-section">
                <div class="character-preview" id="characterPreview">
                    üåª
                </div>

                <div class="story-book" id="storyBook">
                    <div class="story-page" id="storyPage">
                        <div class="story-overlay">
                            <div class="story-title" id="storyTitle">Dom's Adventure</div>
                            <div class="story-text" id="storyText">Your story will appear here...</div>
                        </div>
                    </div>
                </div>

                <div id="defaultPreview" style="text-align: center;">
                    <h3 style="color: #333; margin-bottom: 15px;">üé® Story Preview</h3>
                    <p style="color: #666;">Generate Dom's story to see the magic happen!</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        let currentStoryData = {};

        // 5 Simple Stories for Dom
        const stories = {
            garden: {
                title: "Dom's Magic Garden",
                pages: [
                    "Dom found a sad garden with wilting flowers.",
                    "Dom watered the flowers every day with care.",
                    "The flowers started to smile and grow tall!",
                    "Dom made friends with talking butterflies.",
                    "Dom learned that caring makes magic happen!"
                ],
                prompt: "A happy 4-year-old boy named Dom with a big smile in a magical garden with colorful flowers and butterflies, children's book illustration, bright and cheerful"
            },
            space: {
                title: "Dom Goes to Space",
                pages: [
                    "Dom put on a shiny space suit for adventure.",
                    "Dom's rocket zoomed up to the twinkling stars!",
                    "Dom met friendly aliens who said 'Hello!'",
                    "Dom and the aliens played fun space games.",
                    "Dom learned that friends are everywhere!"
                ],
                prompt: "A cheerful 4-year-old boy named Dom in a colorful space suit floating with friendly aliens among stars and planets, children's book illustration, cosmic and fun"
            },
            ocean: {
                title: "Dom's Ocean Adventure",
                pages: [
                    "Dom dove into the beautiful blue ocean.",
                    "Dom found a little fish who was lost and sad.",
                    "Dom helped the fish find her way back home.",
                    "All the sea creatures thanked Dom with hugs!",
                    "Dom learned that helping others feels wonderful!"
                ],
                prompt: "A joyful 4-year-old boy named Dom swimming underwater with colorful fish and sea creatures in a bright coral reef, children's book illustration, underwater adventure"
            },
            castle: {
                title: "Dom the Brave Knight",
                pages: [
                    "Knight Dom put on his shiny armor to help.",
                    "Dom met a lonely dragon who felt very sad.",
                    "Dom offered friendship instead of fighting.",
                    "The dragon smiled and they became best friends!",
                    "Dom learned that kindness is true bravery!"
                ],
                prompt: "A brave 4-year-old boy named Dom in knight armor with a friendly smiling dragon in front of a colorful castle, children's book illustration, medieval and heartwarming"
            },
            pirate: {
                title: "Captain Dom's Treasure",
                pages: [
                    "Captain Dom sailed the seas looking for treasure.",
                    "Dom found a treasure map with a big X!",
                    "Dom discovered hungry pirates on the island.",
                    "Dom shared his treasure food with everyone.",
                    "Dom learned that sharing is the best treasure!"
                ],
                prompt: "A happy 4-year-old boy named Dom as a pirate captain on a colorful ship with treasure chests and friendly pirates, children's book illustration, adventure and friendship"
            }
        };

        async function generateStory() {
            const name = document.getElementById('childName').value || 'Dom';
            const theme = document.getElementById('storyTheme').value;
            
            const btn = document.getElementById('generateBtn');
            const spinner = document.getElementById('loadingSpinner');
            const btnText = document.getElementById('btnText');
            
            btn.disabled = true;
            spinner.style.display = 'block';
            btnText.textContent = 'Creating Dom\'s Story...';

            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';

            try {
                const story = stories[theme];
                const prompt = story.prompt.replace(/Dom/g, name);
                
                const response = await fetch('/api/generate-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt: prompt })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to generate image');
                }

                const data = await response.json();
                const imageUrl = data.data[0].url;

                // Show the story
                const storyPage = document.getElementById('storyPage');
                const storyTitle = document.getElementById('storyTitle');
                const storyText = document.getElementById('storyText');
                
                storyPage.style.backgroundImage = `url(${imageUrl})`;
                storyTitle.textContent = story.title.replace(/Dom/g, name);
                storyText.innerHTML = `<strong>Page 1:</strong> ${story.pages[0].replace(/Dom/g, name)}<br><small style="color: #ffeb3b;">üìñ Complete 5-page story in PDF download!</small>`;

                document.getElementById('defaultPreview').style.display = 'none';
                document.getElementById('storyBook').style.display = 'block';
                document.getElementById('characterPreview').innerHTML = getThemeEmoji(theme);

                // Store for PDF
                currentStoryData = {
                    imageUrl: imageUrl,
                    title: story.title.replace(/Dom/g, name),
                    pages: story.pages.map(page => page.replace(/Dom/g, name)),
                    name: name,
                    theme: theme
                };
                
                document.getElementById('downloadSection').style.display = 'block';
                showSuccess('üéâ Dom\'s story is ready! Download the PDF for the complete 5-page book.');

            } catch (error) {
                console.error('Error:', error);
                showError(`Failed to generate story: ${error.message}`);
            } finally {
                btn.disabled = false;
                spinner.style.display = 'none';
                btnText.textContent = 'üé® Create Dom\'s Story!';
            }
        }

        function getThemeEmoji(theme) {
            const emojis = {
                garden: 'üåª',
                space: 'üöÄ',
                ocean: 'üåä',
                castle: 'üè∞',
                pirate: 'üè¥‚Äç‚ò†Ô∏è'
            };
            return emojis[theme] || '‚ú®';
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        function showSuccess(message) {
            const successEl = document.getElementById('successMessage');
            successEl.textContent = message;
            successEl.style.display = 'block';
        }

        async function downloadPDF() {
            if (!currentStoryData.imageUrl) {
                alert('Please generate a story first!');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // Cover page with image
                pdf.setFontSize(24);
                pdf.setFont(undefined, 'bold');
                pdf.text(currentStoryData.title, 105, 30, { align: 'center' });
                
                // Add the character image
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = function() {
                    // Add main character image to cover
                    pdf.addImage(img, 'JPEG', 55, 50, 100, 100);
                    
                    // Add each story page
                    currentStoryData.pages.forEach((pageText, index) => {
                        pdf.addPage();
                        
                        // Page number
                        pdf.setFontSize(16);
                        pdf.setFont(undefined, 'bold');
                        pdf.text(`Page ${index + 1}`, 105, 30, { align: 'center' });
                        
                        // Add character image on each page (smaller)
                        pdf.addImage(img, 'JPEG', 70, 50, 70, 70);
                        
                        // Story text below image
                        pdf.setFontSize(14);
                        pdf.setFont(undefined, 'normal');
                        const lines = pdf.splitTextToSize(pageText, 160);
                        pdf.text(lines, 25, 140);
                        
                        // Fun decorations
                        pdf.setFontSize(20);
                        pdf.text('‚≠ê', 180, 50);
                        pdf.text('üåü', 25, 50);
                    });
                    
                    // Save the PDF
                    pdf.save(`${currentStoryData.name}_Story_Book.pdf`);
                };
                
                img.onerror = function() {
                    // Create PDF without image if there's an error
                    currentStoryData.pages.forEach((pageText, index) => {
                        if (index > 0) pdf.addPage();
                        
                        pdf.setFontSize(16);
                        pdf.text(`Page ${index + 1}`, 105, 30, { align: 'center' });
                        
                        pdf.setFontSize(14);
                        const lines = pdf.splitTextToSize(pageText, 160);
                        pdf.text(lines, 25, 60);
                    });
                    
                    pdf.save(`${currentStoryData.name}_Story_Book.pdf`);
                };
                
                img.src = currentStoryData.imageUrl;
                
            } catch (error) {
                console.error('PDF error:', error);
                alert('PDF creation failed. Please try again.');
            }
        }

        // Update preview when theme changes
        document.getElementById('storyTheme').addEventListener('change', function() {
            document.getElementById('characterPreview').textContent = getThemeEmoji(this.value);
        });
    </script>
</body>
</html>
