<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryMagic Pro - Garden of Kindness</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 25px;
            box-shadow: 0 25px 70px rgba(0,0,0,0.4);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #ff6b6b, #ffa726, #4ecdc4);
            color: white;
            text-align: center;
            padding: 25px;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 800;
        }

        .header p {
            font-size: 1.3em;
            opacity: 0.95;
            font-weight: 500;
        }

        .main-content {
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 0;
            min-height: 900px;
        }

        .form-section {
            padding: 30px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-right: 3px solid #dee2e6;
        }

        .preview-section {
            padding: 20px;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.9em;
            font-family: inherit;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.2);
        }

        .photo-upload-section {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            border-left: 5px solid #4caf50;
            text-align: center;
        }

        .photo-upload-section h4 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-weight: 700;
            font-size: 1.1em;
        }

        .upload-area {
            border: 3px dashed #4caf50;
            border-radius: 12px;
            padding: 30px 20px;
            background: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .upload-area:hover {
            border-color: #2e7d32;
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #1b5e20;
            background: rgba(76, 175, 80, 0.1);
        }

        .upload-icon {
            font-size: 3em;
            color: #4caf50;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #2e7d32;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .upload-subtext {
            color: #388e3c;
            font-size: 0.85em;
        }

        .photo-preview {
            display: none;
            max-width: 120px;
            max-height: 120px;
            border-radius: 12px;
            margin: 15px auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .character-analysis {
            display: none;
            background: #fff3e0;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #ff9800;
        }

        .character-analysis h5 {
            color: #f57c00;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .character-analysis p {
            color: #ef6c00;
            font-size: 0.8em;
            margin: 5px 0;
        }

        .detail-section {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 5px solid #2196f3;
        }

        .detail-section h4 {
            color: #1976d2;
            margin-bottom: 10px;
            font-size: 1em;
            font-weight: 700;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .generate-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 18px 25px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            position: relative;
            overflow: hidden;
            margin-top: 15px;
            box-shadow: 0 8px 20px rgba(78, 205, 196, 0.3);
            transform: scale(1);
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 25px rgba(78, 205, 196, 0.4);
        }

        .generate-btn:disabled {
            opacity: 0.9;
            cursor: not-allowed;
            transform: scale(0.98);
        }

        .loading-spinner {
            display: none;
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translateY(-50%) rotate(0deg); }
            100% { transform: translateY(-50%) rotate(360deg); }
        }

        .book-display {
            display: none;
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            border: 3px solid #f0f0f0;
        }

        .book-image {
            width: 100%;
            height: 600px;
            object-fit: cover;
            background: #f8f9fa;
            border-bottom: 2px solid #eee;
        }

        .book-content {
            padding: 25px 35px 20px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }

        .book-title {
            font-size: 1.6em;
            color: #2c3e50;
            margin-bottom: 12px;
            font-weight: 700;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .book-text {
            font-size: 1.1em;
            line-height: 1.6;
            color: #495057;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 500;
            font-family: 'Georgia', serif;
        }

        .moral-lesson {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 5px solid #ffb74d;
            text-align: center;
        }

        .moral-lesson h5 {
            color: #e65100;
            margin-bottom: 5px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .moral-lesson p {
            color: #bf360c;
            font-size: 0.85em;
            font-style: italic;
            margin: 0;
        }

        .book-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 35px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 0 0 20px 20px;
        }

        .nav-btn {
            background: rgba(255,255,255,0.15);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .nav-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .page-indicator {
            font-weight: 700;
            color: white;
            font-size: 1.1em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .download-section {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: center;
            display: none;
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3);
        }

        .download-section h4 {
            font-size: 1.3em;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .download-section p {
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .download-btn {
            background: white;
            color: #28a745;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            margin: 8px;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .download-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .message {
            padding: 12px 15px;
            border-radius: 10px;
            margin-top: 12px;
            display: none;
            font-weight: 500;
            font-size: 0.9em;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }

        .default-preview {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }

        .default-preview h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2em;
            font-weight: 700;
        }

        .preview-placeholder {
            width: 280px;
            height: 280px;
            border-radius: 20px;
            background: linear-gradient(45deg, #ff9a9e, #fecfef, #ffecd2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 6em;
            margin: 30px auto;
            border: 5px solid white;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: float 4s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(2deg); }
        }

        #fileInput {
            display: none;
        }

        .remove-photo-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .remove-photo-btn:hover {
            background: #d32f2f;
            transform: translateY(-1px);
        }

        .system-info {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #2196f3;
        }

        .system-info h5 {
            color: #1976d2;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .system-info ul {
            list-style: none;
            padding: 0;
        }

        .system-info li {
            color: #1565c0;
            margin-bottom: 3px;
            font-size: 0.8em;
            padding-left: 15px;
            position: relative;
        }

        .system-info li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #4caf50;
            font-weight: bold;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 10px;
            }
            
            .book-image {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🌻 The Garden of Kindness</h1>
            <p>Your Child's Personalized Kindness Adventure</p>
        </div>

        <div class="main-content">
            <div class="form-section">
                <h2 style="color: #333; margin-bottom: 20px; text-align: center; font-weight: 700;">Create Your Story</h2>
                
                <div class="photo-upload-section">
                    <h4>📸 Upload Your Child's Photo</h4>
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                        <div class="upload-icon">📷</div>
                        <div class="upload-text">Click or drag photo here</div>
                        <div class="upload-subtext">JPG, PNG, or HEIC • Max 10MB</div>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" onchange="handleFileUpload(event)">
                    <img id="photoPreview" class="photo-preview" alt="Child's photo">
                    <button class="remove-photo-btn" id="removePhotoBtn" onclick="removePhoto()" style="display: none;">Remove Photo</button>
                    
                    <div class="character-analysis" id="characterAnalysis">
                        <h5>🎨 Character Analysis</h5>
                        <p id="analysisText">Ready to analyze photo...</p>
                    </div>
                </div>

                <div class="detail-section">
                    <h4>👶 Child Information</h4>
                    
                    <div class="form-group">
                        <label for="childName">Child's Name</label>
                        <input type="text" id="childName" placeholder="Enter child's name" value="Alex">
                    </div>

                    <div class="row">
                        <div class="form-group">
                            <label for="childAge">Age</label>
                            <select id="childAge">
                                <option value="3">3 years old</option>
                                <option value="4" selected>4 years old</option>
                                <option value="5">5 years old</option>
                                <option value="6">6 years old</option>
                                <option value="7">7 years old</option>
                                <option value="8">8 years old</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="childGender">Gender</label>
                            <select id="childGender">
                                <option value="girl">Girl</option>
                                <option value="boy" selected>Boy</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h4>🎯 Story Settings</h4>
                    
                    <div class="form-group">
                        <label for="childPersonality">Child's Personality</label>
                        <select id="childPersonality">
                            <option value="cheerful and outgoing" selected>Cheerful & Outgoing</option>
                            <option value="shy and thoughtful">Shy & Thoughtful</option>
                            <option value="brave and adventurous">Brave & Adventurous</option>
                            <option value="creative and artistic">Creative & Artistic</option>
                            <option value="kind and gentle">Kind & Gentle</option>
                            <option value="curious and smart">Curious & Smart</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="favoriteThings">Favorite Activities</label>
                        <textarea id="favoriteThings" placeholder="e.g., loves flowers, gardening, helping others..."></textarea>
                    </div>
                </div>

                <button class="generate-btn" onclick="generateKindnessStory()" id="generateBtn">
                    <div class="loading-spinner" id="loadingSpinner"></div>
                    <span id="btnText">🌻 Create Kindness Story!</span>
                </button>

                <div class="message success-message" id="successMessage"></div>
                <div class="message error-message" id="errorMessage"></div>
                
                <div class="download-section" id="downloadSection">
                    <h4>📚 Story Complete!</h4>
                    <p>Your child's personalized kindness adventure is ready!</p>
                    <button class="download-btn" onclick="downloadStoryPDF()">📄 Download Story Book</button>
                </div>

                <div class="system-info">
                    <h5>🚀 New System Features</h5>
                    <ul>
                        <li>Fixed background scenes for consistency</li>
                        <li>Character overlay technology</li>
                        <li>Perfect positioning system</li>
                        <li>Fast generation (1 character only)</li>
                        <li>Professional quality results</li>
                    </ul>
                </div>
            </div>

            <div class="preview-section">
                <div class="book-display" id="bookDisplay">
                    <img class="book-image" id="bookImage" alt="Story scene">
                    <div class="book-content">
                        <div class="book-title" id="bookTitle">Story Title</div>
                        <div class="book-text" id="bookText">Story content...</div>
                        <div class="moral-lesson" id="moralLesson">
                            <h5>🌻 Kindness Lesson</h5>
                            <p>Life lesson will appear here</p>
                        </div>
                    </div>
                    <div class="book-navigation">
                        <button class="nav-btn" onclick="previousPage()" id="prevBtn">← Previous</button>
                        <span class="page-indicator" id="pageIndicator">Page 1 of 6</span>
                        <button class="nav-btn" onclick="nextPage()" id="nextBtn">Next →</button>
                    </div>
                </div>

                <div class="default-preview" id="defaultPreview">
                    <div class="preview-placeholder">🌻</div>
                    <h3>Garden of Kindness</h3>
                    <p style="font-size: 1.2em; line-height: 1.6; margin-bottom: 20px;">Upload your child's photo to create their personalized kindness adventure!</p>
                    <p style="font-size: 1em; opacity: 0.8;">New system: Fixed backgrounds + character overlay = perfect consistency!</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Generated Kindness Story Backgrounds
        const KINDNESS_BACKGROUNDS = {
            scene1: "https://oaidalleapiprodscus.blob.core.windows.net/private/org-6Z7jFAHtMXYj7phnwoCcOdE4/user-nq1uZhTF4tfAA2x76R18P3sU/img-qJuJK4ozCBv5fGkKCIxMX4JI.png?st=2025-06-19T13%3A45%3A54Z&se=2025-06-19T15%3A45%3A54Z&sp=r&sv=2024-08-04&sr=b&rscd=inline&rsct=image/png&skoid=475fd488-6c59-44a5-9aa9-31c4db451bea&sktid=a48cca56-e6da-484e-a814-9c849652bcb3&skt=2025-06-19T11%3A47%3A42Z&ske=2025-06-20T11%3A47%3A42Z&sks=b&skv=2024-08-04&sig=/RWpIePWqvqu2AfGpkhw5Hva0Vhb2%2Bbus957%2BTTOdkY%3D",
            scene2: "https://oaidalleapiprodscus.blob.core.windows.net/private/org-6Z7jFAHtMXYj7phnwoCcOdE4/user-nq1uZhTF4tfAA2x76R18P3sU/img-PkBLInA5ntbhCbvejya9T4NK.png?st=2025-06-19T13%3A46%3A11Z&se=2025-06-19T15%3A46%3A11Z&sp=r&sv=2024-08-04&sr=b&rscd=inline&rsct=image/png&skoid=475fd488-6c59-44a5-9aa9-31c4db451bea&sktid=a48cca56-e6da-484e-a814-9c849652bcb3&skt=2025-06-19T06%3A08%3A26Z&ske=2025-06-20T06%3A08%3A26Z&sks=b&skv=2024-08-04&sig=5yny/yV2EM/mvmOwZLeBMIgT55n/aDP48AwPlzdvS34%3D",
            scene3: "https://oaidalleapiprodscus.blob.core.windows.net/private/org-6Z7jFAHtMXYj7phnwoCcOdE4/user-nq1uZhTF4tfAA2x76R18P3sU/img-Zubx0KLfPsAcsBtKbDbwMD8y.png?st=2025-06-19T13%3A47%3A38Z&se=2025-06-19T15%3A47%3A38Z&sp=r&sv=2024-08-04&sr=b&rscd=inline&rsct=image/png&skoid=475fd488-6c59-44a5-9aa9-31c4db451bea&sktid=a48cca56-e6da-484e-a814-9c849652bcb3&skt=2025-06-19T12%3A42%3A18Z&ske=2025-06-20T12%3A42%3A18Z&sks=b&skv=2024-08-04&sig=ohw2tME6a6uYhbVRDrFLpcAsn9X8xU9DJCkOujruZOo%3D",
            scene4: "https://oaidalleapiprodscus.blob.core.windows.net/private/org-6Z7jFAHtMXYj7phnwoCcOdE4/user-nq1uZhTF4tfAA2x76R18P3sU/img-mQINcDbCtGv8IrZmGfmqzIrN.png?st=2025-06-19T13%3A47%3A25Z&se=2025-06-19T15%3A47%3A25Z&sp=r&sv=2024-08-04&sr=b&rscd=inline&rsct=image/png&skoid=475fd488-6c59-44a5-9aa9-31c4db451bea&sktid=a48cca56-e6da-484e-a814-9c849652bcb3&skt=2025-06-18T15%3A41%3A08Z&ske=2025-06-19T15%3A41%3A08Z&sks=b&skv=2024-08-04&sig=pkYg/tAO2wPJjrRjvCr6ItwqcB5HeOoUAIxPscdMrrI%3D",
            scene5: "https://oaidalleapiprodscus.blob.core.windows.net/private/org-6Z7jFAHtMXYj7phnwoCcOdE4/user-nq1uZhTF4tfAA2x76R18P3sU/img-4FDYfh4f6Bsai9PBGP7HVnua.png?st=2025-06-19T13%3A58%3A51Z&se=2025-06-19T15%3A58%3A51Z&sp=r&sv=2024-08-04&sr=b&rscd=inline&rsct=image/png&skoid=475fd488-6c59-44a5-9aa9-31c4db451bea&sktid=a48cca56-e6da-484e-a814-9c849652bcb3&skt=2025-06-19T10%3A24%3A17Z&ske=2025-06-20T10%3A24%3A17Z&sks=b&skv=2024-08-04&sig=WjzqSbV/A9OwIsU0VYF4LEhXKyvGuDS4I2aH8Iff4as%3D",
            scene6: "https://oaidalleapiprodscus.blob.core.windows.net/private/org-6Z7jFAHtMXYj7phnwoCcOdE4/user-nq1uZhTF4tfAA2x76R18P3sU/img-6QbiG4tZ2x8E4GMcKoi7isjt.png?st=2025-06-19T13%3A52%3A49Z&se=2025-06-19T15%3A52%3A49Z&sp=r&sv=2024-08-04&sr=b&rscd=inline&rsct=image/png&skoid=475fd488-6c59-44a5-9aa9-31c4db451bea&sktid=a48cca56-e6da-484e-a814-9c849652bcb3&skt=2025-06-19T11%3A42%3A19Z&ske=2025-06-20T11%3A42%3A19Z&sks=b&skv=2024-08-04&sig=G6Dcc7w%2BtjVDvI9LgTI5Id1R5iGUjUZ5x4zF9Idv/Y4%3D"
        };

        // Background descriptions for character positioning
        const BACKGROUND_INFO = {
            scene1: { name: "Cozy Neighborhood", characterPosition: "center-bottom", characterScale: 0.25 },
            scene2: { name: "Forgotten Garden", characterPosition: "center-bottom", characterScale: 0.22 },
            scene3: { name: "Meeting Gardener", characterPosition: "left-bottom", characterScale: 0.20 },
            scene4: { name: "Working Together", characterPosition: "center-bottom", characterScale: 0.23 },
            scene5: { name: "Garden Blooms", characterPosition: "center-bottom", characterScale: 0.21 },
            scene6: { name: "Community Garden", characterPosition: "center-bottom", characterScale: 0.24 }
        };

        // KINDNESS STORY CONTENT
        const kindnessStory = {
            title: "{name}'s Garden of Kindness",
            fullMoral: "This story teaches that even the smallest acts of kindness can transform not just others, but ourselves too. When we choose kindness, we plant seeds that grow into beautiful friendships and positive change in our community.",
            scenes: [
                {
                    title: "Meet {name}",
                    text: "Meet {name}, a {personality} {age}-year-old who loves {favorite_things}. One sunny morning, {name} was playing outside when something caught {his_her} attention down the street."
                },
                {
                    title: "The Forgotten Garden",
                    text: "Walking along, {name} discovered an old, forgotten garden. Among the wilting flowers sat a sad elderly gardener who looked very lonely and discouraged about his struggling plants."
                },
                {
                    title: "A Kind Offer",
                    text: "Even though {name} felt a little {personality}, {his_her} heart filled with compassion. '{name} would like to help make your garden beautiful again,' {he_she} said with a gentle, caring smile."
                },
                {
                    title: "Working Together", 
                    text: "Side by side, {name} and the gardener planted new seeds, watered the flowers, and pulled weeds. They shared stories and laughter as they worked together to bring the garden back to life."
                },
                {
                    title: "The Garden Blooms",
                    text: "As if by magic, the garden began to bloom in brilliant colors! Other children saw the beautiful transformation and came to help, creating a wonderful community garden full of friendship."
                },
                {
                    title: "Seeds of Kindness",
                    text: "{name} learned that kindness is like planting seeds - it grows and spreads, creating beauty everywhere. The garden became a symbol of what happens when we care for others with open hearts."
                }
            ]
        };

        let currentStoryData = {};
        let currentPage = 0;
        let uploadedPhoto = null;
        let characterDescription = '';
        let generatedCharacter = null;

        console.log("✅ Kindness story backgrounds loaded successfully!");

        // FILE UPLOAD HANDLING
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 10 * 1024 * 1024) {
                showError('Photo must be smaller than 10MB');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedPhoto = e.target.result;
                document.getElementById('photoPreview').src = uploadedPhoto;
                document.getElementById('photoPreview').style.display = 'block';
                document.getElementById('removePhotoBtn').style.display = 'block';
                
                // Show analysis section
                document.getElementById('characterAnalysis').style.display = 'block';
                analyzePhoto(uploadedPhoto);
            };
            reader.readAsDataURL(file);
        }

        function removePhoto() {
            uploadedPhoto = null;
            characterDescription = '';
            generatedCharacter = null;
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('removePhotoBtn').style.display = 'none';
            document.getElementById('characterAnalysis').style.display = 'none';
            document.getElementById('fileInput').value = '';
        }

        // DRAG AND DROP
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('fileInput').files = files;
                handleFileUpload({ target: { files: files } });
            }
        });

        // PHOTO ANALYSIS WITH GPT-4 VISION
        async function analyzePhoto(photoData) {
            document.getElementById('analysisText').textContent = 'Analyzing photo features...';
            
            try {
                const response = await fetch('/api/analyze-photo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        image: photoData,
                        age: document.getElementById('childAge').value,
                        gender: document.getElementById('childGender').value
                    })
                });

                if (response.ok) {
                    const analysis = await response.json();
                    characterDescription = analysis.character_description;
                    
                    document.getElementById('analysisText').innerHTML = `
                        <strong>Character Features Detected:</strong><br>
                        ${analysis.description || 'Character ready for generation!'}
                    `;
                } else {
                    throw new Error('Analysis failed');
                }
            } catch (error) {
                console.log('Photo analysis failed, using manual input:', error);
                document.getElementById('analysisText').textContent = 'Using manual character details for story creation.';
                characterDescription = createManualCharacterDescription();
            }
        }

        function createManualCharacterDescription() {
            const name = document.getElementById('childName').value.trim() || 'Alex';
            const age = document.getElementById('childAge').value;
            const gender = document.getElementById('childGender').value;
            const personality = document.getElementById('childPersonality').value;
            
            return `A ${age}-year-old ${gender} named ${name} who is ${personality}. The child has a friendly, warm expression and is dressed in casual, colorful clothing appropriate for a children's book illustration. Full body view showing the child standing naturally.`;
        }

        // CHARACTER GENERATION AND OVERLAY
        async function generateCharacter() {
            if (!characterDescription) {
                characterDescription = createManualCharacterDescription();
            }

            const characterPrompt = `Children's book illustration of ${characterDescription}. Full body character illustration, standing pose, transparent background preferable, high quality children's book art style, friendly and approachable appearance.`;

            try {
                const response = await fetch('/api/generate-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        prompt: characterPrompt,
                        size: "1024x1024",
                        quality: "hd",
                        style: "vivid"
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const imageUrl = data.url || data.data?.[0]?.url || data.image_url;
                    if (imageUrl) {
                        generatedCharacter = imageUrl;
                        return imageUrl;
                    }
                }
                throw new Error('Character generation failed');
            } catch (error) {
                console.error('Character generation error:', error);
                return createFallbackCharacter();
            }
        }

        function createFallbackCharacter() {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');

            // Simple character representation
            const name = document.getElementById('childName').value.trim() || 'Alex';
            const gender = document.getElementById('childGender').value;
            
            // Clear background
            ctx.clearRect(0, 0, 512, 512);
            
            // Character circle
            ctx.fillStyle = gender === 'girl' ? '#FFB6C1' : '#87CEEB';
            ctx.beginPath();
            ctx.arc(256, 200, 80, 0, 2 * Math.PI);
            ctx.fill();
            
            // Face
            ctx.fillStyle = '#F4C2A1';
            ctx.beginPath();
            ctx.arc(256, 180, 50, 0, 2 * Math.PI);
            ctx.fill();
            
            // Eyes
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(240, 170, 5, 0, 2 * Math.PI);
            ctx.arc(272, 170, 5, 0, 2 * Math.PI);
            ctx.fill();
            
            // Smile
            ctx.strokeStyle = '#D2691E';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(256, 180, 20, 0, Math.PI);
            ctx.stroke();
            
            // Body
            ctx.fillStyle = gender === 'girl' ? '#FF69B4' : '#4169E1';
            ctx.fillRect(216, 280, 80, 120);
            
            // Name
            ctx.fillStyle = '#333333';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(name, 256, 450);

            return canvas.toDataURL('image/png');
        }

        // CANVAS COMPOSITING SYSTEM
        function createCompositeScene(backgroundKey, characterImage) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                canvas.width = 1024;
                canvas.height = 1024;
                const ctx = canvas.getContext('2d');

                const background = new Image();
                background.crossOrigin = 'anonymous';
                
                background.onload = function() {
                    // Draw background
                    ctx.drawImage(background, 0, 0, 1024, 1024);
                    
                    const character = new Image();
                    character.crossOrigin = 'anonymous';
                    
                    character.onload = function() {
                        // Calculate character position and size
                        const info = BACKGROUND_INFO[backgroundKey];
                        const scale = info.characterScale || 0.22;
                        const charWidth = character.width * scale;
                        const charHeight = character.height * scale;
                        
                        let x, y;
                        
                        // Position based on background requirements
                        switch(info.characterPosition) {
                            case 'center-bottom':
                                x = (1024 - charWidth) / 2;
                                y = 1024 - charHeight - 50;
                                break;
                            case 'left-bottom':
                                x = 100;
                                y = 1024 - charHeight - 50;
                                break;
                            case 'right-bottom':
                                x = 1024 - charWidth - 100;
                                y = 1024 - charHeight - 50;
                                break;
                            default:
                                x = (1024 - charWidth) / 2;
                                y = 1024 - charHeight - 50;
                        }
                        
                        // Draw character
                        ctx.drawImage(character, x, y, charWidth, charHeight);
                        
                        resolve(canvas.toDataURL('image/png'));
                    };
                    
                    character.onerror = function() {
                        // If character fails to load, just return background
                        resolve(canvas.toDataURL('image/png'));
                    };
                    
                    character.src = characterImage;
                };
                
                background.onerror = function() {
                    // If background fails, create simple scene
                    ctx.fillStyle = '#87CEEB';
                    ctx.fillRect(0, 0, 1024, 1024);
                    resolve(canvas.toDataURL('image/png'));
                };
                
                background.src = KINDNESS_BACKGROUNDS[backgroundKey];
            });
        }

        // STORY GENERATION
        async function generateKindnessStory() {
            const name = document.getElementById('childName').value.trim() || 'Alex';
            
            if (!name) {
                showError('Please enter the child\'s name!');
                return;
            }

            const btn = document.getElementById('generateBtn');
            const spinner = document.getElementById('loadingSpinner');
            const btnText = document.getElementById('btnText');
            
            btn.disabled = true;
            btn.style.background = 'linear-gradient(45deg, #ffa726, #ff9800)';
            spinner.style.display = 'block';
            btnText.textContent = `🌱 Creating ${name}'s Story...`;

            hideMessages();
            showSuccess(`🎨 Generating "${name}'s Garden of Kindness"...`);

            try {
                const personality = document.getElementById('childPersonality').value;
                const favoriteThings = document.getElementById('favoriteThings').value.trim() || 'playing outside and helping others';
                const age = document.getElementById('childAge').value;
                const gender = document.getElementById('childGender').value;

                // Step 1: Generate character
                btnText.textContent = `🎨 Creating ${name}'s Character...`;
                showSuccess(`👨‍🎨 Generating character...`);
                
                const characterImage = await generateCharacter();
                
                if (characterImage) {
                    showSuccess(`✅ Character created successfully!`);
                } else {
                    showError('Character generation failed, using fallback');
                }

                // Step 2: Composite character onto all backgrounds
                btnText.textContent = `🖼️ Creating Story Scenes...`;
                showSuccess(`🎬 Compositing character onto backgrounds...`);
                
                const sceneImages = [];
                for (let i = 1; i <= 6; i++) {
                    const sceneKey = `scene${i}`;
                    btnText.textContent = `🎨 Scene ${i}/6...`;
                    
                    try {
                        const compositeImage = await createCompositeScene(sceneKey, characterImage);
                        sceneImages.push(compositeImage);
                        showSuccess(`✅ Scene ${i} complete!`);
                    } catch (error) {
                        console.error(`Scene ${i} composition failed:`, error);
                        // Use original background as fallback
                        sceneImages.push(KINDNESS_BACKGROUNDS[sceneKey]);
                        showSuccess(`⚠️ Scene ${i} using background only`);
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 300));
                }

                // Step 3: Assemble final story
                btnText.textContent = `📖 Assembling Story...`;
                showSuccess(`🎉 Finalizing ${name}'s kindness adventure...`);
                
                currentStoryData = {
                    name, age, gender, personality, favoriteThings,
                    title: personalizeText(kindnessStory.title, name, gender),
                    fullMoral: kindnessStory.fullMoral,
                    pages: kindnessStory.scenes.map((scene, index) => ({
                        title: personalizeText(scene.title, name, gender),
                        text: personalizeAdvancedText(scene.text, name, gender, personality, favoriteThings),
                        imageUrl: sceneImages[index]
                    }))
                };

                currentPage = 0;
                displayStory();
                
                btnText.textContent = `✅ ${name}'s Story Complete!`;
                showSuccess(`🎉 "${currentStoryData.title}" is ready! Navigate through all pages.`);

            } catch (error) {
                console.error('Generation error:', error);
                showError(`Failed to create story: ${error.message}`);
                btnText.textContent = '🌻 Create Kindness Story!';
                btn.style.background = 'linear-gradient(45deg, #4ecdc4, #44a08d)';
            } finally {
                setTimeout(() => {
                    btn.disabled = false;
                    spinner.style.display = 'none';
                    btnText.textContent = '🌻 Create Kindness Story!';
                    btn.style.background = 'linear-gradient(45deg, #4ecdc4, #44a08d)';
                }, 2000);
            }
        }

        function personalizeText(text, name, gender) {
            const pronouns = gender === 'girl' 
                ? { his_her: 'her', him_her: 'her', he_she: 'she', He_She: 'She' }
                : { his_her: 'his', him_her: 'him', he_she: 'he', He_She: 'He' };
            
            return text
                .replace(/{name}/g, name)
                .replace(/{his_her}/g, pronouns.his_her)
                .replace(/{him_her}/g, pronouns.him_her)
                .replace(/{he_she}/g, pronouns.he_she)
                .replace(/{He_She}/g, pronouns.He_She);
        }

        function personalizeAdvancedText(text, name, gender, personality, favoriteThings) {
            const pronouns = gender === 'girl' 
                ? { his_her: 'her', him_her: 'her', he_she: 'she', He_She: 'She' }
                : { his_her: 'his', him_her: 'him', he_she: 'he', He_She: 'He' };
            
            return text
                .replace(/{name}/g, name)
                .replace(/{his_her}/g, pronouns.his_her)
                .replace(/{him_her}/g, pronouns.him_her)
                .replace(/{he_she}/g, pronouns.he_she)
                .replace(/{He_She}/g, pronouns.He_She)
                .replace(/{personality}/g, personality)
                .replace(/{favorite_things}/g, favoriteThings)
                .replace(/{age}/g, document.getElementById('childAge').value);
        }

        function displayStory() {
            document.getElementById('defaultPreview').style.display = 'none';
            document.getElementById('bookDisplay').style.display = 'block';
            document.getElementById('downloadSection').style.display = 'block';
            updatePage();
        }

        function updatePage() {
            const image = document.getElementById('bookImage');
            const title = document.getElementById('bookTitle');
            const text = document.getElementById('bookText');
            const moral = document.getElementById('moralLesson');
            const indicator = document.getElementById('pageIndicator');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            const currentPageData = currentStoryData.pages[currentPage];
            
            image.src = currentPageData.imageUrl;
            title.textContent = currentStoryData.title;
            text.textContent = currentPageData.text;
            
            if (currentPage === currentStoryData.pages.length - 1) {
                moral.style.display = 'block';
                moral.innerHTML = `<h5>🌻 Kindness Lesson</h5><p>${currentStoryData.fullMoral}</p>`;
            } else {
                moral.style.display = 'none';
            }
            
            indicator.textContent = `Page ${currentPage + 1} of ${currentStoryData.pages.length}`;
            
            prevBtn.disabled = currentPage === 0;
            nextBtn.disabled = currentPage === currentStoryData.pages.length - 1;
        }

        function previousPage() {
            if (currentPage > 0) {
                currentPage--;
                updatePage();
            }
        }

        function nextPage() {
            if (currentPage < currentStoryData.pages.length - 1) {
                currentPage++;
                updatePage();
            }
        }

        async function downloadStoryPDF() {
            if (!currentStoryData.title) {
                alert('Please generate a story first!');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');

                // Cover page
                pdf.setFillColor(46, 125, 50);
                pdf.rect(0, 0, 210, 297, 'F');
                
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(28);
                pdf.setFont(undefined, 'bold');
                pdf.text(currentStoryData.title, 105, 50, { align: 'center' });
                
                pdf.setFontSize(16);
                pdf.text(`A Story About Kindness`, 105, 70, { align: 'center' });

                // Story pages
                currentStoryData.pages.forEach((page, index) => {
                    pdf.addPage();
                    
                    pdf.setFillColor(250, 250, 255);
                    pdf.rect(0, 0, 210, 297, 'F');
                    
                    pdf.setFillColor(46, 125, 50);
                    pdf.rect(0, 0, 210, 25, 'F');
                    pdf.setTextColor(255, 255, 255);
                    pdf.setFontSize(14);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(page.title, 105, 17, { align: 'center' });
                    
                    try {
                        pdf.addImage(page.imageUrl, 'PNG', 15, 35, 180, 140);
                    } catch (e) {
                        pdf.setFillColor(220, 220, 220);
                        pdf.rect(15, 35, 180, 140, 'F');
                    }
                    
                    pdf.setFillColor(255, 255, 255);
                    pdf.rect(20, 185, 170, 70, 'F');
                    pdf.setDrawColor(46, 125, 50);
                    pdf.setLineWidth(2);
                    pdf.rect(20, 185, 170, 70, 'S');
                    
                    pdf.setTextColor(50, 50, 50);
                    pdf.setFontSize(11);
                    pdf.setFont(undefined, 'normal');
                    const lines = pdf.splitTextToSize(page.text, 150);
                    let yPos = 200;
                    lines.forEach(line => {
                        if (yPos < 245) {
                            pdf.text(line, 105, yPos, { align: 'center' });
                            yPos += 7;
                        }
                    });
                });

                pdf.save(`${currentStoryData.name}_Garden_of_Kindness.pdf`);
                alert('🌻 Your kindness story has been downloaded!');
                
            } catch (error) {
                console.error('PDF error:', error);
                alert('❌ Failed to create PDF. Please try again.');
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        function showSuccess(message) {
            const successEl = document.getElementById('successMessage');
            successEl.textContent = message;
            successEl.style.display = 'block';
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        console.log("Character Overlay System loaded successfully!");
    </script>
</body>
</html>
