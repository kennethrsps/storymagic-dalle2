<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryMagic Pro - Premium Custom Books</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 25px;
            box-shadow: 0 25px 70px rgba(0,0,0,0.4);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #ff6b6b, #ffa726, #4ecdc4);
            color: white;
            text-align: center;
            padding: 25px;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 800;
        }

        .header p {
            font-size: 1.3em;
            opacity: 0.95;
            font-weight: 500;
        }

        .main-content {
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 0;
            min-height: 900px;
        }

        .form-section {
            padding: 30px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-right: 3px solid #dee2e6;
        }

        .preview-section {
            padding: 20px;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.9em;
            font-family: inherit;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.2);
        }

        .form-group textarea {
            height: 60px;
            resize: vertical;
        }

        .detail-section {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 5px solid #2196f3;
        }

        .detail-section h4 {
            color: #1976d2;
            margin-bottom: 10px;
            font-size: 1em;
            font-weight: 700;
        }

        .character-details {
            background: #fff3e0;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 5px solid #ff9800;
        }

        .character-details h4 {
            color: #f57c00;
            margin-bottom: 10px;
            font-size: 1em;
            font-weight: 700;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .generate-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 18px 25px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            position: relative;
            overflow: hidden;
            margin-top: 15px;
            box-shadow: 0 8px 20px rgba(78, 205, 196, 0.3);
        }

        .generate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(78, 205, 196, 0.4);
        }

        .generate-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .loading-spinner {
            display: none;
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translateY(-50%) rotate(0deg); }
            100% { transform: translateY(-50%) rotate(360deg); }
        }

        .book-display {
            display: none;
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            border: 3px solid #f0f0f0;
        }

        .book-image {
            width: 100%;
            height: 600px;
            object-fit: cover;
            background: #f8f9fa;
            border-bottom: 2px solid #eee;
        }

        .book-content {
            padding: 25px 35px 20px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }

        .book-title {
            font-size: 1.6em;
            color: #2c3e50;
            margin-bottom: 12px;
            font-weight: 700;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .book-text {
            font-size: 1.1em;
            line-height: 1.6;
            color: #495057;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 500;
            font-family: 'Georgia', serif;
        }

        .moral-lesson {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 5px solid #ffb74d;
            text-align: center;
        }

        .moral-lesson h5 {
            color: #e65100;
            margin-bottom: 5px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .moral-lesson p {
            color: #bf360c;
            font-size: 0.85em;
            font-style: italic;
            margin: 0;
        }

        .book-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 35px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 0 0 20px 20px;
        }

        .nav-btn {
            background: rgba(255,255,255,0.15);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .nav-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .page-indicator {
            font-weight: 700;
            color: white;
            font-size: 1.1em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .download-section {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: center;
            display: none;
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3);
        }

        .download-section h4 {
            font-size: 1.3em;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .download-section p {
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .download-btn {
            background: white;
            color: #28a745;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            margin: 8px;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .download-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .message {
            padding: 12px 15px;
            border-radius: 10px;
            margin-top: 12px;
            display: none;
            font-weight: 500;
            font-size: 0.9em;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }

        .default-preview {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }

        .default-preview h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2em;
            font-weight: 700;
        }

        .preview-placeholder {
            width: 280px;
            height: 280px;
            border-radius: 20px;
            background: linear-gradient(45deg, #ff9a9e, #fecfef, #ffecd2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 6em;
            margin: 30px auto;
            border: 5px solid white;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: float 4s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(2deg); }
        }

        .premium-features {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            border-left: 5px solid #4caf50;
        }

        .premium-features h4 {
            color: #2e7d32;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .premium-features ul {
            list-style: none;
            padding: 0;
        }

        .premium-features li {
            color: #388e3c;
            margin-bottom: 5px;
            font-size: 0.9em;
            padding-left: 20px;
            position: relative;
        }

        .premium-features li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #4caf50;
            font-weight: bold;
        }

        .character-consistency {
            background: #fff8e1;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #ffc107;
        }

        .character-consistency h5 {
            color: #f57c00;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .character-consistency p {
            color: #ef6c00;
            font-size: 0.8em;
            margin: 0;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 400px 1fr;
            }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 10px;
            }
            
            .book-image {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📚 StoryMagic Pro</h1>
            <p>Premium Custom Children's Books - Professional Quality</p>
        </div>

        <div class="main-content">
            <div class="form-section">
                <h2 style="color: #333; margin-bottom: 20px; text-align: center; font-weight: 700;">Create Premium Custom Book</h2>
                
                <div class="detail-section">
                    <h4>👶 Child Information</h4>
                    
                    <div class="form-group">
                        <label for="childName">Child's Full Name</label>
                        <input type="text" id="childName" placeholder="Enter child's full name" value="Dom">
                    </div>

                    <div class="row">
                        <div class="form-group">
                            <label for="childAge">Age</label>
                            <select id="childAge">
                                <option value="3">3 years old</option>
                                <option value="4" selected>4 years old</option>
                                <option value="5">5 years old</option>
                                <option value="6">6 years old</option>
                                <option value="7">7 years old</option>
                                <option value="8">8 years old</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="childGender">Gender</label>
                            <select id="childGender">
                                <option value="girl" selected>Girl</option>
                                <option value="boy">Boy</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="character-details">
                    <h4>🎨 Character Appearance</h4>
                    
                    <div class="form-group">
                        <label for="hairStyle">Hair Style & Length</label>
                        <select id="hairStyle">
                            <option value="shoulder-length straight" selected>Shoulder-length Straight</option>
                            <option value="long wavy">Long Wavy</option>
                            <option value="short curly">Short Curly</option>
                            <option value="medium curly">Medium Curly</option>
                            <option value="bob cut">Bob Cut</option>
                            <option value="pigtails">Pigtails</option>
                            <option value="ponytail">Ponytail</option>
                        </select>
                    </div>

                    <div class="row">
                        <div class="form-group">
                            <label for="hairColor">Hair Color</label>
                            <select id="hairColor">
                                <option value="black" selected>Black</option>
                                <option value="dark brown">Dark Brown</option>
                                <option value="light brown">Light Brown</option>
                                <option value="blonde">Blonde</option>
                                <option value="strawberry blonde">Strawberry Blonde</option>
                                <option value="red">Red</option>
                                <option value="auburn">Auburn</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="eyeColor">Eye Color</label>
                            <select id="eyeColor">
                                <option value="brown" selected>Brown</option>
                                <option value="dark brown">Dark Brown</option>
                                <option value="hazel">Hazel</option>
                                <option value="blue">Blue</option>
                                <option value="green">Green</option>
                                <option value="gray">Gray</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="form-group">
                            <label for="skinTone">Skin Tone</label>
                            <select id="skinTone">
                                <option value="light">Light</option>
                                <option value="medium" selected>Medium</option>
                                <option value="tan">Tan</option>
                                <option value="dark">Dark</option>
                                <option value="olive">Olive</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="facialFeatures">Face Shape</label>
                            <select id="facialFeatures">
                                <option value="round" selected>Round (child-like)</option>
                                <option value="oval">Oval</option>
                                <option value="heart">Heart-shaped</option>
                                <option value="square">Square</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="specialFeatures">Special Features (Optional)</label>
                        <textarea id="specialFeatures" placeholder="e.g., dimples, freckles, glasses, birthmarks..."></textarea>
                    </div>
                </div>

                <div class="detail-section">
                    <h4>📖 Story Customization</h4>
                    
                    <div class="form-group">
                        <label for="storyTheme">Story Theme</label>
                        <select id="storyTheme">
                            <option value="kindness">🌻 The Power of Kindness</option>
                            <option value="courage">🦁 Finding Inner Courage</option>
                            <option value="sharing">🎁 The Joy of Sharing</option>
                            <option value="honesty">✨ The Strength of Honesty</option>
                            <option value="friendship">🤝 Building True Friendship</option>
                            <option value="perseverance">🏔️ Never Give Up</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="childPersonality">Child's Personality</label>
                        <select id="childPersonality">
                            <option value="cheerful and outgoing" selected>Cheerful & Outgoing</option>
                            <option value="shy and thoughtful">Shy & Thoughtful</option>
                            <option value="brave and adventurous">Brave & Adventurous</option>
                            <option value="creative and artistic">Creative & Artistic</option>
                            <option value="kind and gentle">Kind & Gentle</option>
                            <option value="curious and smart">Curious & Smart</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="favoriteThings">Favorite Things (Optional)</label>
                        <textarea id="favoriteThings" placeholder="e.g., loves unicorns, plays soccer, has a pet cat..."></textarea>
                    </div>
                </div>

                <div class="character-consistency">
                    <h5>🎯 Character Consistency</h5>
                    <p>We use advanced prompting to ensure your child looks the same in every scene. The more details you provide, the better the consistency!</p>
                </div>

                <button class="generate-btn" onclick="generatePremiumStory()" id="generateBtn">
                    <div class="loading-spinner" id="loadingSpinner"></div>
                    <span id="btnText">🎨 Create Premium Story Book!</span>
                </button>

                <div class="message success-message" id="successMessage"></div>
                <div class="message error-message" id="errorMessage"></div>
                
                <div class="download-section" id="downloadSection">
                    <h4>📚 Premium Book Ready!</h4>
                    <p>Professional quality story book with stunning visuals</p>
                    <button class="download-btn" onclick="downloadPremiumPDF()">📄 Download Premium PDF</button>
                </div>

                <div class="premium-features">
                    <h4>✨ Premium Features</h4>
                    <ul>
                        <li>Detailed character customization</li>
                        <li>Professional book layout</li>
                        <li>Moral lesson integration</li>
                        <li>High-resolution images</li>
                        <li>Print-ready quality</li>
                        <li>Personalized storytelling</li>
                    </ul>
                </div>
            </div>

            <div class="preview-section">
                <div class="book-display" id="bookDisplay">
                    <img class="book-image" id="bookImage" alt="Story scene">
                    <div class="book-content">
                        <div class="book-title" id="bookTitle">Story Title</div>
                        <div class="book-text" id="bookText">Story content...</div>
                        <div class="moral-lesson" id="moralLesson">
                            <h5>📖 Life Lesson</h5>
                            <p>Moral lesson will appear here</p>
                        </div>
                    </div>
                    <div class="book-navigation">
                        <button class="nav-btn" onclick="previousPage()" id="prevBtn">← Previous</button>
                        <span class="page-indicator" id="pageIndicator">Page 1 of 6</span>
                        <button class="nav-btn" onclick="nextPage()" id="nextBtn">Next →</button>
                    </div>
                </div>

                <div class="default-preview" id="defaultPreview">
                    <div class="preview-placeholder" id="previewPlaceholder">📖</div>
                    <h3>Premium Story Preview</h3>
                    <p style="font-size: 1.2em; line-height: 1.6; margin-bottom: 20px;">Create a professional-quality personalized book where your child is the main character!</p>
                    <p style="font-size: 1em; opacity: 0.8;">Every detail matters - from hair style to personality traits. The more information you provide, the more amazing the result!</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        let currentStoryData = {};
        let currentPage = 0;

        // PREMIUM STORY TEMPLATES WITH ENHANCED DETAILS
        const premiumStories = {
            kindness: {
                title: "{name}'s Garden of Kindness",
                shortMoral: "Small acts of kindness create big changes",
                fullMoral: "This story teaches that even the smallest acts of kindness can transform not just others, but ourselves too. When we choose kindness, we plant seeds that grow into beautiful friendships and positive change.",
                pages: [
                    {
                        text: "Meet {name}, a {personality} {age}-year-old who loves to {favorite_things}. One sunny morning, {name} discovered something that would change everything.",
                        scene: "character_introduction"
                    },
                    {
                        text: "{name} found an old, forgotten garden where an elderly gardener sat alone among wilting flowers. The poor man looked so sad that {name}'s heart filled with compassion.",
                        scene: "problem_discovery"
                    },
                    {
                        text: "Even though {name} was {personality}, {he_she} gathered courage and approached the lonely gardener. '{name} would like to help make your garden beautiful again,' {he_she} said with a gentle smile.",
                        scene: "taking_action"
                    },
                    {
                        text: "Working side by side, {name} and the gardener planted new seeds, watered the flowers, and shared stories. The gardener's face lit up with joy as they worked together.",
                        scene: "collaboration"
                    },
                    {
                        text: "As if by magic, the garden began to bloom in brilliant colors! Other children saw the beautiful garden and joined in, creating a community space filled with laughter and friendship.",
                        scene: "transformation"
                    },
                    {
                        text: "{name} learned that kindness is like planting seeds - it grows and spreads, creating beauty everywhere. The garden became a symbol of what happens when we care for others.",
                        scene: "lesson_learned"
                    }
                ]
            },
            courage: {
                title: "{name} Finds Inner Courage",
                shortMoral: "True courage means doing what's right when you're scared",
                fullMoral: "This story shows that courage isn't about not being afraid - it's about doing the right thing even when your heart is racing. Every act of bravery, no matter how small, makes the world a better place.",
                pages: [
                    {
                        text: "{name} was known for being {personality}, but today would test {his_her} courage in ways {he_she} never imagined. Sometimes heroes come in small packages.",
                        scene: "character_introduction"
                    },
                    {
                        text: "On the playground, {name} witnessed something that made {his_her} stomach flutter with worry. A group of older kids were picking on a smaller child who looked scared and alone.",
                        scene: "problem_discovery"
                    },
                    {
                        text: "{name}'s hands were shaking and {his_her} heart was beating fast, but {he_she} remembered what it felt like to be scared. Taking a deep breath, {name} stepped forward.",
                        scene: "taking_action"
                    },
                    {
                        text: "'Please stop,' {name} said with a trembling but determined voice. 'Everyone deserves to feel safe and happy.' The bullies were surprised by {name}'s brave words.",
                        scene: "collaboration"
                    },
                    {
                        text: "Other children saw {name}'s courage and joined in to support the scared child. Together, they created a circle of protection and friendship around those who needed it most.",
                        scene: "transformation"
                    },
                    {
                        text: "From that day forward, {name} was known as someone who stood up for others. {He_She} learned that courage grows stronger each time you use it to help someone else.",
                        scene: "lesson_learned"
                    }
                ]
            },
            sharing: {
                title: "{name} Discovers the Magic of Sharing",
                shortMoral: "Sharing creates abundance and brings people together",
                fullMoral: "This story reveals the beautiful truth that when we share what we have, we don't lose anything - we gain friendship, joy, and the wonderful feeling that comes from making others happy.",
                pages: [
                    {
                        text: "{name}, a {personality} child who loves {favorite_things}, brought {his_her} most special lunch to school. It was {his_her} absolute favorite meal!",
                        scene: "character_introduction"
                    },
                    {
                        text: "At lunchtime, {name} noticed a classmate sitting alone with no food. The child looked hungry and sad, glancing longingly at everyone else's meals.",
                        scene: "problem_discovery"
                    },
                    {
                        text: "{name} looked at {his_her} delicious lunch, then at the hungry child. Though it was hard to give up {his_her} favorite food, {name} knew what felt right in {his_her} heart.",
                        scene: "taking_action"
                    },
                    {
                        text: "Walking over with half of {his_her} lunch, {name} sat beside the lonely child. 'Would you like to share with me?' {name} asked with a warm smile.",
                        scene: "collaboration"
                    },
                    {
                        text: "Soon, other children saw {name}'s kindness and began sharing their lunches too. The table became a feast of friendship, with everyone contributing something special.",
                        scene: "transformation"
                    },
                    {
                        text: "{name} realized something amazing: by sharing {his_her} lunch, {he_she} had gained something even better - wonderful friends and the joy that comes from caring for others.",
                        scene: "lesson_learned"
                    }
                ]
            },
            honesty: {
                title: "{name} and the Power of Truth",
                shortMoral: "Honesty builds trust and brings people closer",
                fullMoral: "This story demonstrates that telling the truth, even when it's difficult or scary, always leads to better outcomes and stronger relationships than hiding behind lies.",
                pages: [
                    {
                        text: "{name}, a {personality} {age}-year-old who enjoys {favorite_things}, was playing inside when something unexpected happened that would test {his_her} character.",
                        scene: "character_introduction"
                    },
                    {
                        text: "While playing, {name} accidentally knocked over {his_her} mother's favorite vase. It shattered into pieces on the floor, and {name} felt panic rising in {his_her} chest.",
                        scene: "problem_discovery"
                    },
                    {
                        text: "{name} thought about hiding the broken vase or blaming someone else. {His_Her} mind raced with different stories, but something inside told {him_her} what was right.",
                        scene: "taking_action"
                    },
                    {
                        text: "With trembling hands and a racing heart, {name} gathered the pieces and went to find {his_her} mother. 'Mom, I need to tell you something important,' {name} said bravely.",
                        scene: "collaboration"
                    },
                    {
                        text: "When {name} told the truth, {his_her} mother was initially sad about the vase but proud of {name}'s honesty. 'Thank you for telling me the truth,' she said, giving {name} a warm hug.",
                        scene: "transformation"
                    },
                    {
                        text: "Together, they cleaned up the pieces, and {name} learned that honesty brings people closer together. The truth had turned a scary moment into a lesson about trust and love.",
                        scene: "lesson_learned"
                    }
                ]
            },
            friendship: {
                title: "{name} Builds a Bridge of Friendship",
                shortMoral: "True friendship requires effort, understanding, and forgiveness",
                fullMoral: "This story teaches that friendships, like bridges, need to be built carefully with understanding, maintained with effort, and sometimes repaired with forgiveness.",
                pages: [
                    {
                        text: "{name}, who is {personality} and loves {favorite_things}, had a best friend who meant the world to {him_her}. But even the strongest friendships face challenges.",
                        scene: "character_introduction"
                    },
                    {
                        text: "One day, {name} and {his_her} best friend had a terrible argument over something that seemed very important at the time. Both children walked away feeling hurt and angry.",
                        scene: "problem_discovery"
                    },
                    {
                        text: "As hours passed, {name} felt a growing emptiness inside. The fun games weren't fun anymore, and the beautiful day felt gray without {his_her} best friend to share it with.",
                        scene: "taking_action"
                    },
                    {
                        text: "Swallowing {his_her} pride, {name} decided to be the first to apologize. {He_She} created a special card that showed how much the friendship meant to {him_her}.",
                        scene: "collaboration"
                    },
                    {
                        text: "When {name} approached with the card, {his_her} friend's eyes filled with happy tears. They both said sorry at the same time and hugged tighter than ever before.",
                        scene: "transformation"
                    },
                    {
                        text: "{name} discovered that friendship becomes stronger when it's tested and repaired with love. Like a bridge rebuilt after a storm, their friendship was now unbreakable.",
                        scene: "lesson_learned"
                    }
                ]
            },
            perseverance: {
                title: "{name} Never Gives Up",
                shortMoral: "Persistence and hard work lead to amazing achievements",
                fullMoral: "This story shows that when we don't give up, even when things get difficult, we can achieve things that once seemed impossible. Every small step forward matters.",
                pages: [
                    {
                        text: "{name}, a {personality} child who loves {favorite_things}, had a big dream that seemed almost impossible. But {name} believed that dreams are worth fighting for.",
                        scene: "character_introduction"
                    },
                    {
                        text: "{name} wanted to learn something very challenging, but every attempt ended in failure. Other kids made it look so easy, but for {name}, it felt like climbing a mountain.",
                        scene: "problem_discovery"
                    },
                    {
                        text: "When {name} felt like giving up, {he_she} remembered all the people who believed in {him_her}. 'I can do this,' {name} said, wiping away tears of frustration.",
                        scene: "taking_action"
                    },
                    {
                        text: "Day after day, {name} practiced. Sometimes {he_she} failed, sometimes {he_she} improved a little. A kind teacher noticed {name}'s effort and offered encouragement and help.",
                        scene: "collaboration"
                    },
                    {
                        text: "Finally, after weeks of trying, {name} achieved the goal! The feeling of success was even sweeter because of all the hard work it took to get there.",
                        scene: "transformation"
                    },
                    {
                        text: "{name} learned that the most amazing achievements come to those who never give up. Every failure had been a step closer to success, and every tear had been worth it.",
                        scene: "lesson_learned"
                    }
                ]
            }
        };

        async function generatePremiumStory() {
            // Collect all the detailed information
            const name = document.getElementById('childName').value.trim() || 'Alex';
            const age = document.getElementById('childAge').value;
            const gender = document.getElementById('childGender').value;
            const hairStyle = document.getElementById('hairStyle').value;
            const hairColor = document.getElementById('hairColor').value;
            const eyeColor = document.getElementById('eyeColor').value;
            const skinTone = document.getElementById('skinTone').value;
            const facialFeatures = document.getElementById('facialFeatures').value;
            const specialFeatures = document.getElementById('specialFeatures').value.trim();
            const storyTheme = document.getElementById('storyTheme').value;
            const personality = document.getElementById('childPersonality').value;
            const favoriteThings = document.getElementById('favoriteThings').value.trim() || 'playing and learning';
            
            if (!name) {
                showError('Please enter the child\'s name!');
                return;
            }

            const btn = document.getElementById('generateBtn');
            const spinner = document.getElementById('loadingSpinner');
            const btnText = document.getElementById('btnText');
            
            btn.disabled = true;
            spinner.style.display = 'block';
            btnText.textContent = `Creating ${name}'s Premium Story...`;

            hideMessages();

            try {
                const storyTemplate = premiumStories[storyTheme];
                
                // Create detailed character description for consistency
                const characterDescription = `A ${age}-year-old ${gender} named ${name} with ${hairStyle} ${hairColor} hair, ${eyeColor} eyes, ${skinTone} skin tone, ${facialFeatures} face shape${specialFeatures ? ', ' + specialFeatures : ''}. Character is ${personality}.`;
                
                // Personalize the story
                const personalizedStory = {
                    title: personalizeText(storyTemplate.title, name, gender),
                    shortMoral: storyTemplate.shortMoral,
                    fullMoral: storyTemplate.fullMoral,
                    pages: storyTemplate.pages.map(page => ({
                        text: personalizeAdvancedText(page.text, name, gender, personality, favoriteThings),
                        scene: page.scene
                    }))
                };

                // Generate images for all pages with detailed character consistency
                const pageImages = [];
                for (let i = 0; i < personalizedStory.pages.length; i++) {
                    try {
                        showSuccess(`Creating page ${i + 1} of ${personalizedStory.pages.length}... Premium quality rendering! ✨`);
                        
                        const scenePrompts = {
                            character_introduction: `${characterDescription} in a happy, welcoming scene showing their personality, children's book illustration, professional quality, detailed character design, consistent character`,
                            problem_discovery: `${characterDescription} discovering a problem or challenge, emotional expression visible, dramatic lighting, children's book illustration, same character as previous scenes`,
                            taking_action: `${characterDescription} making a brave decision or taking action, determined expression, heroic pose, children's book illustration, exact same character design`,
                            collaboration: `${characterDescription} working with others or helping someone, teamwork scene, warm lighting, children's book illustration, consistent character appearance`,
                            transformation: `${characterDescription} witnessing or being part of a positive change, magical or uplifting atmosphere, children's book illustration, same character throughout`,
                            lesson_learned: `${characterDescription} having learned an important lesson, wise and happy expression, celebratory scene, children's book illustration, character consistency maintained`
                        };
                        
                        const scenePrompt = scenePrompts[personalizedStory.pages[i].scene] + `, CRITICAL: Maintain exact same character appearance - ${characterDescription}`;
                        
                        const response = await fetch('/api/generate-image', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ 
                                prompt: scenePrompt,
                                size: "1024x1024",
                                quality: "hd",
                                style: "vivid"
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            const imageUrl = data.url || data.data?.[0]?.url || data.image_url;
                            pageImages.push(imageUrl);
                        } else {
                            throw new Error(`Page ${i + 1} generation failed`);
                        }
                        
                        // Add delay between requests
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                    } catch (error) {
                        console.log(`Page ${i + 1} failed, using premium fallback`);
                        pageImages.push(createPremiumFallback(name, age, gender, hairStyle, hairColor, eyeColor, skinTone, storyTheme, i));
                    }
                }

                // Store complete story data
                currentStoryData = {
                    name, age, gender, hairStyle, hairColor, eyeColor, skinTone, 
                    facialFeatures, specialFeatures, personality, favoriteThings,
                    title: personalizedStory.title,
                    shortMoral: personalizedStory.shortMoral,
                    fullMoral: personalizedStory.fullMoral,
                    pages: personalizedStory.pages.map((page, index) => ({
                        text: page.text,
                        scene: page.scene,
                        imageUrl: pageImages[index]
                    }))
                };

                currentPage = 0;
                displayPremiumStory();
                
                showSuccess(`🎉 ${name}'s premium story book is ready! Navigate through all ${personalizedStory.pages.length} pages to see the professional quality!`);

            } catch (error) {
                console.error('Error:', error);
                showError(`Failed to create premium story: ${error.message}`);
            } finally {
                btn.disabled = false;
                spinner.style.display = 'none';
                btnText.textContent = '🎨 Create Premium Story Book!';
            }
        }

        function personalizeText(text, name, gender) {
            const pronouns = gender === 'girl' 
                ? { his_her: 'her', him_her: 'her', he_she: 'she', He_She: 'She' }
                : { his_her: 'his', him_her: 'him', he_she: 'he', He_She: 'He' };
            
            return text
                .replace(/{name}/g, name)
                .replace(/{his_her}/g, pronouns.his_her)
                .replace(/{him_her}/g, pronouns.him_her)
                .replace(/{he_she}/g, pronouns.he_she)
                .replace(/{He_She}/g, pronouns.He_She);
        }

        function personalizeAdvancedText(text, name, gender, personality, favoriteThings) {
            const pronouns = gender === 'girl' 
                ? { his_her: 'her', him_her: 'her', he_she: 'she', He_She: 'She' }
                : { his_her: 'his', him_her: 'him', he_she: 'he', He_She: 'He' };
            
            return text
                .replace(/{name}/g, name)
                .replace(/{his_her}/g, pronouns.his_her)
                .replace(/{him_her}/g, pronouns.him_her)
                .replace(/{he_she}/g, pronouns.he_she)
                .replace(/{He_She}/g, pronouns.He_She)
                .replace(/{personality}/g, personality)
                .replace(/{favorite_things}/g, favoriteThings)
                .replace(/{age}/g, document.getElementById('childAge').value);
        }

        function createPremiumFallback(name, age, gender, hairStyle, hairColor, eyeColor, skinTone, theme, pageIndex) {
            const canvas = document.createElement('canvas');
            canvas.width = 1024;
            canvas.height = 1024;
            const ctx = canvas.getContext('2d');

            // Premium backgrounds for each scene type
            const sceneBackgrounds = [
                { colors: ['#FFE4B5', '#FFB6C1'], mood: 'introduction' },
                { colors: ['#B0C4DE', '#D8BFD8'], mood: 'concern' },
                { colors: ['#FFD700', '#FFA500'], mood: 'action' },
                { colors: ['#98FB98', '#90EE90'], mood: 'collaboration' },
                { colors: ['#DDA0DD', '#9370DB'], mood: 'transformation' },
                { colors: ['#FF69B4', '#FFB6C1'], mood: 'celebration' }
            ];

            const scene = sceneBackgrounds[pageIndex] || sceneBackgrounds[0];
            
            // Create premium gradient background
            const gradient = ctx.createLinearGradient(0, 0, 1024, 1024);
            gradient.addColorStop(0, scene.colors[0]);
            gradient.addColorStop(1, scene.colors[1]);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 1024, 1024);

            // PREMIUM CHARACTER DRAWING with exact specifications
            const centerX = 512;
            const centerY = 400;
            const scale = 1.8;

            // Skin tone mapping
            const skinTones = {
                light: '#F8D7A1',
                medium: '#F4C2A1', 
                tan: '#E8B888',
                dark: '#D2B48C',
                olive: '#E6D2AA'
            };

            // Head with proper skin tone
            ctx.fillStyle = skinTones[document.getElementById('skinTone').value] || skinTones.medium;
            ctx.beginPath();
            
            // Face shape variations
            const faceShape = document.getElementById('facialFeatures').value;
            if (faceShape === 'round') {
                ctx.arc(centerX, centerY - 100 * scale, 70 * scale, 0, 2 * Math.PI);
            } else if (faceShape === 'oval') {
                ctx.ellipse(centerX, centerY - 100 * scale, 60 * scale, 75 * scale, 0, 0, 2 * Math.PI);
            } else {
                ctx.arc(centerX, centerY - 100 * scale, 65 * scale, 0, 2 * Math.PI);
            }
            ctx.fill();

            // Hair with exact style matching
            const hairColorMap = {
                black: '#1C1C1C',
                'dark brown': '#3C2414',
                'light brown': '#8B4513',
                blonde: '#FFD700',
                'strawberry blonde': '#FFA500',
                red: '#CD5C5C',
                auburn: '#A0522D'
            };
            
            ctx.fillStyle = hairColorMap[hairColor] || '#1C1C1C';
            
            // Hair style implementation
            if (hairStyle.includes('curly')) {
                // Curly hair pattern
                for (let i = 0; i < 10; i++) {
                    const angle = (i * Math.PI) / 5;
                    const x = centerX + Math.cos(angle) * 60 * scale;
                    const y = centerY - 130 * scale + Math.sin(angle) * 30 * scale;
                    ctx.beginPath();
                    ctx.arc(x, y, 20 * scale, 0, 2 * Math.PI);
                    ctx.fill();
                }
            } else if (hairStyle.includes('long')) {
                // Long hair
                ctx.beginPath();
                ctx.arc(centerX, centerY - 130 * scale, 85 * scale, 0, Math.PI);
                ctx.fill();
                ctx.fillRect(centerX - 85 * scale, centerY - 50 * scale, 170 * scale, 120 * scale);
            } else {
                // Standard hair
                ctx.beginPath();
                ctx.arc(centerX, centerY - 130 * scale, 75 * scale, 0, Math.PI);
                ctx.fill();
            }

            // Eyes with exact color
            const eyeColorMap = {
                brown: '#8B4513',
                'dark brown': '#654321',
                hazel: '#8B7355',
                blue: '#4169E1',
                green: '#228B22',
                gray: '#708090'
            };
            
            // Eye whites
            ctx.fillStyle = '#FFFFFF';
            ctx.beginPath();
            ctx.arc(centerX - 25 * scale, centerY - 110 * scale, 15 * scale, 0, 2 * Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(centerX + 25 * scale, centerY - 110 * scale, 15 * scale, 0, 2 * Math.PI);
            ctx.fill();
            
            // Colored iris
            ctx.fillStyle = eyeColorMap[eyeColor] || '#8B4513';
            ctx.beginPath();
            ctx.arc(centerX - 25 * scale, centerY - 110 * scale, 10 * scale, 0, 2 * Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(centerX + 25 * scale, centerY - 110 * scale, 10 * scale, 0, 2 * Math.PI);
            ctx.fill();

            // Pupils and highlights
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(centerX - 25 * scale, centerY - 110 * scale, 5 * scale, 0, 2 * Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(centerX + 25 * scale, centerY - 110 * scale, 5 * scale, 0, 2 * Math.PI);
            ctx.fill();

            ctx.fillStyle = '#FFFFFF';
            ctx.beginPath();
            ctx.arc(centerX - 22 * scale, centerY - 113 * scale, 2 * scale, 0, 2 * Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(centerX + 28 * scale, centerY - 113 * scale, 2 * scale, 0, 2 * Math.PI);
            ctx.fill();

            // Scene-appropriate expression
            ctx.strokeStyle = '#D2691E';
            ctx.lineWidth = 4 * scale;
            ctx.beginPath();
            
            const expressions = ['happy', 'concerned', 'determined', 'working', 'amazed', 'wise'];
            const expr = expressions[pageIndex] || 'happy';
            
            if (expr === 'happy' || expr === 'wise') {
                ctx.arc(centerX, centerY - 80 * scale, 20 * scale, 0, Math.PI);
            } else if (expr === 'concerned') {
                ctx.arc(centerX, centerY - 70 * scale, 12 * scale, Math.PI, 2 * Math.PI);
            } else {
                ctx.moveTo(centerX - 15 * scale, centerY - 80 * scale);
                ctx.lineTo(centerX + 15 * scale, centerY - 80 * scale);
            }
            ctx.stroke();

            // Premium outfit
            const outfitColors = {
                kindness: '#FF69B4',
                courage: '#9370DB', 
                sharing: '#FFD700',
                honesty: '#87CEEB',
                friendship: '#98FB98',
                perseverance: '#FF7F50'
            };

            ctx.fillStyle = outfitColors[theme] || '#FF69B4';
            ctx.beginPath();
            ctx.arc(centerX, centerY + 30 * scale, 90 * scale, 0, Math.PI);
            ctx.fill();

            // Arms in scene-appropriate positions
            ctx.fillStyle = skinTones[document.getElementById('skinTone').value] || skinTones.medium;
            const armPositions = [
                { left: [-70, 0], right: [70, 0] },     // Introduction
                { left: [-75, -10], right: [60, 10] },   // Concern
                { left: [-60, -20], right: [60, -20] },  // Action
                { left: [-80, -5], right: [50, -15] },   // Collaboration  
                { left: [-65, -25], right: [65, -25] },  // Transformation
                { left: [-55, -30], right: [55, -30] }   // Celebration
            ];

            const armPos = armPositions[pageIndex] || armPositions[0];
            ctx.beginPath();
            ctx.arc(centerX + armPos.left[0] * scale, centerY + armPos.left[1] * scale, 25 * scale, 0, 2 * Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(centerX + armPos.right[0] * scale, centerY + armPos.right[1] * scale, 25 * scale, 0, 2 * Math.PI);
            ctx.fill();

            // Premium text styling
            ctx.fillStyle = '#FFFFFF';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 3 * scale;
            ctx.font = `bold ${35 * scale}px Georgia`;
            ctx.textAlign = 'center';
            ctx.strokeText(name, centerX, 950);
            ctx.fillText(name, centerX, 950);

            return canvas.toDataURL('image/png');
        }

        function displayPremiumStory() {
            document.getElementById('defaultPreview').style.display = 'none';
            document.getElementById('bookDisplay').style.display = 'block';
            document.getElementById('downloadSection').style.display = 'block';
            updatePremiumPage();
        }

        function updatePremiumPage() {
            const image = document.getElementById('bookImage');
            const title = document.getElementById('bookTitle');
            const text = document.getElementById('bookText');
            const moral = document.getElementById('moralLesson');
            const indicator = document.getElementById('pageIndicator');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            const currentPageData = currentStoryData.pages[currentPage];
            
            image.src = currentPageData.imageUrl;
            title.textContent = currentStoryData.title;
            text.textContent = currentPageData.text;
            
            // Show moral lesson on last page
            if (currentPage === currentStoryData.pages.length - 1) {
                moral.style.display = 'block';
                moral.innerHTML = `<h5>📖 Life Lesson</h5><p>${currentStoryData.fullMoral}</p>`;
            } else {
                moral.style.display = 'none';
            }
            
            indicator.textContent = `Page ${currentPage + 1} of ${currentStoryData.pages.length}`;
            
            prevBtn.disabled = currentPage === 0;
            nextBtn.disabled = currentPage === currentStoryData.pages.length - 1;
        }

        function previousPage() {
            if (currentPage > 0) {
                currentPage--;
                updatePremiumPage();
            }
        }

        function nextPage() {
            if (currentPage < currentStoryData.pages.length - 1) {
                currentPage++;
                updatePremiumPage();
            }
        }

        async function downloadPremiumPDF() {
            if (!currentStoryData.title) {
                alert('Please generate a premium story first!');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');

                // Premium cover page
                pdf.setFillColor(25, 25, 112);
                pdf.rect(0, 0, 210, 297, 'F');
                
                // Gold title
                pdf.setTextColor(255, 215, 0);
                pdf.setFontSize(28);
                pdf.setFont(undefined, 'bold');
                pdf.text(currentStoryData.title, 105, 50, { align: 'center' });
                
                pdf.setFontSize(16);
                pdf.setTextColor(255, 255, 255);
                pdf.text(`A Premium Story for ${currentStoryData.name}`, 105, 70, { align: 'center' });
                
                pdf.setFontSize(12);
                pdf.text(`Age ${currentStoryData.age} • ${currentStoryData.personality}`, 105, 85, { align: 'center' });

                // Character details
                pdf.setFontSize(10);
                pdf.text(`${currentStoryData.hairStyle} ${currentStoryData.hairColor} hair • ${currentStoryData.eyeColor} eyes`, 105, 100, { align: 'center' });

                // First page image as cover
                try {
                    pdf.addImage(currentStoryData.pages[0].imageUrl, 'PNG', 30, 120, 150, 120);
                } catch (e) {
                    pdf.setFillColor(244, 194, 161);
                    pdf.circle(105, 180, 40, 'F');
                }

                pdf.setTextColor(255, 215, 0);
                pdf.setFontSize(14);
                pdf.text('StoryMagic Pro - Premium Edition', 105, 270, { align: 'center' });

                // Story pages with premium layout
                currentStoryData.pages.forEach((page, index) => {
                    pdf.addPage();
                    
                    // Premium page background
                    pdf.setFillColor(250, 250, 255);
                    pdf.rect(0, 0, 210, 297, 'F');
                    
                    // Page header with chapter info
                    pdf.setFillColor(25, 25, 112);
                    pdf.rect(0, 0, 210, 25, 'F');
                    pdf.setTextColor(255, 255, 255);
                    pdf.setFontSize(14);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(`Chapter ${index + 1}`, 105, 17, { align: 'center' });
                    
                    // Large premium image
                    try {
                        pdf.addImage(page.imageUrl, 'PNG', 15, 35, 180, 140);
                    } catch (e) {
                        pdf.setFillColor(220, 220, 220);
                        pdf.rect(15, 35, 180, 140, 'F');
                        pdf.setTextColor(100, 100, 100);
                        pdf.text(`Chapter ${index + 1} Image`, 105, 105, { align: 'center' });
                    }
                    
                    // Premium text box
                    pdf.setFillColor(255, 255, 255);
                    pdf.rect(20, 185, 170, 70, 'F');
                    pdf.setDrawColor(25, 25, 112);
                    pdf.setLineWidth(2);
                    pdf.rect(20, 185, 170, 70, 'S');
                    
                    // Story text with premium typography
                    pdf.setTextColor(50, 50, 50);
                    pdf.setFontSize(11);
                    pdf.setFont(undefined, 'normal');
                    const lines = pdf.splitTextToSize(page.text, 150);
                    let yPos = 200;
                    lines.forEach(line => {
                        if (yPos < 245) {
                            pdf.text(line, 105, yPos, { align: 'center' });
                            yPos += 7;
                        }
                    });

                    // Page number
                    pdf.setTextColor(100, 100, 100);
                    pdf.setFontSize(10);
                    pdf.text(`${index + 1}`, 105, 285, { align: 'center' });
                });

                // Final moral lesson page
                pdf.addPage();
                pdf.setFillColor(255, 248, 220);
                pdf.rect(0, 0, 210, 297, 'F');
                
                pdf.setTextColor(139, 69, 19);
                pdf.setFontSize(20);
                pdf.setFont(undefined, 'bold');
                pdf.text('The Lesson', 105, 50, { align: 'center' });
                
                pdf.setFillColor(255, 255, 255);
                pdf.rect(20, 70, 170, 150, 'F');
                pdf.setDrawColor(139, 69, 19);
                pdf.rect(20, 70, 170, 150, 'S');
                
                pdf.setTextColor(101, 67, 33);
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'normal');
                const moralLines = pdf.splitTextToSize(currentStoryData.fullMoral, 150);
                let moralY = 90;
                moralLines.forEach(line => {
                    if (moralY < 210) {
                        pdf.text(line, 105, moralY, { align: 'center' });
                        moralY += 8;
                    }
                });

                pdf.save(`${currentStoryData.name}_Premium_Story_Book.pdf`);
                alert('📚 Premium story book downloaded! Professional quality ready for printing!');
                
            } catch (error) {
                console.error('PDF error:', error);
                alert('❌ Failed to create premium PDF. Please try again.');
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        function showSuccess(message) {
            const successEl = document.getElementById('successMessage');
            successEl.textContent = message;
            successEl.style.display = 'block';
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        // Update preview when form changes
        function updatePreview() {
            const name = document.getElementById('childName').value || 'Child';
            const theme = document.getElementById('storyTheme').value;
            const themeEmojis = {
                kindness: '🌻',
                courage: '🦁',
                sharing: '🎁',
                honesty: '✨',
                friendship: '🤝',
                perseverance: '🏔️'
            };
            
            document.getElementById('previewPlaceholder
