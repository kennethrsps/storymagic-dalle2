<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryMagic Pro - AI-Powered Personalized Children's Books</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .hero-section {
            text-align: center;
            padding: 60px 20px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><defs><radialGradient id="a"><stop offset="20%" stop-color="%23FFF" stop-opacity="0.1"/><stop offset="100%" stop-color="%23FFF" stop-opacity="0"/></radialGradient></defs><circle fill="url(%23a)" cx="10" cy="10" r="10"/><circle fill="url(%23a)" cx="30" cy="5" r="8"/><circle fill="url(%23a)" cx="60" cy="15" r="6"/><circle fill="url(%23a)" cx="80" cy="8" r="12"/></svg>') repeat;
            animation: sparkle 3s linear infinite;
        }

        @keyframes sparkle {
            0% { transform: translateX(0); }
            100% { transform: translateX(100px); }
        }

        .hero-title {
            font-size: 3.5em;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }

        .hero-subtitle {
            font-size: 1.3em;
            margin-bottom: 15px;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        .hero-tagline {
            font-size: 1.1em;
            font-weight: 300;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }

        .pricing-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
            position: relative;
            z-index: 1;
        }

        .container {
            max-width: 1200px;
            margin: -30px auto 0;
            background: white;
            border-radius: 30px 30px 0 0;
            box-shadow: 0 -10px 50px rgba(0,0,0,0.2);
            position: relative;
            z-index: 2;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 700px;
        }

        .form-section {
            padding: 50px 40px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .preview-section {
            padding: 50px 40px;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .section-title {
            font-size: 2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            position: relative;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 3px;
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
            border-radius: 2px;
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 1em;
            font-family: inherit;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
            transform: translateY(-2px);
        }

        .character-customization {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .generate-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 18px 30px;
            border-radius: 25px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(78, 205, 196, 0.3);
        }

        .generate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(78, 205, 196, 0.4);
        }

        .generate-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .loading-spinner {
            display: none;
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            border: 3px solid transparent;
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translateY(-50%) rotate(0deg); }
            100% { transform: translateY(-50%) rotate(360deg); }
        }

        .story-book {
            display: none;
            width: 100%;
            height: 550px;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .story-book:hover {
            transform: scale(1.02);
        }

        .story-page {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .story-overlay {
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 85%;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.2);
            animation: fadeInUp 0.8s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .story-title {
            font-size: 2.2em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            font-weight: bold;
        }

        .story-text {
            font-size: 1.2em;
            line-height: 1.8;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .highlight {
            background: linear-gradient(120deg, #a8edea 0%, #fed6e3 100%);
            padding: 4px 10px;
            border-radius: 8px;
            font-weight: bold;
            color: #333;
            text-shadow: none;
        }

        .character-preview {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            margin: 0 auto 30px;
            background: linear-gradient(45deg, #ff9a9e, #fecfef);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5em;
            border: 6px solid white;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .character-preview::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .character-preview:hover::before {
            left: 100%;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            padding: 60px 40px;
            background: white;
        }

        .feature-card {
            text-align: center;
            padding: 30px 20px;
            border-radius: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-10px);
        }

        .feature-icon {
            font-size: 3em;
            margin-bottom: 20px;
        }

        .feature-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .pricing-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 80px 40px;
            text-align: center;
        }

        .pricing-card {
            background: white;
            color: #333;
            border-radius: 25px;
            padding: 50px 40px;
            max-width: 500px;
            margin: 0 auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        .pricing-badge-large {
            position: absolute;
            top: -10px;
            right: -10px;
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
            color: white;
            padding: 10px 30px;
            border-radius: 50px;
            font-weight: bold;
            transform: rotate(15deg);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .price {
            font-size: 4em;
            font-weight: bold;
            color: #4ecdc4;
            margin: 20px 0;
        }

        .price-subtitle {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 30px;
        }

        .buy-btn {
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
            color: white;
            border: none;
            padding: 20px 50px;
            border-radius: 50px;
            font-size: 1.4em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
        }

        .buy-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(255, 107, 107, 0.4);
        }

        .testimonial-section {
            padding: 80px 40px;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            text-align: center;
        }

        .testimonial {
            max-width: 800px;
            margin: 0 auto;
            font-size: 1.3em;
            font-style: italic;
            color: #333;
            margin-bottom: 30px;
        }

        .customer-name {
            font-weight: bold;
            color: #ff6b6b;
        }

        .success-message, .error-message {
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            display: none;
            font-weight: 500;
        }

        .success-message {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border-left: 5px solid #28a745;
        }

        .error-message {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border-left: 5px solid #dc3545;
        }

        .premium-features {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 30px;
        }

        .premium-features h4 {
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .premium-features ul {
            list-style: none;
            padding: 0;
        }

        .premium-features li {
            padding: 8px 0;
            position: relative;
            padding-left: 25px;
        }

        .premium-features li::before {
            content: '‚ú®';
            position: absolute;
            left: 0;
        }

        .download-section {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: center;
            display: none;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .download-btn {
            background: white;
            color: #28a745;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .hero-title {
                font-size: 2.5em;
            }
            
            .character-customization {
                grid-template-columns: 1fr;
            }
            
            .story-overlay {
                padding: 25px;
                max-width: 95%;
            }
            
            .story-title {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <!-- Hero Section -->
    <div class="hero-section">
        <div class="pricing-badge">üé® Professional AI Story Generator</div>
        <h1 class="hero-title">StoryMagic Pro</h1>
        <p class="hero-subtitle">Create Stunning Personalized Children's Books</p>
        <p class="hero-tagline">Each story is uniquely crafted with AI-generated illustrations that bring your child's imagination to life</p>
    </div>

    <div class="container">
        <div class="main-content">
            <div class="form-section">
                <h2 class="section-title">Create Your Story</h2>
                
                <div class="form-group">
                    <label for="childName">Child's Name</label>
                    <input type="text" id="childName" placeholder="Enter your child's name" value="Emma">
                </div>

                <div class="character-customization">
                    <div class="form-group">
                        <label for="childAge">Age</label>
                        <select id="childAge">
                            <option value="3">3 years old</option>
                            <option value="4">4 years old</option>
                            <option value="5">5 years old</option>
                            <option value="6" selected>6 years old</option>
                            <option value="7">7 years old</option>
                            <option value="8">8 years old</option>
                            <option value="9">9 years old</option>
                            <option value="10">10 years old</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="childGender">Character Type</label>
                        <select id="childGender">
                            <option value="child">Child</option>
                            <option value="brave boy">Brave Boy</option>
                            <option value="adventurous girl">Adventurous Girl</option>
                            <option value="young hero">Young Hero</option>
                            <option value="little explorer">Little Explorer</option>
                        </select>
                    </div>
                </div>

                <div class="character-customization">
                    <div class="form-group">
                        <label for="hairColor">Hair Color</label>
                        <select id="hairColor">
                            <option value="brown">Brown Hair</option>
                            <option value="blonde">Blonde Hair</option>
                            <option value="black">Black Hair</option>
                            <option value="red">Red Hair</option>
                            <option value="curly brown">Curly Brown</option>
                            <option value="long blonde">Long Blonde</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="eyeColor">Eye Color</label>
                        <select id="eyeColor">
                            <option value="brown">Brown Eyes</option>
                            <option value="blue">Blue Eyes</option>
                            <option value="green">Green Eyes</option>
                            <option value="hazel">Hazel Eyes</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="animalFriend">Animal Companion</label>
                    <select id="animalFriend">
                        <option value="magical butterfly">ü¶ã Magical Butterfly</option>
                        <option value="wise rabbit">üê∞ Wise Rabbit</option>
                        <option value="loyal cat">üê± Loyal Cat</option>
                        <option value="playful dog">üê∂ Playful Dog</option>
                        <option value="friendly dragon">üêâ Friendly Dragon</option>
                        <option value="wise owl">ü¶â Wise Owl</option>
                        <option value="gentle unicorn">ü¶Ñ Gentle Unicorn</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="storyTheme">Story Adventure</label>
                    <select id="storyTheme">
                        <option value="garden" selected>üåª Magical Garden</option>
                        <option value="space">üöÄ Space Adventure</option>
                        <option value="princess">üëë Royal Adventure</option>
                        <option value="ocean">üåä Ocean Explorer</option>
                        <option value="forest">üå≤ Enchanted Forest</option>
                        <option value="castle">üè∞ Medieval Castle</option>
                        <option value="pirate">üè¥‚Äç‚ò†Ô∏è Pirate Adventure</option>
                        <option value="dinosaur">ü¶ï Dinosaur World</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="customElements">Special Elements (Optional)</label>
                    <textarea id="customElements" rows="3" placeholder="Add special details: favorite colors, hobbies, or magical elements you'd like included..."></textarea>
                </div>

                <button class="generate-btn" onclick="generateStoryWithImage()" id="generateBtn">
                    <div class="loading-spinner" id="loadingSpinner"></div>
                    <span id="btnText">üé® Generate Your Magical Story!</span>
                </button>

                <div class="premium-features">
                    <h4>‚ú® What You Get:</h4>
                    <ul>
                        <li>Personalized AI-generated artwork</li>
                        <li>Custom story featuring your child</li>
                        <li>High-resolution 1024x1024 images</li>
                        <li>Professional-quality illustrations</li>
                        <li>Unique story every time</li>
                        <li>Perfect for printing & sharing</li>
                    </ul>
                </div>

                <div class="success-message" id="successMessage"></div>
                <div class="error-message" id="errorMessage"></div>
                
                <!-- Download Section -->
                <div class="download-section" id="downloadSection">
                    <h4 style="margin-bottom: 15px;">üì• Download Your Story</h4>
                    <p style="margin-bottom: 20px;">Your personalized story is ready!</p>
                    <button class="download-btn" onclick="downloadPDF()">üìÑ Download PDF Book</button>
                    <button class="download-btn" onclick="downloadImage()">üñºÔ∏è Download Image Only</button>
                    <p style="font-size: 0.9em; margin-top: 15px; opacity: 0.8;">Perfect for printing, sharing, or keeping as a digital keepsake!</p>
                </div>
            </div>

            <div class="preview-section">
                <div class="character-preview" id="characterPreview">
                    üåª
                </div>

                <div class="story-book" id="storyBook">
                    <div class="story-page" id="storyPage">
                        <div class="story-overlay">
                            <div class="story-title" id="storyTitle">Your Story Title</div>
                            <div class="story-text" id="storyText">Your personalized story will appear here...</div>
                        </div>
                    </div>
                </div>

                <div id="defaultPreview" style="text-align: center;">
                    <h3 style="color: #333; margin-bottom: 20px; font-size: 1.5em;">AI Story Preview</h3>
                    <p style="color: #666; font-size: 1.1em; line-height: 1.6;">Generate your story to see the AI image as background with your personalized text overlay!</p>
                    <p style="color: #999; font-size: 0.9em; margin-top: 15px;">Each story is completely unique and crafted specifically for your child.</p>
                </div>
            </div>
        </div>

        <!-- Features Section -->
        <div class="features-grid">
            <div class="feature-card">
                <div class="feature-icon">üé®</div>
                <div class="feature-title">AI-Generated Art</div>
                <p>Each illustration is created by advanced AI technology, ensuring your child's story is completely unique and personalized.</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">üìö</div>
                <div class="feature-title">Custom Stories</div>
                <p>Stories adapt to your child's age, interests, and appearance, creating a truly personalized reading experience.</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">‚ú®</div>
                <div class="feature-title">Premium Quality</div>
                <p>High-resolution images perfect for printing, sharing, or creating physical books that will last a lifetime.</p>
            </div>
        </div>
    </div>

    <!-- Testimonial Section -->
    <div class="testimonial-section">
        <h2 style="font-size: 2.5em; margin-bottom: 40px; color: #333;">What Parents Are Saying</h2>
        <div class="testimonial">
            "My daughter was absolutely amazed to see herself as the main character! The AI artwork is stunning and the story quality is incredible. Worth every penny!"
        </div>
        <div class="customer-name">- Sarah M., Mother of 6-year-old</div>
    </div>

    <!-- Pricing Section -->
    <div class="pricing-section">
        <h2 style="font-size: 3em; margin-bottom: 30px;">Create Magic Today</h2>
        <div class="pricing-card">
            <div class="pricing-badge-large">POPULAR</div>
            <h3 style="font-size: 2em; margin-bottom: 20px;">Premium Story Package</h3>
            <div class="price">$12.99</div>
            <div class="price-subtitle">One-time payment ‚Ä¢ Instant delivery</div>
            <ul style="text-align: left; margin: 30px 0; line-height: 2;">
                <li>‚úÖ 1 Personalized AI-generated story</li>
                <li>‚úÖ High-resolution artwork (1024x1024)</li>
                <li>‚úÖ Multiple character customization options</li>
                <li>‚úÖ 8+ different story themes</li>
                <li>‚úÖ Perfect for printing & sharing</li>
                <li>‚úÖ Instant download</li>
            </ul>
            <button class="buy-btn" onclick="purchaseStory()">üõí Buy Now - $12.99</button>
            <p style="margin-top: 20px; color: #666; font-size: 0.9em;">30-day money-back guarantee</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Global variables to store current story data
        let currentStoryData = {};

        // Enhanced story templates - Multi-page stories with lessons for toddlers
        const storyTemplates = {
            garden: {
                title: "{name}'s Magical Garden",
                pages: [
                    {
                        text: "<span class='highlight'>{name}</span> found a sad, dry garden.",
                        lesson: "Sometimes things look broken, but we can help fix them!",
                        prompt: "A {age}-year-old {gender} named {name} with {hair} and {eyes} looking at a sad wilted garden with drooping flowers, accompanied by a {animalFriend}, children's book illustration, simple and clear, toddler-friendly art style"
                    },
                    {
                        text: "The flowers whispered, 'We need water, please help us!'",
                        lesson: "It's important to listen when others ask for help.",
                        prompt: "Talking flowers with sad faces speaking to {name}, a {age}-year-old {gender} with {hair} and {eyes}, {animalFriend} listening too, magical garden scene, children's book illustration, expressive flowers, toddler-friendly"
                    },
                    {
                        text: "<span class='highlight'>{name}</span> and {animalFriend} brought water for every flower.",
                        lesson: "Helping others makes everyone happy!",
                        prompt: "{name}, a {age}-year-old {gender} with {hair} and {eyes}, watering colorful flowers with a watering can, {animalFriend} helping carry water, bright happy garden, children's book illustration, cheerful and vibrant"
                    },
                    {
                        text: "The garden bloomed! 'Thank you!' sang the happy flowers.",
                        lesson: "When we help others, beautiful things happen!",
                        prompt: "A magnificent blooming garden with smiling flowers, {name} a {age}-year-old {gender} with {hair} and {eyes} celebrating with {animalFriend}, rainbow colors, butterflies, children's book illustration, joyful celebration scene"
                    },
                    {
                        text: "<span class='highlight'>{name}</span> learned that kindness makes the world more beautiful.",
                        lesson: "Being kind is the most magical thing we can do!",
                        prompt: "{name} a {age}-year-old {gender} with {hair} and {eyes} smiling in a beautiful magical garden, {animalFriend} beside them, hearts and sparkles in the air, children's book illustration, warm and loving, toddler-friendly final scene"
                    }
                ],
                mainPrompt: "A beautiful magical garden with talking flowers, colorful butterflies, and a happy {age}-year-old {gender} named {name} with {hair} and {eyes}, accompanied by a {animalFriend}, watering glowing plants, fantasy children's book illustration, vibrant colors, whimsical and enchanting"
            },
            space: {
                title: "{name} Goes to Space",
                pages: [
                    {
                        text: "<span class='highlight'>{name}</span> wanted to visit the stars.",
                        lesson: "It's good to dream big!",
                        prompt: "{name} a {age}-year-old {gender} with {hair} and {eyes} looking up at twinkling stars from their bedroom window, {animalFriend} beside them, children's book illustration, dreamy nighttime scene"
                    },
                    {
                        text: "A friendly rocket said, 'Hop in! Let's go explore!'",
                        lesson: "Sometimes adventures come when we least expect them!",
                        prompt: "A colorful smiling rocket ship talking to {name} a {age}-year-old {gender} with {hair} and {eyes}, {animalFriend} excited too, children's book illustration, friendly and inviting"
                    },
                    {
                        text: "In space, they met a lonely planet who had no friends.",
                        lesson: "Everyone needs friendship, even planets!",
                        prompt: "{name} a {age}-year-old {gender} with {hair} and {eyes} in a cute space suit floating near a sad planet with a face, {animalFriend} in tiny space helmet, stars around, children's book illustration"
                    },
                    {
                        text: "<span class='highlight'>{name}</span> said, 'We can be your friends!'",
                        lesson: "Offering friendship is always the right thing to do!",
                        prompt: "{name} a {age}-year-old {gender} with {hair} and {eyes} reaching out to shake hands with a smiling planet, {animalFriend} giving planet a hug, space background, children's book illustration, heartwarming scene"
                    },
                    {
                        text: "Now the planet was happy and had many star friends too!",
                        lesson: "When we share friendship, it grows and spreads!",
                        prompt: "Happy planet surrounded by smiling stars, {name} a {age}-year-old {gender} with {hair} and {eyes} and {animalFriend} celebrating, colorful space party, children's book illustration, joyful cosmic celebration"
                    }
                ],
                mainPrompt: "A young {age}-year-old {gender} astronaut named {name} with {hair} and {eyes} in a colorful space suit floating among stars, planets, and nebulas, accompanied by a {animalFriend} in a tiny space helmet, children's book illustration, cosmic and magical"
            },
            princess: {
                title: "{name} the Kind Princess",
                pages: [
                    {
                        text: "Princess <span class='highlight'>{name}</span> lived in a beautiful castle.",
                        lesson: "Even princesses have responsibilities!",
                        prompt: "Princess {name} a {age}-year-old {gender} with {hair} and {eyes} in a pretty dress standing in front of a colorful castle, {animalFriend} wearing a tiny crown, children's book illustration, magical and royal"
                    },
                    {
                        text: "She heard someone crying in the forest.",
                        lesson: "Good people listen when others are sad.",
                        prompt: "Princess {name} with {hair} and {eyes} listening carefully, hand to ear, {animalFriend} beside her, forest in background with crying sounds, children's book illustration, caring expression"
                    },
                    {
                        text: "A little dragon was stuck under a big rock!",
                        lesson: "Sometimes those who look scary just need help!",
                        prompt: "A small cute dragon trapped under a rock looking sad, Princess {name} a {age}-year-old {gender} with {hair} and {eyes} and {animalFriend} discovering them, children's book illustration, empathetic scene"
                    },
                    {
                        text: "Princess <span class='highlight'>{name}</span> and {animalFriend} moved the rock together.",
                        lesson: "Working together makes us stronger!",
                        prompt: "Princess {name} with {hair} and {eyes} and {animalFriend} pushing a big rock together to free the dragon, teamwork scene, children's book illustration, cooperation and effort"
                    },
                    {
                        text: "The dragon became their best friend forever!",
                        lesson: "Helping others creates the best friendships!",
                        prompt: "Princess {name} a {age}-year-old {gender} with {hair} and {eyes}, {animalFriend}, and a happy little dragon playing together in a meadow, friendship and joy, children's book illustration, heartwarming ending"
                    }
                ],
                mainPrompt: "A young {age}-year-old royal {gender} named {name} with {hair} and {eyes} in a beautiful crystal palace with rainbow reflections, wearing elegant royal clothes, accompanied by a {animalFriend}, surrounded by magical crystal formations, children's book illustration, sparkly and majestic"
            },
            ocean: {
                title: "{name}'s Ocean Adventure",
                pages: [
                    {
                        text: "<span class='highlight'>{name}</span> found a magic seashell at the beach.",
                        lesson: "Magic can be found in simple things!",
                        prompt: "{name} a {age}-year-old {gender} with {hair} and {eyes} holding a glowing seashell on a sunny beach, {animalFriend} beside them, waves in background, children's book illustration, magical discovery"
                    },
                    {
                        text: "The shell said, 'I can take you underwater to meet my friends!'",
                        lesson: "New experiences can be exciting!",
                        prompt: "A magical talking seashell with sparkles speaking to {name} with {hair} and {eyes}, {animalFriend} listening amazed, beach setting, children's book illustration, wonder and magic"
                    },
                    {
                        text: "Under the sea, the fish were very sad and scared.",
                        lesson: "Sometimes others need our help to feel safe.",
                        prompt: "{name} a {age}-year-old {gender} with {hair} and {eyes} underwater in a bubble, {animalFriend} beside them, surrounded by sad scared fish, coral reef, children's book illustration, underwater empathy scene"
                    },
                    {
                        text: "'Don't worry,' said <span class='highlight'>{name}</span>. 'We'll help clean your home!'",
                        lesson: "Taking care of our world is everyone's job!",
                        prompt: "{name} with {hair} and {eyes} and {animalFriend} underwater picking up trash and cleaning the ocean, fish watching hopefully, children's book illustration, environmental care, helping hands"
                    },
                    {
                        text: "The ocean became clean and beautiful again!",
                        lesson: "When we take care of nature, everyone is happy!",
                        prompt: "Crystal clear ocean with happy colorful fish swimming around {name} a {age}-year-old {gender} with {hair} and {eyes} and {animalFriend}, coral reef blooming, children's book illustration, environmental success, joy and celebration"
                    }
                ],
                mainPrompt: "A cheerful {age}-year-old {gender} named {name} with {hair} and {eyes} swimming underwater with colorful fish, dolphins, and sea turtles, accompanied by a {animalFriend}, in a vibrant coral reef, magical underwater scene, children's book illustration, bright and oceanic"
            },
            forest: {
                title: "{name} and the Lost Animals",
                pages: [
                    {
                        text: "<span class='highlight'>{name}</span> heard crying sounds in the dark forest.",
                        lesson: "Brave people help others even when they're scared!",
                        prompt: "{name} a {age}-year-old {gender} with {hair} and {eyes} at the edge of a forest, {animalFriend} beside them, listening to sad sounds, children's book illustration, brave and caring"
                    },
                    {
                        text: "Three baby animals had lost their way home.",
                        lesson: "Everyone gets lost sometimes and needs help!",
                        prompt: "Three cute baby animals (bunny, squirrel, bird) looking lost and sad, {name} with {hair} and {eyes} and {animalFriend} finding them in the forest, children's book illustration, discovery scene"
                    },
                    {
                        text: "'Don't cry,' said <span class='highlight'>{name}</span>. 'We'll help you find home!'",
                        lesson: "Kind words help others feel better!",
                        prompt: "{name} a {age}-year-old {gender} with {hair} and {eyes} kneeling down to comfort three baby animals, {animalFriend} being supportive, forest setting, children's book illustration, compassion and kindness"
                    },
                    {
                        text: "They followed the animal tracks through the forest together.",
                        lesson: "Working as a team helps solve problems!",
                        prompt: "{name} with {hair} and {eyes}, {animalFriend}, and three baby animals following paw prints through a sunny forest path, teamwork adventure, children's book illustration, problem-solving together"
                    },
                    {
                        text: "The mama animals were so happy to see their babies safe!",
                        lesson: "Helping others brings joy to everyone!",
                        prompt: "Happy reunion scene with mama animals hugging their babies, {name} a {age}-year-old {gender} with {hair} and {eyes} and {animalFriend} watching joyfully, forest clearing, children's book illustration, love and family joy"
                    }
                ],
                mainPrompt: "A brave {age}-year-old {gender} named {name} with {hair} and {eyes} in an enchanted forest with talking animals like rabbits, deer, and owls, accompanied by a {animalFriend}, magical trees with glowing leaves, children's book illustration, warm and mystical"
            },
            castle: {
                title: "Knight {name} and the Medieval Quest",
                text: "In a time of knights and castles, young <span class='highlight'>{name}</span>, a valiant {age}-year-old {gender} with noble {hair} and determined {eyes}, was chosen for a special quest. With {animalFriend} as their loyal companion, {name} proved that courage comes in all sizes.",
                prompt: "A young {age}-year-old {gender} knight named {name} with {hair} and {eyes} in medieval armor standing before a grand castle, accompanied by a {animalFriend}, medieval fantasy setting, children's book illustration, heroic and inspiring, detailed character in knight costume"
            },
            pirate: {
                title: "Captain {name}'s Treasure Hunt",
                text: "Ahoy! Captain <span class='highlight'>{name}</span>, a daring {age}-year-old {gender} with windswept {hair} and adventurous {eyes}, set sail on the seven seas. With first mate {animalFriend} and a treasure map, {name} discovered that the greatest treasure was the friends made along the way.",
                prompt: "A young {age}-year-old {gender} pirate captain named {name} with {hair} and {eyes} on a pirate ship with treasure chests, accompanied by a {animalFriend} wearing a tiny pirate hat, ocean adventure scene, children's book illustration, adventurous and fun, detailed pirate character"
            },
            dinosaur: {
                title: "{name}'s Prehistoric Adventure",
                text: "When <span class='highlight'>{name}</span>, a curious {age}-year-old {gender} with amazing {hair} and wonder-filled {eyes}, discovered a portal to the age of dinosaurs, an incredible adventure began. With {animalFriend} by their side, {name} learned about friendship with the gentle giants of the past.",
                prompt: "A {age}-year-old {gender} named {name} with {hair} and {eyes} surrounded by friendly dinosaurs in a prehistoric landscape with volcanoes and ancient plants, accompanied by a {animalFriend}, children's book illustration, exciting and educational, detailed character with dinosaurs"
            }
        };

        async function generateStoryWithImage() {
            const name = document.getElementById('childName').value || 'Emma';
            const age = document.getElementById('childAge').value;
            const gender = document.getElementById('childGender').value;
            const hair = document.getElementById('hairColor').value;
            const eyes = document.getElementById('eyeColor').value;
            const animalFriend = document.getElementById('animalFriend').value;
            const theme = document.getElementById('storyTheme').value;
            const customElements = document.getElementById('customElements').value;
            
            // Show loading state
            const btn = document.getElementById('generateBtn');
            const spinner = document.getElementById('loadingSpinner');
            const btnText = document.getElementById('btnText');
            
            btn.disabled = true;
            spinner.style.display = 'block';
            btnText.textContent = 'Creating Your Magical Story...';

            // Hide messages
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';

            try {
                const story = storyTemplates[theme];
                let prompt = story.prompt
                    .replace(/{name}/g, name)
                    .replace(/{age}/g, age)
                    .replace(/{gender}/g, gender)
                    .replace(/{hair}/g, hair)
                    .replace(/{eyes}/g, eyes)
                    .replace(/{animalFriend}/g, animalFriend);
                
                // Add custom elements if provided
                if (customElements.trim()) {
                    prompt += `, ${customElements}`;
                }
                
                const response = await fetch('/api/generate-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt: prompt })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `HTTP ${response.status}`);
                }

                const data = await response.json();
                const imageUrl = data.data[0].url;

                // Update story display with AI image as background
                const storyPage = document.getElementById('storyPage');
                const storyTitle = document.getElementById('storyTitle');
                const storyText = document.getElementById('storyText');
                
                storyPage.style.backgroundImage = `url(${imageUrl})`;
                storyTitle.textContent = story.title
                    .replace(/{name}/g, name)
                    .replace(/{age}/g, age);
                storyText.innerHTML = story.text
                    .replace(/{name}/g, name)
                    .replace(/{age}/g, age)
                    .replace(/{gender}/g, gender)
                    .replace(/{hair}/g, hair)
                    .replace(/{eyes}/g, eyes)
                    .replace(/{animalFriend}/g, animalFriend);

                // Show the story book
                document.getElementById('defaultPreview').style.display = 'none';
                document.getElementById('storyBook').style.display = 'block';

                // Update character preview
                document.getElementById('characterPreview').innerHTML = getThemeEmoji(theme);

                // Show success message with download options
                showSuccess('üéâ Your magical story has been created! Click the image to view full size.');
                
                // Store story data for download
                currentStoryData = {
                    imageUrl: imageUrl,
                    title: story.title.replace(/{name}/g, name).replace(/{age}/g, age),
                    text: story.text.replace(/{name}/g, name).replace(/{age}/g, age).replace(/{gender}/g, gender).replace(/{hair}/g, hair).replace(/{eyes}/g, eyes).replace(/{animalFriend}/g, animalFriend),
                    name: name,
                    age: age,
                    theme: theme
                };
                
                // Show download section
                document.getElementById('downloadSection').style.display = 'block';

            } catch (error) {
                console.error('Error:', error);
                showError(`Failed to generate story: ${error.message}`);
            } finally {
                // Reset button state
                btn.disabled = false;
                spinner.style.display = 'none';
                btnText.textContent = 'üé® Generate Your Magical Story!';
            }
        }

        function getThemeEmoji(theme) {
            const emojis = {
                garden: 'üåª',
                space: 'üöÄ',
                princess: 'üëë',
                ocean: 'üåä',
                forest: 'üå≤',
                castle: 'üè∞',
                pirate: 'üè¥‚Äç‚ò†Ô∏è',
                dinosaur: 'ü¶ï'
            };
            return emojis[theme] || '‚ú®';
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 8000);
        }

        function showSuccess(message) {
            const successEl = document.getElementById('successMessage');
            successEl.textContent = message;
            successEl.style.display = 'block';
            setTimeout(() => {
                successEl.style.display = 'none';
            }, 5000);
        }

        function purchaseStory() {
            // This would integrate with your payment processor
            alert('üõí Redirecting to secure checkout...\n\nIn a real implementation, this would connect to:\n‚Ä¢ Stripe\n‚Ä¢ PayPal\n‚Ä¢ Square\n‚Ä¢ or your preferred payment processor');
        }

        async function downloadPDF() {
            if (!currentStoryData.imageUrl) {
                alert('Please generate a story first!');
                return;
            }

            try {
                // Create PDF using jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // Add title
                pdf.setFontSize(24);
                pdf.setFont(undefined, 'bold');
                pdf.text(currentStoryData.title, 105, 30, { align: 'center' });
                
                // Add image
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = function() {
                    // Add image to PDF (centered, maintaining aspect ratio)
                    const imgWidth = 150;
                    const imgHeight = 150;
                    const x = (210 - imgWidth) / 2; // Center on A4 width
                    
                    pdf.addImage(img, 'JPEG', x, 50, imgWidth, imgHeight);
                    
                    // Add story text
                    pdf.setFontSize(12);
                    pdf.setFont(undefined, 'normal');
                    
                    // Clean text (remove HTML tags)
                    const cleanText = currentStoryData.text.replace(/<[^>]*>/g, '');
                    const lines = pdf.splitTextToSize(cleanText, 180);
                    
                    pdf.text(lines, 15, 220);
                    
                    // Add footer
                    pdf.setFontSize(10);
                    pdf.setFont(undefined, 'italic');
                    pdf.text('Created with StoryMagic Pro - Personalized AI Stories', 105, 280, { align: 'center' });
                    
                    // Download the PDF
                    pdf.save(`${currentStoryData.name}_Story_${currentStoryData.theme}.pdf`);
                };
                
                img.onerror = function() {
                    // Fallback: Create PDF without image
                    pdf.setFontSize(12);
                    pdf.text('Story image will be available after purchase.', 15, 60);
                    
                    const cleanText = currentStoryData.text.replace(/<[^>]*>/g, '');
                    const lines = pdf.splitTextToSize(cleanText, 180);
                    pdf.text(lines, 15, 80);
                    
                    pdf.save(`${currentStoryData.name}_Story_${currentStoryData.theme}.pdf`);
                };
                
                img.src = currentStoryData.imageUrl;
                
            } catch (error) {
                console.error('PDF generation error:', error);
                alert('PDF generation failed. Please try again.');
            }
        }

        async function downloadImage() {
            if (!currentStoryData.imageUrl) {
                alert('Please generate a story first!');
                return;
            }

            try {
                // Download the image
                const link = document.createElement('a');
                link.href = currentStoryData.imageUrl;
                link.download = `${currentStoryData.name}_${currentStoryData.theme}_story.jpg`;
                link.click();
            } catch (error) {
                console.error('Image download error:', error);
                alert('Image download failed. Please right-click the image and save it manually.');
            }
        }

        // Update character preview when theme changes
        document.getElementById('storyTheme').addEventListener('change', function() {
            document.getElementById('characterPreview').textContent = getThemeEmoji(this.value);
        });

        // Add some interactive effects
        document.addEventListener('DOMContentLoaded', function() {
            // Add hover effects to form inputs
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    this.parentElement.style.transform = 'translateY(-2px)';
                });
                input.addEventListener('blur', function() {
                    this.parentElement.style.transform = 'translateY(0)';
                });
            });
        });
    </script>
</body>
</html>
