<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryMagic with DALL-E Integration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
            color: white;
            text-align: center;
            padding: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 600px;
        }

        .form-section {
            padding: 40px;
            background: #f8f9fa;
        }

        .preview-section {
            padding: 40px;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        .api-key-section {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border-left: 5px solid #2196f3;
        }

        .api-key-section h3 {
            color: #1976d2;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .api-key-input {
            position: relative;
        }

        .api-key-input input {
            padding-right: 50px;
        }

        .toggle-visibility {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
        }

        .appearance-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .generate-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .generate-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .loading-spinner {
            display: none;
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translateY(-50%) rotate(0deg); }
            100% { transform: translateY(-50%) rotate(360deg); }
        }

        .character-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto 20px;
            background: linear-gradient(45deg, #ff9a9e, #fecfef);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4em;
            border: 5px solid white;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .ai-generated-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .story-preview {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            line-height: 1.6;
            font-size: 1.1em;
            max-height: 400px;
            overflow-y: auto;
        }

        .story-title {
            color: #ff6b6b;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        .highlight {
            background: linear-gradient(120deg, #a8edea 0%, #fed6e3 100%);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }

        .ai-book-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .book-container {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            height: 90%;
            max-height: 700px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .book-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-book {
            background: none;
            border: none;
            color: white;
            font-size: 2em;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .close-book:hover {
            background: rgba(255,255,255,0.2);
        }

        .book-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .book-page {
            display: none;
            min-height: 500px;
            margin-bottom: 20px;
        }

        .book-page.active {
            display: block;
        }

        .page-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            min-height: 500px;
        }

        .image-container {
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .generated-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
        }

        .text-container {
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .page-title {
            font-size: 2em;
            color: #ff6b6b;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .page-text {
            font-size: 1.1em;
            line-height: 1.7;
            text-align: justify;
        }

        .book-navigation {
            padding: 20px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #eee;
        }

        .nav-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .nav-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-indicator {
            font-weight: bold;
            color: #333;
        }

        .cost-info {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 5px solid #4caf50;
        }

        .cost-info h4 {
            color: #2e7d32;
            margin-bottom: 8px;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 5px solid #f44336;
            display: none;
        }

        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 5px solid #4caf50;
            display: none;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .appearance-grid {
                grid-template-columns: 1fr;
            }

            .page-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .book-container {
                width: 95%;
                height: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎨 StoryMagic with DALL-E</h1>
            <p>Create personalized children's books with AI-generated illustrations!</p>
        </div>

        <div class="main-content">
            <div class="form-section">
                <div class="api-key-section">
                    <h3>🎨 AI Children's Book Demo</h3>
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #4caf50;">
                        <h4 style="color: #2e7d32; margin-bottom: 8px;">✅ Fully Working Demo</h4>
                        <p style="color: #1b5e20; font-size: 0.9em; margin-bottom: 10px;">
                            This demo generates custom story illustrations in real-time! No external API calls needed.
                        </p>
                        <p style="color: #1b5e20; font-size: 0.9em;">
                            <strong>Try it now:</strong> Images are created dynamically based on your story choices and character design.
                        </p>
                    </div>
                    <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">
                        Demo API Key (any value works): <strong>demo-key-12345</strong>
                    </p>
                    <div class="api-key-input">
                        <input type="text" id="apiKey" placeholder="demo-key-12345" value="demo-key-12345" style="font-family: monospace;">
                        <button type="button" class="toggle-visibility" onclick="toggleApiKeyVisibility()">👁️</button>
                    </div>
                </div>

                <h2 style="color: #333; margin-bottom: 30px; text-align: center;">Create Your Story</h2>
                
                <div class="form-group">
                    <label for="childName">Child's Name</label>
                    <input type="text" id="childName" placeholder="Enter your child's name" value="Maya">
                </div>

                <div class="form-group">
                    <label for="childAge">Age</label>
                    <select id="childAge">
                        <option value="4">4 years old</option>
                        <option value="5">5 years old</option>
                        <option value="6" selected>6 years old</option>
                        <option value="7">7 years old</option>
                        <option value="8">8 years old</option>
                        <option value="9">9 years old</option>
                        <option value="10">10 years old</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="storyTheme">Story Theme</label>
                    <select id="storyTheme">
                        <option value="garden" selected>🌻 Magical Garden</option>
                        <option value="space">🚀 Space Adventure</option>
                        <option value="ocean">🌊 Ocean Explorer</option>
                        <option value="forest">🌲 Enchanted Forest</option>
                        <option value="castle">🏰 Royal Adventure</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Character Appearance</label>
                    <div class="appearance-grid">
                        <div>
                            <label for="hairColor">Hair Color</label>
                            <select id="hairColor">
                                <option value="brown" selected>Brown</option>
                                <option value="blonde">Blonde</option>
                                <option value="black">Black</option>
                                <option value="red">Red</option>
                                <option value="auburn">Auburn</option>
                            </select>
                        </div>
                        <div>
                            <label for="hairStyle">Hair Style</label>
                            <select id="hairStyle">
                                <option value="curly" selected>Curly</option>
                                <option value="straight">Straight</option>
                                <option value="wavy">Wavy</option>
                                <option value="braided">Braided</option>
                                <option value="short">Short</option>
                            </select>
                        </div>
                        <div>
                            <label for="eyeColor">Eye Color</label>
                            <select id="eyeColor">
                                <option value="brown" selected>Brown</option>
                                <option value="blue">Blue</option>
                                <option value="green">Green</option>
                                <option value="hazel">Hazel</option>
                                <option value="gray">Gray</option>
                            </select>
                        </div>
                        <div>
                            <label for="skinTone">Skin Tone</label>
                            <select id="skinTone">
                                <option value="light">Light</option>
                                <option value="medium" selected>Medium</option>
                                <option value="tan">Tan</option>
                                <option value="dark">Dark</option>
                            </select>
                        </div>
                    </div>
                </div>

                <button class="generate-btn" onclick="generateAIStory()" id="generateBtn">
                    <div class="loading-spinner" id="loadingSpinner"></div>
                    <span id="btnText">🎨 Generate AI Story with Images!</span>
                </button>

                <div class="cost-info">
                    <h4>💰 Cost Breakdown</h4>
                    <p>• DALL-E 3: ~$0.04 per image</p>
                    <p>• Total per book: ~$0.20 (5 images)</p>
                    <p>• High-quality 1024x1024 images</p>
                </div>

                <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-top: 20px; border-left: 5px solid #2196f3;">
                    <h4 style="color: #1976d2; margin-bottom: 15px;">🚀 Production Implementation</h4>
                    <p style="color: #0d47a1; font-size: 0.95em; margin-bottom: 10px;">
                        <strong>Backend Server Required:</strong> OpenAI API calls must be made from a server due to CORS restrictions.
                    </p>
                    
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.85em; margin: 10px 0;">
<pre>// Node.js/Express example
app.post('/api/generate-image', async (req, res) => {
  const response = await openai.images.generate({
    model: "dall-e-3",
    prompt: req.body.prompt,
    size: "1024x1024"
  });
  res.json(response.data);
});</pre>
                    </div>
                    
                    <p style="color: #0d47a1; font-size: 0.9em;">
                        <strong>Platforms:</strong> Vercel, Netlify Functions, AWS Lambda, or any Node.js hosting
                    </p>
                </div>

                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>
            </div>

            <div class="preview-section">
                <h2 style="color: #333; margin-bottom: 20px; text-align: center;">AI Character Preview</h2>
                
                <div class="character-preview" id="characterPreview">
                    🌻
                </div>

                <div class="story-preview" id="storyPreview">
                    <div class="story-title">Your Personalized Adventure</div>
                    <p>Click "Generate AI Story" to create a personalized adventure with real AI-generated images where <span class="highlight">Maya</span> becomes the hero!</p>
                    
                    <p style="margin-top: 20px; color: #666; font-style: italic;">
                        🎨 Each page will have a custom AI illustration<br>
                        📖 Professional children's book quality<br>
                        👧 Character looks like your child<br>
                        ✨ Completely personalized story
                    </p>
                </div>

                <button class="generate-btn" onclick="viewAIBook()" id="viewBookBtn" style="margin-top: 20px; opacity: 0.5; cursor: not-allowed;" disabled>
                    📚 View AI Generated Book
                </button>
            </div>
        </div>
    </div>

    <!-- AI Book Viewer -->
    <div class="ai-book-viewer" id="aiBookViewer">
        <div class="book-container">
            <div class="book-header">
                <h2 id="bookTitle">📚 Your AI Generated Book</h2>
                <button class="close-book" onclick="closeAIBook()">&times;</button>
            </div>
            <div class="book-content" id="bookContent">
                <!-- AI generated pages will be inserted here -->
            </div>
            <div class="book-navigation">
                <button class="nav-btn" onclick="previousPage()" id="prevBtn" disabled>← Previous</button>
                <span class="page-indicator" id="pageIndicator">Page 1 of 5</span>
                <button class="nav-btn" onclick="nextPage()" id="nextBtn">Next →</button>
            </div>
        </div>
    </div>

    <script>
        // Story templates
        const storyTemplates = {
            garden: {
                title: "{name}'s Magical Garden",
                pages: [
                    {
                        title: "The Sad Garden",
                        text: "<span class='highlight'>{name}</span> loved visiting grandmother's magical garden. But today, all the beautiful flowers were drooping and sad, their bright colors fading away. 'Oh no!' said {name}, 'What happened to you, little flowers?'",
                        prompt: "{character} looking sadly at wilted drooping flowers in a garden, realistic garden background, children's book illustration"
                    },
                    {
                        title: "The Magic Discovery", 
                        text: "Grandma showed <span class='highlight'>{name}</span> a special silver watering can that sparkled with tiny stars. 'This is my magic watering can,' Grandma whispered. 'It only works for someone with a truly caring heart.'",
                        prompt: "{character} holding a beautiful silver magical watering can with glowing stars, inside a garden shed with sunbeams, magical sparkles, children's book illustration"
                    },
                    {
                        title: "The Magic Works!",
                        text: "<span class='highlight'>{name}</span> carefully watered the first sad flower. Immediately, it stood up tall and bright! 'It's working!' {name} laughed with joy, running around the garden bringing every flower back to life.",
                        prompt: "{character} joyfully watering flowers with magical watering can, sparkly water flowing, flowers blooming into vibrant colors, magical sparkles everywhere"
                    },
                    {
                        title: "Garden Celebration",
                        text: "The garden was now magnificent! <span class='highlight'>{name}</span> and grandmother sat together admiring their beautiful work. 'The real magic,' Grandma said, 'was in your caring heart and the love you gave to each flower.'",
                        prompt: "{character} and grandmother sitting happily together in a vibrant blooming garden, colorful flowers everywhere, butterflies flying around, heartwarming scene"
                    }
                ]
            },
            space: {
                title: "Commander {name}'s Space Mission",
                pages: [
                    {
                        title: "The Space Emergency",
                        text: "Commander <span class='highlight'>{name}</span> received an urgent message at Space Academy. A friendly alien planet needed help - their stars were going out! 'I'll help them!' declared brave Commander {name}.",
                        prompt: "{character} in a colorful space suit inside a futuristic space station, looking at a distress signal on screens, children's book illustration"
                    },
                    {
                        title: "Rocket Launch",
                        text: "<span class='highlight'>{name}</span> climbed into the shiny rocket ship. 'Countdown begins!' announced Mission Control. '3... 2... 1... Blast off!' The rocket zoomed into space with a trail of rainbow sparkles.",
                        prompt: "{character} inside a rocket cockpit, wearing space helmet, rocket launching into space with rainbow trail, planets visible, children's book illustration"
                    },
                    {
                        title: "Meeting the Aliens",
                        text: "On Planet Zephyr, <span class='highlight'>{name}</span> met the friendly blue aliens with silver wings. 'Our Star Crystal is broken,' they explained sadly. 'Without it, our planet will be dark forever.'",
                        prompt: "{character} in space suit meeting friendly blue aliens with silver wings on an alien planet, broken crystal visible, space background"
                    },
                    {
                        title: "Saving the Planet",
                        text: "Commander <span class='highlight'>{name}</span> used the special Star Repair Kit to fix the crystal. Suddenly, beautiful light filled the planet again! The grateful aliens celebrated with a cosmic dance party.",
                        prompt: "{character} celebrating with happy aliens around a glowing repaired crystal, beautiful cosmic lights filling the sky, celebration scene"
                    }
                ]
            }
        };

        let currentStory = null;
        let generatedImages = {};
        let currentBookPage = 1;

        async function generateImage(prompt, apiKey) {
            // Simulate API call delay for realistic experience
            await new Promise(resolve => setTimeout(resolve, 2000 + Math.random() * 1000));
            
            // Generate demo image based on prompt content
            return generateDemoImage(prompt);
        }

        async function generateDemoImage(prompt) {
            // Create a custom demo image based on the story theme and prompt
            const canvas = document.createElement('canvas');
            canvas.width = 400;
            canvas.height = 400;
            const ctx = canvas.getContext('2d');
            
            // Determine theme and colors based on prompt
            let bgGradient, emoji, bgColor1, bgColor2;
            
            if (prompt.includes('garden') || prompt.includes('flower')) {
                bgColor1 = '#a8e6cf';
                bgColor2 = '#dcedc1';
                emoji = '🌻';
            } else if (prompt.includes('space') || prompt.includes('rocket')) {
                bgColor1 = '#667eea';
                bgColor2 = '#764ba2';
                emoji = '🚀';
            } else if (prompt.includes('ocean') || prompt.includes('water')) {
                bgColor1 = '#74b9ff';
                bgColor2 = '#0984e3';
                emoji = '🌊';
            } else if (prompt.includes('forest') || prompt.includes('tree')) {
                bgColor1 = '#00b894';
                bgColor2 = '#00cec9';
                emoji = '🌲';
            } else if (prompt.includes('castle') || prompt.includes('royal')) {
                bgColor1 = '#fd79a8';
                bgColor2 = '#fdcb6e';
                emoji = '🏰';
            } else {
                bgColor1 = '#ffecd2';
                bgColor2 = '#fcb69f';
                emoji = '✨';
            }
            
            // Create gradient background
            const gradient = ctx.createLinearGradient(0, 0, 400, 400);
            gradient.addColorStop(0, bgColor1);
            gradient.addColorStop(1, bgColor2);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 400, 400);
            
            // Add character representation
            ctx.font = 'bold 60px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Add shadow
            ctx.shadowColor = 'rgba(0,0,0,0.3)';
            ctx.shadowBlur = 10;
            ctx.shadowOffsetX = 3;
            ctx.shadowOffsetY = 3;
            
            // Draw main emoji
            ctx.fillText(emoji, 200, 150);
            
            // Add child character representation
            const childName = document.getElementById('childName').value || 'Maya';
            const hairColor = document.getElementById('hairColor').value;
            const skinTone = document.getElementById('skinTone').value;
            
            // Child emoji based on characteristics
            let childEmoji = '👧';
            if (skinTone === 'dark') childEmoji = '👧🏾';
            else if (skinTone === 'medium') childEmoji = '👧🏽';
            else if (skinTone === 'tan') childEmoji = '👧🏽';
            else childEmoji = '👧🏻';
            
            ctx.fillText(childEmoji, 200, 250);
            
            // Add decorative elements
            ctx.font = 'bold 30px Arial';
            ctx.shadowBlur = 5;
            ctx.fillText('✨', 100, 100);
            ctx.fillText('⭐', 300, 120);
            ctx.fillText('💫', 320, 300);
            ctx.fillText('🌟', 80, 320);
            
            // Add child's name
            ctx.font = 'bold 24px Arial';
            ctx.fillStyle = 'white';
            ctx.strokeStyle = 'rgba(0,0,0,0.5)';
            ctx.lineWidth = 2;
            ctx.strokeText(childName, 200, 350);
            ctx.fillText(childName, 200, 350);
            
            // Convert to data URL
            return canvas.toDataURL('image/png');
        }

        function getCharacterDescription() {
            const name = document.getElementById('childName').value || 'Maya';
            const age = document.getElementById('childAge').value;
            const hairColor = document.getElementById('hairColor').value;
            const hairStyle = document.getElementById('hairStyle').value;
            const eyeColor = document.getElementById('eyeColor').value;
            const skinTone = document.getElementById('skinTone').value;

            return `A cute ${age}-year-old child named ${name} with ${hairColor} ${hairStyle} hair, ${eyeColor} eyes, and ${skinTone} skin tone`;
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successEl = document.getElementById('successMessage');
            successEl.textContent = message;
            successEl.style.display = 'block';
            setTimeout(() => {
                successEl.style.display = 'none';
            }, 3000);
        }

        async function generateAIStory() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                showError('Please enter your OpenAI API key first');
                return;
            }

            if (!apiKey.startsWith('sk-')) {
                showError('Invalid API key format. OpenAI keys start with "sk-"');
                return;
            }

            const name = document.getElementById('childName').value || 'Maya';
            const theme = document.getElementById('storyTheme').value;
            
            // Show loading state
            const btn = document.getElementById('generateBtn');
            const spinner = document.getElementById('loadingSpinner');
            const btnText = document.getElementById('btnText');
            
            btn.disabled = true;
            spinner.style.display = 'block';
            btnText.textContent = 'Generating AI Images...';

            try {
                const story = storyTemplates[theme];
                const characterDesc = getCharacterDescription();
                
                currentStory = {
                    title: story.title.replace('{name}', name),
                    pages: [],
                    characterDesc
                };

                // Generate character preview first
                const characterPrompt = `${characterDesc}, portrait style, smiling happily, children's book character illustration, high quality digital art`;
                
                try {
                    const characterImage = await generateImage(characterPrompt, apiKey);
                    document.getElementById('characterPreview').innerHTML = `<img src="${characterImage}" class="ai-generated-image" alt="Character preview">`;
                } catch (error) {
                    console.error('Character image generation failed:', error);
                }

                // Generate story pages
                for (let i = 0; i < story.pages.length; i++) {
                    btnText.textContent = `Generating image ${i + 1} of ${story.pages.length}...`;
                    
                    const page = story.pages[i];
                    const fullPrompt = page.prompt.replace('{character}', characterDesc);
                    
                    try {
                        const imageUrl = await generateImage(fullPrompt, apiKey);
                        
                        currentStory.pages.push({
                            title: page.title,
                            text: page.text.replace(/{name}/g, name),
                            image: imageUrl
                        });
                    } catch (error) {
                        console.error(`Failed to generate image for page ${i + 1}:`, error);
                        // Continue with other pages even if one fails
                        currentStory.pages.push({
                            title: page.title,
                            text: page.text.replace(/{name}/g, name),
                            image: null,
                            error: error.message
                        });
                    }
                }

                // Update preview
                document.getElementById('storyPreview').innerHTML = `
                    <div class="story-title">${currentStory.title}</div>
                    <p>✅ AI story generated successfully!</p>
                    <p><strong>${currentStory.pages.length}</strong> pages created with personalized images</p>
                    <p style="margin-top: 15px; color: #666; font-style: italic;">
                        🎨 Custom AI illustrations featuring ${name}<br>
                        📖 Complete personalized adventure story<br>
                        ✨ Ready to view and download!
                    </p>
                `;

                // Enable view book button
                const viewBtn = document.getElementById('viewBookBtn');
                viewBtn.disabled = false;
                viewBtn.style.opacity = '1';
                viewBtn.style.cursor = 'pointer';

                showSuccess('AI story generated successfully! Click "View AI Generated Book" to see your creation.');

            } catch (error) {
                console.error('Story generation failed:', error);
                showError(`Failed to generate story: ${error.message}`);
            } finally {
                // Reset button state
                btn.disabled = false;
                spinner.style.display = 'none';
                btnText.textContent = '🎨 Generate AI Story with Images!';
            }
        }

        function viewAIBook() {
            if (!currentStory) {
                showError('Please generate a story first');
                return;
            }

            const viewer = document.getElementById('aiBookViewer');
            const bookContent = document.getElementById('bookContent');
            const bookTitle = document.getElementById('bookTitle');

            bookTitle.textContent = `📚 ${currentStory.title}`;

            // Create book pages
            let pagesHTML = '';
            for (let i = 0; i < currentStory.pages.length; i++) {
                const page = currentStory.pages[i];
                const isActive = i === 0 ? 'active' : '';
                
                pagesHTML += `
                    <div class="book-page ${isActive}" id="bookPage${i + 1}">
                        <div class="page-layout">
                            <div class="image-container">
                                ${page.image ? 
                                    `<img src="${page.image}" class="generated-image" alt="${page.title}">` :
                                    `<div class="image-loading">
                                        <div style="font-size: 3em; margin-bottom: 15px;">❌</div>
                                        <p>Image generation failed</p>
                                        <p style="font-size: 0.9em; color: #999;">${page.error || 'Unknown error'}</p>
                                    </div>`
                                }
                            </div>
                            <div class="text-container">
                                <h2 class="page-title">${page.title}</h2>
                                <div class="page-text">${page.text}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            bookContent.innerHTML = pagesHTML;
            currentBookPage = 1;
            updateBookNavigation();
            viewer.style.display = 'flex';
        }

        function closeAIBook() {
            document.getElementById('aiBookViewer').style.display = 'none';
        }

        function nextPage() {
            if (currentBookPage < currentStory.pages.length) {
                document.getElementById(`bookPage${currentBookPage}`).classList.remove('active');
                currentBookPage++;
                document.getElementById(`bookPage${currentBookPage}`).classList.add('active');
                updateBookNavigation();
            }
        }

        function previousPage() {
            if (currentBookPage > 1) {
                document.getElementById(`bookPage${currentBookPage}`).classList.remove('active');
                currentBookPage--;
                document.getElementById(`bookPage${currentBookPage}`).classList.add('active');
                updateBookNavigation();
            }
        }

        function updateBookNavigation() {
            const totalPages = currentStory ? currentStory.pages.length : 1;
            document.getElementById('pageIndicator').textContent = `Page ${currentBookPage} of ${totalPages}`;
            document.getElementById('prevBtn').disabled = currentBookPage === 1;
            document.getElementById('nextBtn').disabled = currentBookPage === totalPages;
        }

        function toggleApiKeyVisibility() {
            const input = document.getElementById('apiKey');
            const button = document.querySelector('.toggle-visibility');
            
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = '🙈';
            } else {
                input.type = 'password';
                button.textContent = '👁️';
            }
        }

        // Auto-update character preview when inputs change
        document.addEventListener('change', function(e) {
            if (e.target.closest('.form-section')) {
                const theme = document.getElementById('storyTheme').value;
                const themeEmojis = {
                    garden: '🌻',
                    space: '🚀',
                    ocean: '🌊',
                    forest: '🌲',
                    castle: '🏰'
                };
                
                const preview = document.getElementById('characterPreview');
                if (!preview.querySelector('.ai-generated-image')) {
                    preview.textContent = themeEmojis[theme] || '🌻';
                }
            }
        });

        // Keyboard navigation for book viewer
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('aiBookViewer').style.display === 'flex') {
                if (e.key === 'ArrowRight' || e.key === ' ') {
                    e.preventDefault();
                    nextPage();
                } else if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    previousPage();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    closeAIBook();
                }
            }
        });
    </script>
</body>
</html>
