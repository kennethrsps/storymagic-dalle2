<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryMagic Pro - The Garden of Kindness</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 25px;
            box-shadow: 0 25px 70px rgba(0,0,0,0.4);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #ff6b6b, #ffa726, #4ecdc4);
            color: white;
            text-align: center;
            padding: 25px;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 800;
        }

        .header p {
            font-size: 1.3em;
            opacity: 0.95;
            font-weight: 500;
        }

        .main-content {
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 0;
            min-height: 900px;
        }

        .form-section {
            padding: 30px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-right: 3px solid #dee2e6;
        }

        .preview-section {
            padding: 20px;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.9em;
            font-family: inherit;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.2);
        }

        .form-group textarea {
            height: 60px;
            resize: vertical;
        }

        .photo-upload-section {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            border-left: 5px solid #4caf50;
            text-align: center;
        }

        .photo-upload-section h4 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-weight: 700;
            font-size: 1.1em;
        }

        .upload-area {
            border: 3px dashed #4caf50;
            border-radius: 12px;
            padding: 30px 20px;
            background: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .upload-area:hover {
            border-color: #2e7d32;
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #1b5e20;
            background: rgba(76, 175, 80, 0.1);
        }

        .upload-icon {
            font-size: 3em;
            color: #4caf50;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #2e7d32;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .upload-subtext {
            color: #388e3c;
            font-size: 0.85em;
        }

        .photo-preview {
            display: none;
            max-width: 150px;
            max-height: 150px;
            border-radius: 12px;
            margin: 15px auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .character-analysis {
            display: none;
            background: #fff3e0;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #ff9800;
        }

        .character-analysis h5 {
            color: #f57c00;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .character-analysis p {
            color: #ef6c00;
            font-size: 0.8em;
            margin: 5px 0;
        }

        .detail-section {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 5px solid #2196f3;
        }

        .detail-section h4 {
            color: #1976d2;
            margin-bottom: 10px;
            font-size: 1em;
            font-weight: 700;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .generate-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 18px 25px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            position: relative;
            overflow: hidden;
            margin-top: 15px;
            box-shadow: 0 8px 20px rgba(78, 205, 196, 0.3);
            transform: scale(1);
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 25px rgba(78, 205, 196, 0.4);
        }

        .generate-btn:disabled {
            opacity: 0.9;
            cursor: not-allowed;
            transform: scale(0.98);
        }

        .loading-spinner {
            display: none;
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translateY(-50%) rotate(0deg); }
            100% { transform: translateY(-50%) rotate(360deg); }
        }

        .book-display {
            display: none;
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            border: 3px solid #f0f0f0;
        }

        .book-image {
            width: 100%;
            height: 600px;
            object-fit: cover;
            background: #f8f9fa;
            border-bottom: 2px solid #eee;
        }

        .book-content {
            padding: 25px 35px 20px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }

        .book-title {
            font-size: 1.6em;
            color: #2c3e50;
            margin-bottom: 12px;
            font-weight: 700;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .book-text {
            font-size: 1.1em;
            line-height: 1.6;
            color: #495057;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 500;
            font-family: 'Georgia', serif;
        }

        .moral-lesson {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 5px solid #ffb74d;
            text-align: center;
        }

        .moral-lesson h5 {
            color: #e65100;
            margin-bottom: 5px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .moral-lesson p {
            color: #bf360c;
            font-size: 0.85em;
            font-style: italic;
            margin: 0;
        }

        .book-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 35px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 0 0 20px 20px;
        }

        .nav-btn {
            background: rgba(255,255,255,0.15);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .nav-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .page-indicator {
            font-weight: 700;
            color: white;
            font-size: 1.1em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .download-section {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: center;
            display: none;
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3);
        }

        .download-section h4 {
            font-size: 1.3em;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .download-section p {
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .download-btn {
            background: white;
            color: #28a745;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            margin: 8px;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .download-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .message {
            padding: 12px 15px;
            border-radius: 10px;
            margin-top: 12px;
            display: none;
            font-weight: 500;
            font-size: 0.9em;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }

        .default-preview {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }

        .default-preview h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2em;
            font-weight: 700;
        }

        .preview-placeholder {
            width: 280px;
            height: 280px;
            border-radius: 20px;
            background: linear-gradient(45deg, #ff9a9e, #fecfef, #ffecd2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 6em;
            margin: 30px auto;
            border: 5px solid white;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: float 4s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(2deg); }
        }

        #fileInput {
            display: none;
        }

        .remove-photo-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .remove-photo-btn:hover {
            background: #d32f2f;
            transform: translateY(-1px);
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 400px 1fr;
            }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 10px;
            }
            
            .book-image {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåª The Garden of Kindness</h1>
            <p>Create Your Child's Personalized Kindness Story</p>
        </div>

        <div class="main-content">
            <div class="form-section">
                <h2 style="color: #333; margin-bottom: 20px; text-align: center; font-weight: 700;">Create Your Story</h2>
                
                <div class="photo-upload-section">
                    <h4>üì∏ Upload Your Child's Photo</h4>
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                        <div class="upload-icon">üì∑</div>
                        <div class="upload-text">Click or drag photo here</div>
                        <div class="upload-subtext">JPG, PNG, or HEIC ‚Ä¢ Max 10MB</div>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" onchange="handleFileUpload(event)">
                    <img id="photoPreview" class="photo-preview" alt="Child's photo">
                    <button class="remove-photo-btn" id="removePhotoBtn" onclick="removePhoto()" style="display: none;">Remove Photo</button>
                    
                    <div class="character-analysis" id="characterAnalysis">
                        <h5>üé® AI Character Analysis</h5>
                        <p id="analysisText">Analyzing photo to create character...</p>
                    </div>
                </div>

                <div class="detail-section">
                    <h4>üë∂ Child Information</h4>
                    
                    <div class="form-group">
                        <label for="childName">Child's Name</label>
                        <input type="text" id="childName" placeholder="Enter child's name" value="Alex">
                    </div>

                    <div class="row">
                        <div class="form-group">
                            <label for="childAge">Age</label>
                            <select id="childAge">
                                <option value="3">3 years old</option>
                                <option value="4" selected>4 years old</option>
                                <option value="5">5 years old</option>
                                <option value="6">6 years old</option>
                                <option value="7">7 years old</option>
                                <option value="8">8 years old</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="childGender">Gender</label>
                            <select id="childGender">
                                <option value="girl">Girl</option>
                                <option value="boy" selected>Boy</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h4>üéØ Story Settings</h4>
                    
                    <div class="form-group">
                        <label for="childPersonality">Child's Personality</label>
                        <select id="childPersonality">
                            <option value="cheerful and outgoing" selected>Cheerful & Outgoing</option>
                            <option value="shy and thoughtful">Shy & Thoughtful</option>
                            <option value="brave and adventurous">Brave & Adventurous</option>
                            <option value="creative and artistic">Creative & Artistic</option>
                            <option value="kind and gentle">Kind & Gentle</option>
                            <option value="curious and smart">Curious & Smart</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="favoriteThings">Favorite Activities (Optional)</label>
                        <textarea id="favoriteThings" placeholder="e.g., loves flowers, plays with toys, helps others..."></textarea>
                    </div>
                </div>

                <button class="generate-btn" onclick="generateKindnessStory()" id="generateBtn">
                    <div class="loading-spinner" id="loadingSpinner"></div>
                    <span id="btnText">üåª Create Kindness Story!</span>
                </button>

                <div class="message success-message" id="successMessage"></div>
                <div class="message error-message" id="errorMessage"></div>
                
                <div class="download-section" id="downloadSection">
                    <h4>üìö Story Complete!</h4>
                    <p>Your child's kindness adventure is ready!</p>
                    <button class="download-btn" onclick="downloadStoryPDF()">üìÑ Download Story Book</button>
                </div>
            </div>

            <div class="preview-section">
                <div class="book-display" id="bookDisplay">
                    <img class="book-image" id="bookImage" alt="Story scene">
                    <div class="book-content">
                        <div class="book-title" id="bookTitle">Story Title</div>
                        <div class="book-text" id="bookText">Story content...</div>
                        <div class="moral-lesson" id="moralLesson">
                            <h5>üåª Kindness Lesson</h5>
                            <p>Life lesson will appear here</p>
                        </div>
                    </div>
                    <div class="book-navigation">
                        <button class="nav-btn" onclick="previousPage()" id="prevBtn">‚Üê Previous</button>
                        <span class="page-indicator" id="pageIndicator">Page 1 of 6</span>
                        <button class="nav-btn" onclick="nextPage()" id="nextBtn">Next ‚Üí</button>
                    </div>
                </div>

                <div class="default-preview" id="defaultPreview">
                    <div class="preview-placeholder">üåª</div>
                    <h3>The Garden of Kindness</h3>
                    <p style="font-size: 1.2em; line-height: 1.6; margin-bottom: 20px;">Upload your child's photo to create a beautiful personalized story about kindness!</p>
                    <p style="font-size: 1em; opacity: 0.8;">Watch your child become the hero of their own kindness adventure.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        let currentStoryData = {};
        let currentPage = 0;
        let uploadedPhoto = null;
        let characterDescription = '';

        // KINDNESS STORY TEMPLATE
        const kindnessStory = {
            title: "{name}'s Garden of Kindness",
            shortMoral: "Small acts of kindness create big changes",
            fullMoral: "This story teaches that even the smallest acts of kindness can transform not just others, but ourselves too. When we choose kindness, we plant seeds that grow into beautiful friendships and positive change in our community.",
            scenes: [
                {
                    title: "Meet {name}",
                    text: "Meet {name}, a {personality} {age}-year-old who loves to {favorite_things}. One sunny morning, {name} was playing outside when something caught {his_her} attention.",
                    setting: "Child's home front yard with a cozy house, green lawn, and sunny sky. The child is playing happily outside their house.",
                    prompt_template: "Children's book illustration of {character_description} playing happily in front of a cozy house with a green lawn and sunny sky. Whimsical, warm colors, friendly atmosphere."
                },
                {
                    title: "The Forgotten Garden",
                    text: "Walking down the street, {name} discovered an old, forgotten garden. Among the wilting flowers sat a sad elderly gardener who looked very lonely and discouraged.",
                    setting: "Old neglected garden with wilting flowers, overgrown weeds, and a sad elderly gardener sitting on a bench looking discouraged.",
                    prompt_template: "Children's book illustration showing {character_description} discovering an old, neglected garden with wilting flowers and weeds. An elderly gardener sits sadly on a bench. Muted colors showing sadness, but hope in the child's expression."
                },
                {
                    title: "A Kind Offer",
                    text: "Even though {name} felt a little {personality}, {his_her} heart filled with compassion. '{name} would like to help make your garden beautiful again,' {he_she} said with a gentle, caring smile.",
                    setting: "The same garden, with the child approaching the elderly gardener with a kind, caring expression, offering to help.",
                    prompt_template: "Children's book illustration of {character_description} approaching the elderly gardener with a kind, caring expression, offering help. The child shows compassion and determination. Warmer colors beginning to appear."
                },
                {
                    title: "Working Together",
                    text: "Side by side, {name} and the gardener planted new seeds, watered the flowers, and pulled weeds. They shared stories and laughter as they worked together to bring the garden back to life.",
                    setting: "The garden being restored, with the child and elderly gardener working together planting flowers, watering plants, and sharing happy moments.",
                    prompt_template: "Children's book illustration showing {character_description} and the elderly gardener working together in the garden, planting flowers and watering plants. Both are smiling and happy. Bright, cheerful colors as the garden comes alive."
                },
                {
                    title: "The Garden Blooms",
                    text: "As if by magic, the garden began to bloom in brilliant colors! Other children saw the beautiful transformation and came to help, creating a wonderful community garden full of friendship.",
                    setting: "The garden now blooming magnificently with bright flowers, multiple children helping, and a sense of community and joy.",
                    prompt_template: "Children's book illustration of a magnificent blooming garden with {character_description} and several other children working together. Bright, vibrant flowers everywhere, showing community and friendship. Joyful, celebration atmosphere."
                },
                {
                    title: "Seeds of Kindness",
                    text: "{name} learned that kindness is like planting seeds - it grows and spreads, creating beauty everywhere. The garden became a symbol of what happens when we care for others with open hearts.",
                    setting: "The completed beautiful community garden with children and families enjoying it, showing the lasting impact of kindness.",
                    prompt_template: "Children's book illustration showing {character_description} in the beautiful, thriving community garden surrounded by families and children enjoying the space. Golden sunset light, showing the lasting beauty created by kindness."
                }
            ]
        };

        // FILE UPLOAD HANDLING
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 10 * 1024 * 1024) {
                showError('Photo must be smaller than 10MB');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedPhoto = e.target.result;
                document.getElementById('photoPreview').src = uploadedPhoto;
                document.getElementById('photoPreview').style.display = 'block';
                document.getElementById('removePhotoBtn').style.display = 'block';
                
                // Show analysis section
                document.getElementById('characterAnalysis').style.display = 'block';
                analyzePhoto(uploadedPhoto);
            };
            reader.readAsDataURL(file);
        }

        function removePhoto() {
            uploadedPhoto = null;
            characterDescription = '';
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('removePhotoBtn').style.display = 'none';
            document.getElementById('characterAnalysis').style.display = 'none';
            document.getElementById('fileInput').value = '';
        }

        // DRAG AND DROP
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('fileInput').files = files;
                handleFileUpload({ target: { files: files } });
            }
        });

        // PHOTO ANALYSIS WITH GPT-4 VISION
        async function analyzePhoto(photoData) {
            document.getElementById('analysisText').textContent = 'Analyzing photo features...';
            
            try {
                const response = await fetch('/api/analyze-photo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        image: photoData,
                        age: document.getElementById('childAge').value,
                        gender: document.getElementById('childGender').value
                    })
                });

                if (response.ok) {
                    const analysis = await response.json();
                    characterDescription = analysis.character_description;
                    
                    // Auto-populate form fields if detected
                    if (analysis.hair_color) updateFormField('hairColor', analysis.hair_color);
                    if (analysis.eye_color) updateFormField('eyeColor', analysis.eye_color);
                    if (analysis.skin_tone) updateFormField('skinTone', analysis.skin_tone);
                    
                    document.getElementById('analysisText').innerHTML = `
                        <strong>Character Features Detected:</strong><br>
                        ${analysis.description || 'Ready to create character!'}
                    `;
                } else {
                    throw new Error('Analysis failed');
                }
            } catch (error) {
                console.log('Photo analysis failed, using manual input:', error);
                document.getElementById('analysisText').textContent = 'Using manual character details for story creation.';
                characterDescription = createManualCharacterDescription();
            }
        }

        function updateFormField(fieldId, value) {
            const field = document.getElementById(fieldId);
            if (field && field.tagName === 'SELECT') {
                for (let option of field.options) {
                    if (option.value.includes(value.toLowerCase()) || option.text.toLowerCase().includes(value.toLowerCase())) {
                        field.value = option.value;
                        break;
                    }
                }
            }
        }

        function createManualCharacterDescription() {
            const name = document.getElementById('childName').value.trim() || 'Alex';
            const age = document.getElementById('childAge').value;
            const gender = document.getElementById('childGender').value;
            const personality = document.getElementById('childPersonality').value;
            
            return `A ${age}-year-old ${gender} named ${name} who is ${personality}. The child has a friendly, warm expression and is dressed in casual, colorful clothing appropriate for a children's book illustration.`;
        }

        // STORY GENERATION
        async function generateKindnessStory() {
            const name = document.getElementById('childName').value.trim() || 'Alex';
            
            if (!name) {
                showError('Please enter the child\'s name!');
                return;
            }

            const btn = document.getElementById('generateBtn');
            const spinner = document.getElementById('loadingSpinner');
            const btnText = document.getElementById('btnText');
            
            btn.disabled = true;
            btn.style.background = 'linear-gradient(45deg, #ffa726, #ff9800)';
            spinner.style.display = 'block';
            btnText.textContent = `üå± Creating ${name}'s Story...`;

            hideMessages();
            showSuccess(`üé® Creating "${name}'s Garden of Kindness"...`);

            try {
                const personality = document.getElementById('childPersonality').value;
                const favoriteThings = document.getElementById('favoriteThings').value.trim() || 'helping others and playing outside';
                const age = document.getElementById('childAge').value;
                const gender = document.getElementById('childGender').value;

                // Use photo analysis or create manual description
                if (!characterDescription) {
                    characterDescription = createManualCharacterDescription();
                }

                // Generate master character portrait first
                btnText.textContent = `üé® Creating ${name}'s Character...`;
                showSuccess(`üë®‚Äçüé® Generating character portrait...`);

                let masterCharacterImage = null;
                try {
                    const characterResponse = await fetch('/api/generate-image', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            prompt: `Portrait of ${characterDescription}. Children's book illustration style, friendly and warm, high quality character design.`,
                            size: "1024x1024",
                            quality: "hd",
                            style: "vivid"
                        })
                    });

                    if (characterResponse.ok) {
                        const characterData = await characterResponse.json();
                        masterCharacterImage = characterData.url || characterData.data?.[0]?.url || characterData.image_url;
                        showSuccess(`‚úÖ Character portrait created!`);
                    }
                } catch (error) {
                    console.log('Character portrait generation failed, proceeding with scenes');
                }

                // Generate all 6 scene images
                const sceneImages = [];
                for (let i = 0; i < kindnessStory.scenes.length; i++) {
                    const scene = kindnessStory.scenes[i];
                    btnText.textContent = `üé® Creating Scene ${i + 1}/6...`;
                    showSuccess(`üé¨ Generating "${scene.title.replace('{name}', name)}"...`);
                    
                    try {
                        const prompt = scene.prompt_template.replace('{character_description}', characterDescription);
                        
                        const response = await fetch('/api/generate-image', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                prompt: prompt,
                                size: "1024x1024",
                                quality: "hd",
                                style: "vivid"
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            const imageUrl = data.url || data.data?.[0]?.url || data.image_url;
                            if (imageUrl) {
                                sceneImages.push(imageUrl);
                                showSuccess(`‚úÖ Scene ${i + 1} complete!`);
                            } else {
                                throw new Error('No image URL');
                            }
                        } else {
                            throw new Error('DALL-E failed');
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                    } catch (error) {
                        console.log(`Scene ${i + 1} using fallback:`, error.message);
                        sceneImages.push(createFallbackScene(name, i));
                        showSuccess(`üé® Scene ${i + 1}: Using backup illustration`);
                        await new Promise(resolve => setTimeout(resolve, 400));
                    }
                }

                // Assemble final story
                btnText.textContent = `üìñ Assembling Story...`;
                showSuccess(`üéâ Finalizing ${name}'s kindness adventure...`);
                
                currentStoryData = {
                    name, age, gender, personality, favoriteThings,
                    title: personalizeText(kindnessStory.title, name, gender),
                    shortMoral: kindnessStory.shortMoral,
                    fullMoral: kindnessStory.fullMoral,
                    pages: kindnessStory.scenes.map((scene, index) => ({
                        title: personalizeText(scene.title, name, gender),
                        text: personalizeAdvancedText(scene.text, name, gender, personality, favoriteThings),
                        imageUrl: sceneImages[index]
                    }))
                };

                currentPage = 0;
                displayStory();
                
                btnText.textContent = `‚úÖ ${name}'s Story Ready!`;
                showSuccess(`üéâ "${currentStoryData.title}" is complete! Navigate through all pages.`);

            } catch (error) {
                console.error('Generation error:', error);
                showError(`Failed to create story: ${error.message}`);
                btnText.textContent = 'üåª Create Kindness Story!';
                btn.style.background = 'linear-gradient(45deg, #4ecdc4, #44a08d)';
            } finally {
                setTimeout(() => {
                    btn.disabled = false;
                    spinner.style.display = 'none';
                    btnText.textContent = 'üåª Create Kindness Story!';
                    btn.style.background = 'linear-gradient(45deg, #4ecdc4, #44a08d)';
                }, 2000);
            }
        }

        function personalizeText(text, name, gender) {
            const pronouns = gender === 'girl' 
                ? { his_her: 'her', him_her: 'her', he_she: 'she', He_She: 'She' }
                : { his_her: 'his', him_her: 'him', he_she: 'he', He_She: 'He' };
            
            return text
                .replace(/{name}/g, name)
                .replace(/{his_her}/g, pronouns.his_her)
                .replace(/{him_her}/g, pronouns.him_her)
                .replace(/{he_she}/g, pronouns.he_she)
                .replace(/{He_She}/g, pronouns.He_She);
        }

        function personalizeAdvancedText(text, name, gender, personality, favoriteThings) {
            const pronouns = gender === 'girl' 
                ? { his_her: 'her', him_her: 'her', he_she: 'she', He_She: 'She' }
                : { his_her: 'his', him_her: 'him', he_she: 'he', He_She: 'He' };
            
            return text
                .replace(/{name}/g, name)
                .replace(/{his_her}/g, pronouns.his_her)
                .replace(/{him_her}/g, pronouns.him_her)
                .replace(/{he_she}/g, pronouns.he_she)
                .replace(/{He_She}/g, pronouns.He_She)
                .replace(/{personality}/g, personality)
                .replace(/{favorite_things}/g, favoriteThings)
                .replace(/{age}/g, document.getElementById('childAge').value);
        }

        function createFallbackScene(name, sceneIndex) {
            const canvas = document.createElement('canvas');
            canvas.width = 1024;
            canvas.height = 1024;
            const ctx = canvas.getContext('2d');

            // Scene-specific backgrounds
            const sceneColors = [
                ['#87CEEB', '#98FB98'], // Introduction - sky blue to light green
                ['#D3D3D3', '#F0E68C'], // Garden discovery - gray to khaki  
                ['#FFE4E1', '#FFA07A'], // Offering help - misty rose to light salmon
                ['#90EE90', '#32CD32'], // Working together - light green to lime green
                ['#FF69B4', '#FFB6C1'], // Garden blooms - hot pink to light pink
                ['#FFD700', '#FFA500']  // Lesson learned - gold to orange
            ];

            const colors = sceneColors[sceneIndex] || sceneColors[0];
            
            const gradient = ctx.createLinearGradient(0, 0, 1024, 1024);
            gradient.addColorStop(0, colors[0]);
            gradient.addColorStop(1, colors[1]);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 1024, 1024);

            // Add scene elements
            const sceneTexts = [
                `${name} at Home`,
                'The Forgotten Garden',
                'Offering Kindness',
                'Working Together', 
                'Garden Blooms',
                'Kindness Grows'
            ];

            // Text
            ctx.fillStyle = '#FFFFFF';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 3;
            ctx.font = 'bold 48px Georgia';
            ctx.textAlign = 'center';
            ctx.strokeText(sceneTexts[sceneIndex], 512, 512);
            ctx.fillText(sceneTexts[sceneIndex], 512, 512);

            // Character representation
            ctx.fillStyle = '#FF69B4';
            ctx.beginPath();
            ctx.arc(512, 300, 80, 0, 2 * Math.PI);
            ctx.fill();

            return canvas.toDataURL('image/png');
        }

        function displayStory() {
            document.getElementById('defaultPreview').style.display = 'none';
            document.getElementById('bookDisplay').style.display = 'block';
            document.getElementById('downloadSection').style.display = 'block';
            updatePage();
        }

        function updatePage() {
            const image = document.getElementById('bookImage');
            const title = document.getElementById('bookTitle');
            const text = document.getElementById('bookText');
            const moral = document.getElementById('moralLesson');
            const indicator = document.getElementById('pageIndicator');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            const currentPageData = currentStoryData.pages[currentPage];
            
            image.src = currentPageData.imageUrl;
            title.textContent = currentStoryData.title;
            text.textContent = currentPageData.text;
            
            if (currentPage === currentStoryData.pages.length - 1) {
                moral.style.display = 'block';
                moral.innerHTML = `<h5>üåª Kindness Lesson</h5><p>${currentStoryData.fullMoral}</p>`;
            } else {
                moral.style.display = 'none';
            }
            
            indicator.textContent = `Page ${currentPage + 1} of ${currentStoryData.pages.length}`;
            
            prevBtn.disabled = currentPage === 0;
            nextBtn.disabled = currentPage === currentStoryData.pages.length - 1;
        }

        function previousPage() {
            if (currentPage > 0) {
                currentPage--;
                updatePage();
            }
        }

        function nextPage() {
            if (currentPage < currentStoryData.pages.length - 1) {
                currentPage++;
                updatePage();
            }
        }

        async function downloadStoryPDF() {
            if (!currentStoryData.title) {
                alert('Please generate a story first!');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');

                // Cover page
                pdf.setFillColor(25, 25, 112);
                pdf.rect(0, 0, 210, 297, 'F');
                
                pdf.setTextColor(255, 215, 0);
                pdf.setFontSize(28);
                pdf.setFont(undefined, 'bold');
                pdf.text(currentStoryData.title, 105, 50, { align: 'center' });
                
                pdf.setFontSize(16);
                pdf.setTextColor(255, 255, 255);
                pdf.text(`A Story About Kindness`, 105, 70, { align: 'center' });

                // Story pages
                currentStoryData.pages.forEach((page, index) => {
                    pdf.addPage();
                    
                    pdf.setFillColor(250, 250, 255);
                    pdf.rect(0, 0, 210, 297, 'F');
                    
                    pdf.setFillColor(25, 25, 112);
                    pdf.rect(0, 0, 210, 25, 'F');
                    pdf.setTextColor(255, 255, 255);
                    pdf.setFontSize(14);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(page.title, 105, 17, { align: 'center' });
                    
                    try {
                        pdf.addImage(page.imageUrl, 'PNG', 15, 35, 180, 140);
                    } catch (e) {
                        pdf.setFillColor(220, 220, 220);
                        pdf.rect(15, 35, 180, 140, 'F');
                    }
                    
                    pdf.setFillColor(255, 255, 255);
                    pdf.rect(20, 185, 170, 70, 'F');
                    pdf.setDrawColor(25, 25, 112);
                    pdf.setLineWidth(2);
                    pdf.rect(20, 185, 170, 70, 'S');
                    
                    pdf.setTextColor(50, 50, 50);
                    pdf.setFontSize(11);
                    pdf.setFont(undefined, 'normal');
                    const lines = pdf.splitTextToSize(page.text, 150);
                    let yPos = 200;
                    lines.forEach(line => {
                        if (yPos < 245) {
                            pdf.text(line, 105, yPos, { align: 'center' });
                            yPos += 7;
                        }
                    });
                });

                pdf.save(`${currentStoryData.name}_Garden_of_Kindness.pdf`);
                alert('üåª Your kindness story has been downloaded!');
                
            } catch (error) {
                console.error('PDF error:', error);
                alert('‚ùå Failed to create PDF. Please try again.');
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        function showSuccess(message) {
            const successEl = document.getElementById('successMessage');
            successEl.textContent = message;
            successEl.style.display = 'block';
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        console.log("Kindness Story Generator loaded successfully!");
    </script>
</body>
</html>
