<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryMagic Pro - Visual Story Books</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        function createDomCharacter(ctx, canvas, theme) {
            const width = canvas.width;
            const height = canvas.height;
            
            // Theme-specific backgrounds for high quality
            const backgrounds = {
                garden: { start: '#87CEEB', end: '#90EE90', accent: '#FFB6C1' },
                space: { start: '#191970', end: '#4B0082', accent: '#FFD700' },
                ocean: { start: '#00CED1', end: '#1E90FF', accent: '#FF7F50' },
                castle: { start: '#DDA0DD', end: '#9370DB', accent: '#FFD700' },
                pirate: { start: '#8B4513', end: '#CD853F', accent: '#FFD700' }
            };
            
            const bg = backgrounds[theme] || backgrounds.garden;
            
            // High-quality background gradient
            const gradient = ctx.createLinearGradient(0, 0, width, height);
            gradient.addColorStop(0, bg.start);
            gradient.addColorStop(1, bg.end);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);
            
            // Dom's character (4-year-old girl with black hair, brown eyes) - Higher resolution
            const centerX = width / 2;
            const centerY = height / 2;
            const scale = width / 512; // Scale for higher resolution
            
            // Head (bigger for 4-year-old proportions)
            ctx.fillStyle = '#F4C2A1'; // Realistic skin tone
            ctx.beginPath();
            ctx.arc(centerX, centerY - 50 * scale, 80 * scale, 0, 2 * Math.PI);
            ctx.fill();
            
            // Add subtle head shading
            const headGradient = ctx.createRadialGradient(
                centerX - 20 * scale, centerY - 70 * scale, 0,
                centerX, centerY - 50 * scale, 80 * scale
            );
            headGradient.addColorStop(0, '#F8D7A1');
            headGradient.addColorStop(1, '#E8B888');
            ctx.fillStyle = headGradient;
            ctx.beginPath();
            ctx.arc(centerX, centerY - 50 * scale, 80 * scale, 0, 2 * Math.PI);
            ctx.fill();
            
            // Beautiful black hair (shoulder-length, realistic)
            ctx.fillStyle = '#1C1C1C'; // Natural black hair
            ctx.beginPath();
            ctx.arc(centerX, centerY - 90 * scale, 90 * scale, 0, Math.PI);
            ctx.fill();
            
            // Hair sides for shoulder-length
            ctx.beginPath();
            ctx.ellipse(centerX - 65 * scale, centerY - 20 * scale, 35 * scale, 45 * scale, 0, 0, 2 * Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(centerX + 65 * scale, centerY - 20 * scale, 35 * scale, 45 * scale, 0, 0, 2 * Math.PI);
            ctx.fill();
            
            // Hair highlights
            ctx.fillStyle = '#2C2C2C';
            ctx.beginPath();
            ctx.arc(centerX - 30 * scale, centerY - 85 * scale, 15 * scale, 0, 2 * Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(centerX + 20 * scale, centerY - 90 * scale, 12 * scale, 0, 2 * Math.PI);
            ctx.fill();
            
            // Warm brown eyes (detailed)
            ctx.fillStyle = '#8B4513'; // Brown iris
            ctx.beginPath();
            ctx.arc(centerX - 25 * scale, centerY - 65 * scale, 12 * scale, 0, 2 * Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(centerX + 25 * scale, centerY - 65 * scale, 12 * scale, 0, 2 * Math.PI);
            ctx.fill();
            
            // Eye pupils
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(centerX - 25 * scale, centerY - 65 * scale, 6 * scale, 0, 2 * Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(centerX + 25 * scale, centerY - 65 * scale, 6 * scale, 0, 2 * Math.PI);
            ctx.fill();
            
            // Eye highlights (sparkle)
            ctx.fillStyle = '#FFFFFF';
            ctx.beginPath();
            ctx.arc(centerX - 22 * scale, centerY - 68 * scale, 4 * scale, 0, 2 * Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(centerX + 28 * scale, centerY - 68 * scale, 4 * scale, 0, 2 * Math.PI);
            ctx.fill();
            
            // Eyelashes
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2 * scale;
            for (let i = 0; i < 3; i++) {
                const offsetX = (i - 1) * 8 * scale;
                ctx.beginPath();
                ctx.moveTo(centerX - 25 * scale + offsetX, centerY - 77 * scale);
                ctx.lineTo(centerX - 25 * scale + offsetX, centerY - 82 * scale);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(centerX + 25 * scale + offsetX, centerY - 77 * scale);
                ctx.lineTo(centerX + 25 * scale + offsetX, centerY - 82 * scale);
                ctx.stroke();
            }
            
            // Rosy cheeks (4-year-old feature)
            ctx.fillStyle = '#FFB6C1';
            ctx.globalAlpha = 0.6;
            ctx.beginPath();
            ctx.arc(centerX - 50 * scale, centerY - 35 * scale, 18 * scale, 0, 2 * Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(centerX + 50 * scale, centerY - 35 * scale, 18 * scale, 0, 2 * Math.PI);
            ctx.fill();
            ctx.globalAlpha = 1.0;
            
            // Bright cheerful smile
            ctx.strokeStyle = '#D2691E';
            ctx.lineWidth = 4 * scale;
            ctx.beginPath();
            ctx.arc(centerX, centerY - 25 * scale, 20 * scale, 0, Math.PI);
            ctx.stroke();
            
            // Theme-appropriate outfit
            const outfitColors = {
                garden: '#FF69B4', // Pink dress
                space: '#9370DB',  // Purple space suit
                ocean: '#00CED1',  // Cyan swimwear
                castle: '#DDA0DD', // Lavender princess dress
                pirate: '#8B4513'  // Brown pirate outfit
            };
            
            ctx.fillStyle = outfitColors[theme] || outfitColors.garden;
            ctx.beginPath();
            ctx.arc(centerX, centerY + 60 * scale, 100 * scale, 0, Math.PI);
            ctx.fill();
            
            // Arms
            ctx.fillStyle = '#F4C2A1';
            ctx.beginPath();
            ctx.arc(centerX - 80 * scale, centerY + 30 * scale, 25 * scale, 0, 2 * Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(centerX + 80 * scale, centerY + 30 * scale, 25 * scale, 0, 2 * Math.PI);
            ctx.fill();
            
            // Name label (professional)
            ctx.fillStyle = '#FFFFFF';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 3 * scale;
            ctx.font = `bold ${32 * scale}px Comic Sans MS`;
            ctx.textAlign = 'center';
            ctx.strokeText('Dom', centerX, height - 80 * scale);
            ctx.fillText('Dom', centerX, height - 80 * scale);
            
            return canvas.toDataURL('image/png');
        }

        function createGenericCharacter(ctx, canvas, name, theme) {
            // Similar structure but more generic for other children
            const width = canvas.width;
            const height = canvas.height;
            
            // Simplified version for non-Dom characters
            const gradient = ctx.createLinearGradient(0, 0, width, height);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(1, '#98FB98');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);
            
            const centerX = width / 2;
            const centerY = height / 2;
            
            // Generic character
            ctx.fillStyle = '#F4C2A1';
            ctx.beginPath();
            ctx.arc(centerX, centerY - 50, 50, 0, 2 * Math.PI);
            ctx.fill();
            
            // Hair
            ctx.fillStyle = '#8B4513';
            ctx.beginPath();
            ctx.arc(centerX, centerY - 70, 60, 0, Math.PI);
            ctx.fill();
            
            // Eyes
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(centerX - 15, centerY - 60, 5, 0, 2 * Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(centerX + 15, centerY - 60, 5, 0, 2 * Math.PI);
            ctx.fill();
            
            // Smile
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(centerX, centerY - 40, 12, 0, Math.PI);
            ctx.stroke();
            
            // Body
            ctx.fillStyle = '#FF69B4';
            ctx.fillRect(centerX - 40, centerY, 80, 80);
            
            // Name
            ctx.fillStyle = '#4B0082';
            ctx.font = 'bold 20px Comic Sans MS';
            ctx.textAlign = 'center';
            ctx.fillText(name, centerX, height - 50);
            
            return canvas.toDataURL('image/png');

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
            color: white;
            text-align: center;
            padding: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 600px;
        }

        .form-section {
            padding: 40px;
            background: #f8f9fa;
        }

        .preview-section {
            padding: 40px;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        .generate-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .generate-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .loading-spinner {
            display: none;
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translateY(-50%) rotate(0deg); }
            100% { transform: translateY(-50%) rotate(360deg); }
        }

        .story-book {
            display: none;
            width: 100%;
            height: 500px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .story-page {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .story-overlay {
            background: rgba(0,0,0,0.4);
            color: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 80%;
            text-align: center;
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255,255,255,0.3);
        }

        .story-title {
            font-size: 2em;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .story-text {
            font-size: 1.1em;
            line-height: 1.6;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .character-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto 20px;
            background: linear-gradient(45deg, #ff9a9e, #fecfef);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4em;
            border: 5px solid white;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 5px solid #f44336;
            display: none;
        }

        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 5px solid #4caf50;
            display: none;
        }

        .download-section {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }

        .download-btn {
            background: white;
            color: #28a745;
            border: none;
            padding: 12px 25px;
            border-radius: 20px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .page-navigation {
            display: none;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        .nav-btn {
            background: #4ecdc4;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            margin: 0 5px;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #44a08d;
            transform: translateY(-1px);
        }

        .nav-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .page-indicator {
            margin: 10px 0;
            font-weight: bold;
            color: #333;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé® StoryMagic Pro</h1>
            <p>Create Visual Story Books with AI Characters</p>
        </div>

        <div class="main-content">
            <div class="form-section">
                <h2 style="color: #333; margin-bottom: 30px; text-align: center;">Create Your Story</h2>
                
                <div class="form-group">
                    <label for="childName">Child's Name</label>
                    <input type="text" id="childName" placeholder="Enter your child's name" value="Dom">
                </div>

                <div class="form-group">
                    <label for="childAge">Age</label>
                    <select id="childAge">
                        <option value="3">3 years old</option>
                        <option value="4" selected>4 years old</option>
                        <option value="5">5 years old</option>
                        <option value="6">6 years old</option>
                        <option value="7">7 years old</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="storyTheme">Choose Your Adventure</label>
                    <select id="storyTheme">
                        <option value="garden">üåª Dom's Magic Garden</option>
                        <option value="space">üöÄ Dom Goes to Space</option>
                        <option value="ocean">üåä Dom's Ocean Adventure</option>
                        <option value="castle">üè∞ Dom the Brave Knight</option>
                        <option value="pirate">üè¥‚Äç‚ò†Ô∏è Captain Dom's Treasure</option>
                    </select>
                </div>

                <button class="generate-btn" onclick="generateStory()" id="generateBtn">
                    <div class="loading-spinner" id="loadingSpinner"></div>
                    <span id="btnText">üé® Create Dom's Story!</span>
                </button>

                <div class="success-message" id="successMessage"></div>
                <div class="error-message" id="errorMessage"></div>
                
                <div class="download-section" id="downloadSection">
                    <h4>üìö Your Story Book is Ready!</h4>
                    <p>Download Dom's personalized story with beautiful visuals</p>
                    <button class="download-btn" onclick="downloadPDF()">üìÑ Download PDF Story Book</button>
                </div>
            </div>

            <div class="preview-section">
                <div class="character-preview" id="characterPreview">
                    üåª
                </div>

                <div class="story-book" id="storyBook">
                    <div class="story-page" id="storyPage">
                        <div class="story-overlay">
                            <div class="story-title" id="storyTitle">Dom's Adventure</div>
                            <div class="story-text" id="storyText">Your story will appear here...</div>
                        </div>
                    </div>
                </div>

                <div class="page-navigation" id="pageNavigation">
                    <button class="nav-btn" onclick="previousPage()" id="prevBtn">‚Üê Previous</button>
                    <span class="page-indicator" id="pageIndicator">Page 1 of 5</span>
                    <button class="nav-btn" onclick="nextPage()" id="nextBtn">Next ‚Üí</button>
                </div>

                <div id="defaultPreview" style="text-align: center;">
                    <h3 style="color: #333; margin-bottom: 15px;">üé® Story Preview</h3>
                    <p style="color: #666;">Generate Dom's story to see the magic happen!</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        let currentStoryData = {};
        let currentPage = 0;

        const stories = {
            garden: {
                title: "Dom's Magic Garden",
                pages: [
                    "Dom found a sad garden with wilting flowers.",
                    "Dom watered the flowers every day with care.",
                    "The flowers started to smile and grow tall!",
                    "Dom made friends with talking butterflies.",
                    "Dom learned that caring makes magic happen!"
                ],
                prompt: "A beautiful 4-year-old girl with shoulder-length black hair and warm brown eyes, in a magical garden with colorful flowers and butterflies, children's book illustration, bright and cheerful, detailed character features"
            },
            space: {
                title: "Dom Goes to Space",
                pages: [
                    "Dom put on a shiny space suit for adventure.",
                    "Dom's rocket zoomed up to the twinkling stars!",
                    "Dom met friendly aliens who said 'Hello!'",
                    "Dom and the aliens played fun space games.",
                    "Dom learned that friends are everywhere!"
                ],
                prompt: "A cheerful 4-year-old girl with shoulder-length black hair and warm brown eyes, in a colorful space suit floating with friendly aliens among stars and planets, children's book illustration, cosmic and fun, detailed character"
            },
            ocean: {
                title: "Dom's Ocean Adventure",
                pages: [
                    "Dom dove into the beautiful blue ocean.",
                    "Dom found a little fish who was lost and sad.",
                    "Dom helped the fish find her way back home.",
                    "All the sea creatures thanked Dom with hugs!",
                    "Dom learned that helping others feels wonderful!"
                ],
                prompt: "A joyful 4-year-old girl with shoulder-length black hair and warm brown eyes, swimming underwater with colorful fish and sea creatures in a bright coral reef, children's book illustration, underwater adventure, detailed character"
            },
            castle: {
                title: "Dom the Brave Knight",
                pages: [
                    "Knight Dom put on her shiny armor to help.",
                    "Dom met a lonely dragon who felt very sad.",
                    "Dom offered friendship instead of fighting.",
                    "The dragon smiled and they became best friends!",
                    "Dom learned that kindness is true bravery!"
                ],
                prompt: "A brave 4-year-old girl with shoulder-length black hair and warm brown eyes, in knight armor with a friendly smiling dragon in front of a colorful castle, children's book illustration, medieval and heartwarming, detailed character"
            },
            pirate: {
                title: "Captain Dom's Treasure",
                pages: [
                    "Captain Dom sailed the seas looking for treasure.",
                    "Dom found a treasure map with a big X!",
                    "Dom discovered hungry pirates on the island.",
                    "Dom shared her treasure food with everyone.",
                    "Dom learned that sharing is the best treasure!"
                ],
                prompt: "A happy 4-year-old girl with shoulder-length black hair and warm brown eyes, as a pirate captain on a colorful ship with treasure chests and friendly pirates, children's book illustration, adventure and friendship, detailed character"
            }
        };

        async function generateStory() {
            const name = document.getElementById('childName').value || 'Dom';
            const theme = document.getElementById('storyTheme').value;
            
            const btn = document.getElementById('generateBtn');
            const spinner = document.getElementById('loadingSpinner');
            const btnText = document.getElementById('btnText');
            
            btn.disabled = true;
            spinner.style.display = 'block';
            btnText.textContent = 'Creating Dom\'s Story...';

            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';

            try {
                const story = stories[theme];
                
                // Create detailed character prompt for Dom (4-year-old girl with black hair, brown eyes)
                let characterPrompt;
                if (name.toLowerCase() === 'dom') {
                    characterPrompt = `A beautiful 4-year-old girl named Dom with shoulder-length black hair, warm brown eyes, rosy cheeks, and a bright cheerful smile. She has an innocent round face typical of a 4-year-old. ${story.prompt.split(',').slice(1).join(',')}`;
                } else {
                    characterPrompt = story.prompt.replace(/Dom/g, name);
                }
                
                let imageUrl;
                
                // Call your existing DALL-E integration
                try {
                    const response = await fetch('/api/generate-image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            prompt: characterPrompt,
                            size: "1024x1024",
                            quality: "standard",
                            style: "vivid"
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        // Handle different possible response formats from DALL-E
                        imageUrl = data.url || data.data?.[0]?.url || data.image_url;
                        
                        if (!imageUrl) {
                            throw new Error('No image URL in response');
                        }
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `API Error: ${response.status}`);
                    }
                } catch (aiError) {
                    console.log('DALL-E generation failed, using custom character for Dom:', aiError);
                    showError(`AI generation failed: ${aiError.message}. Using custom character.`);
                    
                    // Create detailed custom character for Dom as fallback
                    const canvas = document.createElement('canvas');
                    canvas.width = 1024;
                    canvas.height = 1024;
                    const ctx = canvas.getContext('2d');
                    
                    if (name.toLowerCase() === 'dom') {
                        imageUrl = createDomCharacter(ctx, canvas, theme);
                    } else {
                        imageUrl = createGenericCharacter(ctx, canvas, name, theme);
                    }
                }

                // Store for PDF and navigation
                currentStoryData = {
                    imageUrl: imageUrl,
                    title: story.title.replace(/Dom/g, name),
                    pages: story.pages.map(page => page.replace(/Dom/g, name)),
                    name: name,
                    theme: theme
                };
                
                currentPage = 0;
                updateStoryDisplay();
                
                document.getElementById('defaultPreview').style.display = 'none';
                document.getElementById('storyBook').style.display = 'block';
                document.getElementById('pageNavigation').style.display = 'block';
                document.getElementById('characterPreview').innerHTML = getThemeEmoji(theme);
                document.getElementById('downloadSection').style.display = 'block';
                
                showSuccess('üéâ Dom\'s story is ready! Use the navigation buttons to view all pages.');

            } catch (error) {
                console.error('Error:', error);
                showError(`Failed to generate story: ${error.message}`);
            } finally {
                btn.disabled = false;
                spinner.style.display = 'none';
                btnText.textContent = 'üé® Create Dom\'s Story!';
            }
        }

        function updateStoryDisplay() {
            if (!currentStoryData.pages) return;
            
            const storyPage = document.getElementById('storyPage');
            const storyTitle = document.getElementById('storyTitle');
            const storyText = document.getElementById('storyText');
            const pageIndicator = document.getElementById('pageIndicator');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            storyPage.style.backgroundImage = `url(${currentStoryData.imageUrl})`;
            storyTitle.textContent = currentStoryData.title;
            storyText.innerHTML = `<strong>Page ${currentPage + 1}:</strong> ${currentStoryData.pages[currentPage]}`;
            
            pageIndicator.textContent = `Page ${currentPage + 1} of ${currentStoryData.pages.length}`;
            prevBtn.disabled = currentPage === 0;
            nextBtn.disabled = currentPage === currentStoryData.pages.length - 1;
        }

        function previousPage() {
            if (currentPage > 0) {
                currentPage--;
                updateStoryDisplay();
            }
        }

        function nextPage() {
            if (currentPage < currentStoryData.pages.length - 1) {
                currentPage++;
                updateStoryDisplay();
            }
        }

        function getThemeEmoji(theme) {
            const emojis = {
                garden: 'üåª',
                space: 'üöÄ',
                ocean: 'üåä',
                castle: 'üè∞',
                pirate: 'üè¥‚Äç‚ò†Ô∏è'
            };
            return emojis[theme] || '‚ú®';
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        function showSuccess(message) {
            const successEl = document.getElementById('successMessage');
            successEl.textContent = message;
            successEl.style.display = 'block';
        }

        async function downloadPDF() {
            if (!currentStoryData.imageUrl) {
                alert('Please generate a story first!');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // Function to add colorful background
                function addBackground(pdf, pageNum) {
                    const colors = [
                        [255, 248, 220], // Light yellow
                        [240, 248, 255], // Light blue  
                        [245, 255, 250], // Light green
                        [255, 240, 245], // Light pink
                        [248, 248, 255]  // Light purple
                    ];
                    
                    const color = colors[pageNum % colors.length];
                    pdf.setFillColor(color[0], color[1], color[2]);
                    pdf.rect(0, 0, 210, 297, 'F');
                }
                
                // Cover page
                addBackground(pdf, 0);
                pdf.setTextColor(50, 50, 150);
                pdf.setFontSize(24);
                pdf.setFont(undefined, 'bold');
                pdf.text(currentStoryData.title, 105, 40, { align: 'center' });
                
                pdf.setFontSize(16);
                pdf.text(`A Story for ${currentStoryData.name}`, 105, 60, { align: 'center' });
                
                // Add the character image on cover
                try {
                    if (currentStoryData.imageUrl.startsWith('data:image/png')) {
                        // Add the canvas-generated image
                        pdf.addImage(currentStoryData.imageUrl, 'PNG', 55, 70, 100, 100);
                    } else {
                        // Fallback representation
                        pdf.setFillColor(255, 182, 193);
                        pdf.circle(105, 120, 50, 'F');
                        pdf.setFillColor(139, 69, 19);
                        pdf.rect(80, 95, 50, 25, 'F');
                        pdf.setFillColor(253, 188, 180);
                        pdf.circle(105, 120, 35, 'F');
                        pdf.setFillColor(0, 0, 0);
                        pdf.circle(95, 115, 3, 'F');
                        pdf.circle(115, 115, 3, 'F');
                        
                        pdf.setFontSize(14);
                        pdf.setTextColor(50, 50, 50);
                        pdf.text(`${currentStoryData.name} with beautiful black hair`, 105, 180, { align: 'center' });
                    }
                } catch (imageError) {
                    console.log('Using simple representation for image');
                    pdf.setFillColor(255, 182, 193);
                    pdf.circle(105, 120, 40, 'F');
                    pdf.setFillColor(139, 69, 19);
                    pdf.rect(85, 100, 40, 20, 'F');
                    pdf.setFontSize(14);
                    pdf.setTextColor(50, 50, 50);
                    pdf.text(`${currentStoryData.name}`, 105, 180, { align: 'center' });
                }
                
                // Add story pages
                currentStoryData.pages.forEach((pageText, index) => {
                    pdf.addPage();
                    
                    // Add background
                    addBackground(pdf, index + 1);
                    
                    // Page header
                    pdf.setTextColor(50, 50, 150);
                    pdf.setFontSize(18);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(`Page ${index + 1}`, 105, 30, { align: 'center' });
                    
                    // Character representation
                    try {
                        if (currentStoryData.imageUrl.startsWith('data:image/png')) {
                            // Add smaller version of the character image
                            pdf.addImage(currentStoryData.imageUrl, 'PNG', 75, 50, 60, 60);
                        } else {
                            // Simple drawn character
                            pdf.setFillColor(255, 182, 193);
                            pdf.circle(105, 80, 25, 'F');
                            pdf.setFillColor(139, 69, 19);
                            pdf.rect(90, 65, 30, 15, 'F');
                        }
                    } catch (e) {
                        // Fallback simple character
                        pdf.setFillColor(255, 182, 193);
                        pdf.circle(105, 80, 25, 'F');
                        pdf.setFillColor(139, 69, 19);
                        pdf.rect(90, 65, 30, 15, 'F');
                    }
                    
                    // Story text in a nice box
                    pdf.setFillColor(255, 255, 255, 0.9);
                    pdf.rect(20, 130, 170, 60, 'F');
                    pdf.setDrawColor(150, 150, 150);
                    pdf.rect(20, 130, 170, 60, 'S');
                    
                    // Add story text
                    pdf.setTextColor(50, 50, 50);
                    pdf.setFontSize(14);
                    pdf.setFont(undefined, 'normal');
                    const lines = pdf.splitTextToSize(pageText, 150);
                    let yPos = 150;
                    lines.forEach(line => {
                        if (yPos < 180) { // Make sure we don't go outside the box
                            pdf.text(line, 105, yPos, { align: 'center' });
                            yPos += 7;
                        }
                    });
                    
                    // Add decorations
                    pdf.setFontSize(20);
                    pdf.text('‚≠ê', 15, 50);
                    pdf.text('üåü', 180, 50);
                    pdf.text('‚ú®', 15, 150);
                    pdf.text('üí´', 180, 150);
                });
                
                // Save the PDF
                pdf.save(`${currentStoryData.name}_Visual_Story_Book.pdf`);
                alert('üìö PDF downloaded successfully! Check your downloads folder.');
                
            } catch (error) {
                console.error('PDF error:', error);
                alert('‚ùå PDF creation failed. Please try generating the story again.');
            }
        }

        // Update preview when theme changes
        document.getElementById('storyTheme').addEventListener('change', function() {
            document.getElementById('characterPreview').textContent = getThemeEmoji(this.value);
        });
    </script>
</body>
</html>
