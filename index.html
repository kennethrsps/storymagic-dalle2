<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryMagic Pro - AI-Powered Personalized Children's Books</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .hero-section {
            text-align: center;
            padding: 60px 20px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><defs><radialGradient id="a"><stop offset="20%" stop-color="%23FFF" stop-opacity="0.1"/><stop offset="100%" stop-color="%23FFF" stop-opacity="0"/></radialGradient></defs><circle fill="url(%23a)" cx="10" cy="10" r="10"/><circle fill="url(%23a)" cx="30" cy="5" r="8"/><circle fill="url(%23a)" cx="60" cy="15" r="6"/><circle fill="url(%23a)" cx="80" cy="8" r="12"/></svg>') repeat;
            animation: sparkle 3s linear infinite;
        }

        @keyframes sparkle {
            0% { transform: translateX(0); }
            100% { transform: translateX(100px); }
        }

        .hero-title {
            font-size: 3.5em;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }

        .hero-subtitle {
            font-size: 1.3em;
            margin-bottom: 15px;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        .hero-tagline {
            font-size: 1.1em;
            font-weight: 300;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }

        .pricing-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
            position: relative;
            z-index: 1;
        }

        .container {
            max-width: 1200px;
            margin: -30px auto 0;
            background: white;
            border-radius: 30px 30px 0 0;
            box-shadow: 0 -10px 50px rgba(0,0,0,0.2);
            position: relative;
            z-index: 2;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 700px;
        }

        .form-section {
            padding: 50px 40px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .preview-section {
            padding: 50px 40px;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .section-title {
            font-size: 2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            position: relative;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 3px;
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
            border-radius: 2px;
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 1em;
            font-family: inherit;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
            transform: translateY(-2px);
        }

        .character-customization {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .generate-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 18px 30px;
            border-radius: 25px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(78, 205, 196, 0.3);
        }

        .generate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(78, 205, 196, 0.4);
        }

        .generate-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .loading-spinner {
            display: none;
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            border: 3px solid transparent;
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translateY(-50%) rotate(0deg); }
            100% { transform: translateY(-50%) rotate(360deg); }
        }

        .story-book {
            display: none;
            width: 100%;
            height: 550px;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .story-book:hover {
            transform: scale(1.02);
        }

        .story-page {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .story-overlay {
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 85%;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.2);
            animation: fadeInUp 0.8s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .story-title {
            font-size: 2.2em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            font-weight: bold;
        }

        .story-text {
            font-size: 1.2em;
            line-height: 1.8;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .highlight {
            background: linear-gradient(120deg, #a8edea 0%, #fed6e3 100%);
            padding: 4px 10px;
            border-radius: 8px;
            font-weight: bold;
            color: #333;
            text-shadow: none;
        }

        .character-preview {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            margin: 0 auto 30px;
            background: linear-gradient(45deg, #ff9a9e, #fecfef);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5em;
            border: 6px solid white;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .character-preview::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .character-preview:hover::before {
            left: 100%;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            padding: 60px 40px;
            background: white;
        }

        .feature-card {
            text-align: center;
            padding: 30px 20px;
            border-radius: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-10px);
        }

        .feature-icon {
            font-size: 3em;
            margin-bottom: 20px;
        }

        .feature-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .pricing-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 80px 40px;
            text-align: center;
        }

        .pricing-card {
            background: white;
            color: #333;
            border-radius: 25px;
            padding: 50px 40px;
            max-width: 500px;
            margin: 0 auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        .pricing-badge-large {
            position: absolute;
            top: -10px;
            right: -10px;
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
            color: white;
            padding: 10px 30px;
            border-radius: 50px;
            font-weight: bold;
            transform: rotate(15deg);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .price {
            font-size: 4em;
            font-weight: bold;
            color: #4ecdc4;
            margin: 20px 0;
        }

        .price-subtitle {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 30px;
        }

        .buy-btn {
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
            color: white;
            border: none;
            padding: 20px 50px;
            border-radius: 50px;
            font-size: 1.4em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
        }

        .buy-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(255, 107, 107, 0.4);
        }

        .testimonial-section {
            padding: 80px 40px;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            text-align: center;
        }

        .testimonial {
            max-width: 800px;
            margin: 0 auto;
            font-size: 1.3em;
            font-style: italic;
            color: #333;
            margin-bottom: 30px;
        }

        .customer-name {
            font-weight: bold;
            color: #ff6b6b;
        }

        .success-message, .error-message {
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            display: none;
            font-weight: 500;
        }

        .success-message {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border-left: 5px solid #28a745;
        }

        .error-message {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border-left: 5px solid #dc3545;
        }

        .premium-features {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 30px;
        }

        .premium-features h4 {
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .premium-features ul {
            list-style: none;
            padding: 0;
        }

        .premium-features li {
            padding: 8px 0;
            position: relative;
            padding-left: 25px;
        }

        .premium-features li::before {
            content: '✨';
            position: absolute;
            left: 0;
        }

        .download-section {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: center;
            display: none;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .download-btn {
            background: white;
            color: #28a745;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .hero-title {
                font-size: 2.5em;
            }
            
            .character-customization {
                grid-template-columns: 1fr;
            }
            
            .story-overlay {
                padding: 25px;
                max-width: 95%;
            }
            
            .story-title {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <!-- Hero Section -->
    <div class="hero-section">
        <div class="pricing-badge">🎨 Professional AI Story Generator</div>
        <h1 class="hero-title">StoryMagic Pro</h1>
        <p class="hero-subtitle">Create Stunning Personalized Children's Books</p>
        <p class="hero-tagline">Each story is uniquely crafted with AI-generated illustrations that bring your child's imagination to life</p>
    </div>

    <div class="container">
        <div class="main-content">
            <div class="form-section">
                <h2 class="section-title">Create Your Story</h2>
                
                <div class="form-group">
                    <label for="childName">Child's Name</label>
                    <input type="text" id="childName" placeholder="Enter your child's name" value="Emma">
                </div>

                <div class="character-customization">
                    <div class="form-group">
                        <label for="childAge">Age</label>
                        <select id="childAge">
                            <option value="3">3 years old</option>
                            <option value="4">4 years old</option>
                            <option value="5">5 years old</option>
                            <option value="6" selected>6 years old</option>
                            <option value="7">7 years old</option>
                            <option value="8">8 years old</option>
                            <option value="9">9 years old</option>
                            <option value="10">10 years old</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="childGender">Character Type</label>
                        <select id="childGender">
                            <option value="child">Child</option>
                            <option value="brave boy">Brave Boy</option>
                            <option value="adventurous girl">Adventurous Girl</option>
                            <option value="young hero">Young Hero</option>
                            <option value="little explorer">Little Explorer</option>
                        </select>
                    </div>
                </div>

                <div class="character-customization">
                    <div class="form-group">
                        <label for="hairColor">Hair Color</label>
                        <select id="hairColor">
                            <option value="brown">Brown Hair</option>
                            <option value="blonde">Blonde Hair</option>
                            <option value="black">Black Hair</option>
                            <option value="red">Red Hair</option>
                            <option value="curly brown">Curly Brown</option>
                            <option value="long blonde">Long Blonde</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="eyeColor">Eye Color</label>
                        <select id="eyeColor">
                            <option value="brown">Brown Eyes</option>
                            <option value="blue">Blue Eyes</option>
                            <option value="green">Green Eyes</option>
                            <option value="hazel">Hazel Eyes</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="animalFriend">Animal Companion</label>
                    <select id="animalFriend">
                        <option value="magical butterfly">🦋 Magical Butterfly</option>
                        <option value="wise rabbit">🐰 Wise Rabbit</option>
                        <option value="loyal cat">🐱 Loyal Cat</option>
                        <option value="playful dog">🐶 Playful Dog</option>
                        <option value="friendly dragon">🐉 Friendly Dragon</option>
                        <option value="wise owl">🦉 Wise Owl</option>
                        <option value="gentle unicorn">🦄 Gentle Unicorn</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="storyTheme">Story Adventure</label>
                    <select id="storyTheme">
                        <option value="garden" selected>🌻 Magical Garden</option>
                        <option value="space">🚀 Space Adventure</option>
                        <option value="princess">👑 Royal Adventure</option>
                        <option value="ocean">🌊 Ocean Explorer</option>
                        <option value="forest">🌲 Enchanted Forest</option>
                        <option value="castle">🏰 Medieval Castle</option>
                        <option value="pirate">🏴‍☠️ Pirate Adventure</option>
                        <option value="dinosaur">🦕 Dinosaur World</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="customElements">Special Elements (Optional)</label>
                    <textarea id="customElements" rows="3" placeholder="Add special details: favorite colors, hobbies, or magical elements you'd like included..."></textarea>
                </div>

                <button class="generate-btn" onclick="generateStoryWithImage()" id="generateBtn">
                    <div class="loading-spinner" id="loadingSpinner"></div>
                    <span id="btnText">🎨 Generate Your Magical Story!</span>
                </button>

                <div class="premium-features">
                    <h4>✨ What You Get:</h4>
                    <ul>
                        <li>5-page personalized story book</li>
                        <li>Educational lessons on every page</li>
                        <li>Simple words perfect for toddlers</li>
                        <li>AI-generated custom artwork</li>
                        <li>Character looks like your child</li>
                        <li>Downloadable PDF for printing</li>
                        <li>Perfect bedtime story length</li>
                    </ul>
                </div>

                <div class="success-message" id="successMessage"></div>
                <div class="error-message" id="errorMessage"></div>
                
                <!-- Download Section -->
                <div class="download-section" id="downloadSection">
                    <h4 style="margin-bottom: 15px;">📥 Download Your Story</h4>
                    <p style="margin-bottom: 20px;">Your personalized story is ready!</p>
                    <button class="download-btn" onclick="downloadPDF()">📄 Download PDF Book</button>
                    <button class="download-btn" onclick="downloadImage()">🖼️ Download Image Only</button>
                    <p style="font-size: 0.9em; margin-top: 15px; opacity: 0.8;">Perfect for printing, sharing, or keeping as a digital keepsake!</p>
                </div>
            </div>

            <div class="preview-section">
                <div class="character-preview" id="characterPreview">
                    🌻
                </div>

                <div class="story-book" id="storyBook">
                    <div class="story-page" id="storyPage">
                        <div class="story-overlay">
                            <div class="story-title" id="storyTitle">Your Story Title</div>
                            <div class="story-text" id="storyText">Your personalized story will appear here...</div>
                        </div>
                    </div>
                </div>

                <div id="defaultPreview" style="text-align: center;">
                    <h3 style="color: #333; margin-bottom: 20px; font-size: 1.5em;">AI Story Preview</h3>
                    <p style="color: #666; font-size: 1.1em; line-height: 1.6;">Generate your story to see the AI image as background with your personalized text overlay!</p>
                    <p style="color: #999; font-size: 0.9em; margin-top: 15px;">Each story is completely unique and crafted specifically for your child.</p>
                </div>
            </div>
        </div>

        <!-- Features Section -->
        <div class="features-grid">
            <div class="feature-card">
                <div class="feature-icon">🎨</div>
                <div class="feature-title">AI-Generated Art</div>
                <p>Each illustration is created by advanced AI technology, ensuring your child's story is completely unique and personalized.</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">📚</div>
                <div class="feature-title">Custom Stories</div>
                <p>Stories adapt to your child's age, interests, and appearance, creating a truly personalized reading experience.</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">✨</div>
                <div class="feature-title">Premium Quality</div>
                <p>High-resolution images perfect for printing, sharing, or creating physical books that will last a lifetime.</p>
            </div>
        </div>
    </div>

    <!-- Testimonial Section -->
    <div class="testimonial-section">
        <h2 style="font-size: 2.5em; margin-bottom: 40px; color: #333;">What Parents Are Saying</h2>
        <div class="testimonial">
            "My daughter was absolutely amazed to see herself as the main character! The AI artwork is stunning and the story quality is incredible. Worth every penny!"
        </div>
        <div class="customer-name">- Sarah M., Mother of 6-year-old</div>
    </div>

    <!-- Pricing Section -->
    <div class="pricing-section">
        <h2 style="font-size: 3em; margin-bottom: 30px;">Create Magic Today</h2>
        <div class="pricing-card">
            <div class="pricing-badge-large">POPULAR</div>
            <h3 style="font-size: 2em; margin-bottom: 20px;">Premium Story Package</h3>
            <div class="price">$12.99</div>
            <div class="price-subtitle">One-time payment • Instant delivery</div>
            <ul style="text-align: left; margin: 30px 0; line-height: 2;">
                <li>✅ 5-page personalized story book</li>
                <li>✅ Educational lessons on every page</li>
                <li>✅ Simple language perfect for toddlers</li>
                <li>✅ Character customized to look like your child</li>
                <li>✅ High-resolution AI artwork</li>
                <li>✅ Downloadable PDF ready for printing</li>
                <li>✅ Perfect 5-minute bedtime story</li>
                <li>✅ 8 different adventure themes</li>
            </ul>
            <button class="buy-btn" onclick="purchaseStory()">🛒 Buy Now - $12.99</button>
            <p style="margin-top: 20px; color: #666; font-size: 0.9em;">30-day money-back guarantee</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Global variables to store current story data
        let currentStoryData = {};

        // Enhanced story templates with multi-page structure for toddlers
        const storyTemplates = {
            garden: {
                title: "{name}'s Magic Garden",
                pages: [
                    {
                        text: "<span class='highlight'>{name}</span> found a sad garden. The flowers were wilting.",
                        lesson: "Sometimes things need our help.",
                        prompt: "A {age}-year-old {gender} named {name} with {hair} and {eyes} looking at wilted flowers in a garden, accompanied by {animalFriend}, simple toddler book illustration, bright colors, sad flowers"
                    },
                    {
                        text: "'{animalFriend}, how can we help?' asked <span class='highlight'>{name}</span>.",
                        lesson: "It's good to ask for help and ideas.",
                        prompt: "{name} talking to {animalFriend} in the garden, both looking thoughtful, toddler book style, simple and colorful"
                    },
                    {
                        text: "<span class='highlight'>{name}</span> watered the flowers every day. Drop by drop.",
                        lesson: "Small actions can make a big difference.",
                        prompt: "{name} with a small watering can, gently watering colorful flowers, {animalFriend} helping, toddler book illustration, cheerful scene"
                    },
                    {
                        text: "The flowers smiled! 'Thank you, <span class='highlight'>{name}</span>!' they said.",
                        lesson: "Kindness makes others happy.",
                        prompt: "Beautiful blooming flowers with happy faces talking to {name} and {animalFriend}, magical garden scene, bright colors, joyful toddler book style"
                    },
                    {
                        text: "<span class='highlight'>{name}</span> learned that caring for others is magical!",
                        lesson: "Taking care of others feels wonderful.",
                        prompt: "{name} and {animalFriend} in a beautiful, thriving magical garden with rainbow flowers and butterflies, celebration scene, toddler book illustration"
                    }
                ],
                mainPrompt: "A beautiful magical garden with talking flowers, colorful butterflies, and a happy {age}-year-old {gender} named {name} with {hair} and {eyes}, accompanied by a {animalFriend}, watering glowing plants, fantasy children's book illustration, vibrant colors, whimsical and enchanting, detailed character features, professional storybook art style"
            },
            space: {
                title: "Captain {name} Goes to Space",
                pages: [
                    {
                        text: "<span class='highlight'>{name}</span> put on a special space suit. 'Ready for adventure!'",
                        lesson: "Getting ready is important for big adventures.",
                        prompt: "{name} putting on a colorful space suit with {animalFriend} wearing a tiny helmet, toddler book illustration, exciting preparation scene"
                    },
                    {
                        text: "The rocket went WHOOSH! Up, up, up to the stars!",
                        lesson: "Dreams can take us far away.",
                        prompt: "{name} and {animalFriend} in a rocket ship flying past stars and planets, toddler book style, simple and magical"
                    },
                    {
                        text: "<span class='highlight'>{name}</span> met friendly aliens. 'Hello!' they all said.",
                        lesson: "Being friendly helps us make new friends.",
                        prompt: "{name} and {animalFriend} meeting colorful, friendly alien creatures on a planet, toddler book illustration, welcoming scene"
                    },
                    {
                        text: "Together they played space games and shared space snacks.",
                        lesson: "Sharing makes friendship stronger.",
                        prompt: "{name}, {animalFriend}, and alien friends playing together and sharing colorful space food, happy toddler book scene"
                    },
                    {
                        text: "<span class='highlight'>{name}</span> learned friendship works everywhere in the universe!",
                        lesson: "Friends are special wherever you go.",
                        prompt: "{name} and {animalFriend} waving goodbye to alien friends from their rocket, space scene with hearts and stars, toddler book style"
                    }
                ],
                mainPrompt: "A young {age}-year-old {gender} astronaut named {name} with {hair} and {eyes} in a colorful space suit floating among stars, planets, and nebulas, accompanied by a {animalFriend} in a tiny space helmet, children's book illustration, cosmic and magical, detailed facial features"
            },
            princess: {
                title: "{name} the Kind Royal",
                pages: [
                    {
                        text: "Princess <span class='highlight'>{name}</span> lived in a beautiful castle with {animalFriend}.",
                        lesson: "Everyone has a special place they call home.",
                        prompt: "{name} wearing a simple crown in a colorful castle with {animalFriend}, toddler book illustration, royal but cozy scene"
                    },
                    {
                        text: "The kingdom's colors started fading away. Everything looked sad.",
                        lesson: "Sometimes things go wrong and that's okay.",
                        prompt: "A kingdom with fading colors, {name} and {animalFriend} looking concerned but determined, toddler book style"
                    },
                    {
                        text: "<span class='highlight'>{name}</span> decided to help. 'Let's spread kindness everywhere!'",
                        lesson: "We can choose to help when things are difficult.",
                        prompt: "{name} and {animalFriend} walking through the kingdom with hearts floating around them, toddler book illustration"
                    },
                    {
                        text: "Every kind word brought colors back. Red! Blue! Yellow!",
                        lesson: "Kind words have magical power.",
                        prompt: "{name} speaking to people with colorful words floating in the air, bringing colors back to buildings, magical toddler scene"
                    },
                    {
                        text: "<span class='highlight'>{name}</span> learned that kindness is the most royal thing of all!",
                        lesson: "Being kind makes you truly special.",
                        prompt: "{name} and {animalFriend} in a colorful, restored kingdom with happy people celebrating, toddler book illustration, joyful scene"
                    }
                ],
                mainPrompt: "A young {age}-year-old royal {gender} named {name} with {hair} and {eyes} in a beautiful crystal palace with rainbow reflections, wearing elegant royal clothes, accompanied by a {animalFriend}, surrounded by magical crystal formations, children's book illustration, sparkly and majestic, detailed character portrait"
            },
            ocean: {
                title: "{name}'s Ocean Adventure",
                pages: [
                    {
                        text: "<span class='highlight'>{name}</span> and {animalFriend} dove into the blue ocean.",
                        lesson: "It's fun to explore new places.",
                        prompt: "{name} and {animalFriend} diving into clear blue water, bubbles around them, toddler book illustration, underwater adventure beginning"
                    },
                    {
                        text: "A little fish was crying. 'I'm lost!' she said.",
                        lesson: "Sometimes others need our help.",
                        prompt: "{name} and {animalFriend} meeting a sad little fish underwater, coral reef background, toddler book style, gentle scene"
                    },
                    {
                        text: "'Don't worry,' said <span class='highlight'>{name}</span>. 'We'll help you find home.'",
                        lesson: "Helping others feels good.",
                        prompt: "{name} comforting the little fish while {animalFriend} looks encouraging, underwater scene, toddler book illustration"
                    },
                    {
                        text: "They swam together until they found the fish's family.",
                        lesson: "Working together helps us succeed.",
                        prompt: "{name}, {animalFriend}, and the little fish swimming together past colorful coral, toddler book style, teamwork scene"
                    },
                    {
                        text: "'Thank you!' said all the fish. <span class='highlight'>{name}</span> felt so happy!",
                        lesson: "Helping others makes us happy too.",
                        prompt: "{name} and {animalFriend} surrounded by grateful fish families, underwater celebration, colorful coral reef, toddler book illustration"
                    }
                ],
                mainPrompt: "A cheerful {age}-year-old {gender} named {name} with {hair} and {eyes} swimming underwater with colorful fish, dolphins, and sea turtles, accompanied by a {animalFriend}, in a vibrant coral reef, magical underwater scene, children's book illustration, bright and oceanic, detailed character swimming"
            },
            forest: {
                title: "{name} and the Forest Friends",
                pages: [
                    {
                        text: "<span class='highlight'>{name}</span> and {animalFriend} walked into the green forest.",
                        lesson: "Nature is beautiful and full of life.",
                        prompt: "{name} and {animalFriend} entering a lush green forest with tall trees, toddler book illustration, peaceful forest scene"
                    },
                    {
                        text: "They heard crying. Baby animals couldn't find their way home.",
                        lesson: "It's important to listen when others need help.",
                        prompt: "{name} and {animalFriend} finding small crying animals like baby rabbits and squirrels, forest setting, toddler book style"
                    },
                    {
                        text: "'Follow me!' said <span class='highlight'>{name}</span>. 'I know the way!'",
                        lesson: "Being brave helps us help others.",
                        prompt: "{name} leading baby animals through the forest with {animalFriend}, determined and caring expression, toddler book illustration"
                    },
                    {
                        text: "One by one, each baby found their family. Hugs everywhere!",
                        lesson: "Families love each other very much.",
                        prompt: "Baby animals reuniting with their parents, lots of hugs and joy, {name} and {animalFriend} watching happily, forest scene, toddler book style"
                    },
                    {
                        text: "<span class='highlight'>{name}</span> learned that helping brings everyone together!",
                        lesson: "Helping others creates a happy community.",
                        prompt: "All the forest animals having a celebration with {name} and {animalFriend}, forest party scene, toddler book illustration, joyful ending"
                    }
                ],
                mainPrompt: "A brave {age}-year-old {gender} named {name} with {hair} and {eyes} in an enchanted forest with talking animals like rabbits, deer, and owls, accompanied by a {animalFriend}, magical trees with glowing leaves, children's book illustration, warm and mystical, detailed character in forest setting"
            },
            castle: {
                title: "Brave Knight {name}",
                pages: [
                    {
                        text: "Knight <span class='highlight'>{name}</span> put on shiny armor. 'Time to help!'",
                        lesson: "Getting ready helps us do our best.",
                        prompt: "{name} putting on colorful knight armor with {animalFriend} helping, castle background, toddler book illustration, preparation scene"
                    },
                    {
                        text: "A dragon was sad. 'Everyone runs away from me,' he cried.",
                        lesson: "Sometimes others feel lonely and different.",
                        prompt: "{name} and {animalFriend} meeting a gentle, sad dragon, castle courtyard, toddler book style, empathetic scene"
                    },
                    {
                        text: "'I won't run,' said <span class='highlight'>{name}</span>. 'Want to be friends?'",
                        lesson: "Being brave means being kind, not fighting.",
                        prompt: "{name} extending a hand in friendship to the dragon, {animalFriend} encouraging, toddler book illustration, friendship moment"
                    },
                    {
                        text: "The dragon smiled! They played games and had so much fun.",
                        lesson: "Friends can be different from us and that's wonderful.",
                        prompt: "{name}, {animalFriend}, and the happy dragon playing together in the castle courtyard, toddler book style, joyful play scene"
                    },
                    {
                        text: "<span class='highlight'>{name}</span> learned that real knights make friends, not enemies!",
                        lesson: "True courage is about kindness and friendship.",
                        prompt: "{name} and {animalFriend} and the dragon all together as friends, castle celebration scene, toddler book illustration, happy ending"
                    }
                ],
                mainPrompt: "A young {age}-year-old {gender} knight named {name} with {hair} and {eyes} in medieval armor standing before a grand castle, accompanied by a {animalFriend}, medieval fantasy setting, children's book illustration, heroic and inspiring, detailed character in knight costume"
            },
            pirate: {
                title: "Captain {name}'s Treasure",
                pages: [
                    {
                        text: "Captain <span class='highlight'>{name}</span> and {animalFriend} set sail on their boat.",
                        lesson: "Adventures are more fun with friends.",
                        prompt: "{name} wearing a colorful pirate hat on a friendly pirate ship with {animalFriend}, ocean scene, toddler book illustration, adventure beginning"
                    },
                    {
                        text: "They found a treasure map! 'X marks the spot!'",
                        lesson: "Maps and clues help us find what we're looking for.",
                        prompt: "{name} and {animalFriend} looking at a colorful treasure map, excited expressions, toddler book style, discovery scene"
                    },
                    {
                        text: "On the island, they met other pirates who looked hungry.",
                        lesson: "Sometimes people need help even if they look different.",
                        prompt: "{name} and {animalFriend} meeting friendly but hungry pirates on a tropical island, toddler book illustration, meeting scene"
                    },
                    {
                        text: "<span class='highlight'>{name}</span> shared their treasure food with everyone!",
                        lesson: "Sharing treasure makes everyone happy.",
                        prompt: "{name} sharing food from a treasure chest with all the pirates, everyone eating and smiling, island picnic scene, toddler book style"
                    },
                    {
                        text: "<span class='highlight'>{name}</span> learned that sharing treasure is the best treasure of all!",
                        lesson: "The best treasures are the ones we share.",
                        prompt: "All the pirates celebrating together with {name} and {animalFriend}, treasure chest of food in the middle, tropical island, toddler book illustration, happy sharing scene"
                    }
                ],
                mainPrompt: "A young {age}-year-old {gender} pirate captain named {name} with {hair} and {eyes} on a pirate ship with treasure chests, accompanied by a {animalFriend} wearing a tiny pirate hat, ocean adventure scene, children's book illustration, adventurous and fun, detailed pirate character"
            },
            dinosaur: {
                title: "{name} Meets the Dinosaurs",
                pages: [
                    {
                        text: "<span class='highlight'>{name}</span> found a magic door. Behind it were... DINOSAURS!",
                        lesson: "New discoveries can be exciting and surprising.",
                        prompt: "{name} and {animalFriend} discovering a magical door leading to a dinosaur world, toddler book illustration, wonder and excitement"
                    },
                    {
                        text: "A baby dinosaur was crying. 'I can't reach the tall leaves!'",
                        lesson: "Sometimes being small makes things hard.",
                        prompt: "{name} and {animalFriend} meeting a small, sad baby dinosaur looking up at tall trees, prehistoric setting, toddler book style"
                    },
                    {
                        text: "'I have an idea!' said <span class='highlight'>{name}</span>. 'Let's work together!'",
                        lesson: "Good ideas come when we want to help.",
                        prompt: "{name} having a bright idea, lightbulb floating above head, {animalFriend} and baby dinosaur listening, toddler book illustration"
                    },
                    {
                        text: "{animalFriend} climbed on <span class='highlight'>{name}</span>, who climbed on the dinosaur!",
                        lesson: "Teamwork helps us reach higher than we can alone.",
                        prompt: "{name}, {animalFriend}, and baby dinosaur stacked up reaching for leaves, funny and helpful teamwork scene, toddler book style"
                    },
                    {
                        text: "They all munched leaves together. <span class='highlight'>{name}</span> learned teamwork is prehistoric-ally awesome!",
                        lesson: "Working together makes everything better.",
                        prompt: "{name}, {animalFriend}, and baby dinosaur eating leaves together happily, other dinosaurs joining the feast, prehistoric celebration, toddler book illustration"
                    }
                ],
                mainPrompt: "A {age}-year-old {gender} named {name} with {hair} and {eyes} surrounded by friendly dinosaurs in a prehistoric landscape with volcanoes and ancient plants, accompanied by a {animalFriend}, children's book illustration, exciting and educational, detailed character with dinosaurs"
            }
        };

        async function generateStoryWithImage() {
            const name = document.getElementById('childName').value || 'Emma';
            const age = document.getElementById('childAge').value;
            const gender = document.getElementById('childGender').value;
            const hair = document.getElementById('hairColor').value;
            const eyes = document.getElementById('eyeColor').value;
            const animalFriend = document.getElementById('animalFriend').value;
            const theme = document.getElementById('storyTheme').value;
            const customElements = document.getElementById('customElements').value;
            
            // Show loading state
            const btn = document.getElementById('generateBtn');
            const spinner = document.getElementById('loadingSpinner');
            const btnText = document.getElementById('btnText');
            
            btn.disabled = true;
            spinner.style.display = 'block';
            btnText.textContent = 'Creating Your Magical Story...';

            // Hide messages
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';

            try {
                const story = storyTemplates[theme];
                let prompt = story.prompt
                    .replace(/{name}/g, name)
                    .replace(/{age}/g, age)
                    .replace(/{gender}/g, gender)
                    .replace(/{hair}/g, hair)
                    .replace(/{eyes}/g, eyes)
                    .replace(/{animalFriend}/g, animalFriend);
                
                // Add custom elements if provided
                if (customElements.trim()) {
                    prompt += `, ${customElements}`;
                }
                
                const response = await fetch('/api/generate-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt: prompt })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `HTTP ${response.status}`);
                }

                const data = await response.json();
                const imageUrl = data.data[0].url;

                // Update story display with AI image as background
                const storyPage = document.getElementById('storyPage');
                const storyTitle = document.getElementById('storyTitle');
                const storyText = document.getElementById('storyText');
                
                storyPage.style.backgroundImage = `url(${imageUrl})`;
                storyTitle.textContent = story.title
                    .replace(/{name}/g, name)
                    .replace(/{age}/g, age);
                storyText.innerHTML = story.text
                    .replace(/{name}/g, name)
                    .replace(/{age}/g, age)
                    .replace(/{gender}/g, gender)
                    .replace(/{hair}/g, hair)
                    .replace(/{eyes}/g, eyes)
                    .replace(/{animalFriend}/g, animalFriend);

                // Show the story book
                document.getElementById('defaultPreview').style.display = 'none';
                document.getElementById('storyBook').style.display = 'block';

                // Update character preview
                document.getElementById('characterPreview').innerHTML = getThemeEmoji(theme);

                // Show success message with download options
                showSuccess('🎉 Your magical story has been created! Click the image to view full size.');
                
                // Store story data for download
                currentStoryData = {
                    imageUrl: imageUrl,
                    title: story.title.replace(/{name}/g, name).replace(/{age}/g, age),
                    text: story.text.replace(/{name}/g, name).replace(/{age}/g, age).replace(/{gender}/g, gender).replace(/{hair}/g, hair).replace(/{eyes}/g, eyes).replace(/{animalFriend}/g, animalFriend),
                    name: name,
                    age: age,
                    theme: theme
                };
                
                // Show download section
                document.getElementById('downloadSection').style.display = 'block';

            } catch (error) {
                console.error('Error:', error);
                showError(`Failed to generate story: ${error.message}`);
            } finally {
                // Reset button state
                btn.disabled = false;
                spinner.style.display = 'none';
                btnText.textContent = '🎨 Generate Your Magical Story!';
            }
        }

        function getThemeEmoji(theme) {
            const emojis = {
                garden: '🌻',
                space: '🚀',
                princess: '👑',
                ocean: '🌊',
                forest: '🌲',
                castle: '🏰',
                pirate: '🏴‍☠️',
                dinosaur: '🦕'
            };
            return emojis[theme] || '✨';
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 8000);
        }

        function showSuccess(message) {
            const successEl = document.getElementById('successMessage');
            successEl.textContent = message;
            successEl.style.display = 'block';
            setTimeout(() => {
                successEl.style.display = 'none';
            }, 5000);
        }

        function purchaseStory() {
            // This would integrate with your payment processor
            alert('🛒 Redirecting to secure checkout...\n\nIn a real implementation, this would connect to:\n• Stripe\n• PayPal\n• Square\n• or your preferred payment processor');
        }

        async function downloadPDF() {
            if (!currentStoryData.imageUrl) {
                alert('Please generate a story first!');
                return;
            }

            try {
                // Create PDF using jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // Cover page
                pdf.setFontSize(28);
                pdf.setFont(undefined, 'bold');
                pdf.text(currentStoryData.title, 105, 40, { align: 'center' });
                
                pdf.setFontSize(16);
                pdf.setFont(undefined, 'normal');
                pdf.text(`A Story for ${currentStoryData.name}`, 105, 60, { align: 'center' });
                
                // Add main image to cover
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = function() {
                    // Cover image
                    const imgWidth = 120;
                    const imgHeight = 120;
                    const x = (210 - imgWidth) / 2;
                    
                    pdf.addImage(img, 'JPEG', x, 80, imgWidth, imgHeight);
                    
                    // Add story pages
                    currentStoryData.pages.forEach((page, index) => {
                        pdf.addPage();
                        
                        // Page number
                        pdf.setFontSize(12);
                        pdf.setFont(undefined, 'normal');
                        pdf.text(`Page ${index + 1}`, 105, 20, { align: 'center' });
                        
                        // Story text (large, simple font for toddlers)
                        pdf.setFontSize(18);
                        pdf.setFont(undefined, 'bold');
                        const cleanText = page.text.replace(/<[^>]*>/g, '');
                        const lines = pdf.splitTextToSize(cleanText, 170);
                        
                        let yPosition = 50;
                        lines.forEach(line => {
                            pdf.text(line, 105, yPosition, { align: 'center' });
                            yPosition += 12;
                        });
                        
                        // Lesson box
                        pdf.setFillColor(255, 248, 220); // Light yellow background
                        pdf.rect(20, yPosition + 20, 170, 30, 'F');
                        
                        pdf.setFontSize(14);
                        pdf.setFont(undefined, 'italic');
                        pdf.text('💡 What we learned:', 25, yPosition + 35);
                        
                        pdf.setFontSize(12);
                        pdf.setFont(undefined, 'normal');
                        const lessonLines = pdf.splitTextToSize(page.lesson, 160);
                        pdf.text(lessonLines, 25, yPosition + 45);
                        
                        // Add decorative elements for toddlers
                        pdf.setFontSize(20);
                        pdf.text('⭐', 180, yPosition + 10);
                        pdf.text('🌟', 25, yPosition + 10);
                    });
                    
                    // Back cover with all lessons summary
                    pdf.addPage();
                    pdf.setFontSize(20);
                    pdf.setFont(undefined, 'bold');
                    pdf.text('What We Learned Together! 📚', 105, 30, { align: 'center' });
                    
                    pdf.setFontSize(12);
                    pdf.setFont(undefined, 'normal');
                    
                    let lessonY = 60;
                    currentStoryData.pages.forEach((page, index) => {
                        pdf.text(`${index + 1}. ${page.lesson}`, 20, lessonY);
                        lessonY += 15;
                    });
                    
                    // Footer
                    pdf.setFontSize(10);
                    pdf.setFont(undefined, 'italic');
                    pdf.text('Created with love by StoryMagic Pro 💖', 105, 280, { align: 'center' });
                    
                    // Download the PDF
                    pdf.save(`${currentStoryData.name}_${currentStoryData.theme}_StoryBook.pdf`);
                };
                
                img.onerror = function() {
                    // Fallback: Create PDF without image but with all story content
                    currentStoryData.pages.forEach((page, index) => {
                        if (index > 0) pdf.addPage();
                        
                        pdf.setFontSize(18);
                        pdf.setFont(undefined, 'bold');
                        pdf.text(`Page ${index + 1}`, 105, 30, { align: 'center' });
                        
                        const cleanText = page.text.replace(/<[^>]*>/g, '');
                        const lines = pdf.splitTextToSize(cleanText, 170);
                        pdf.text(lines, 20, 60);
                        
                        pdf.setFontSize(12);
                        pdf.text(`Lesson: ${page.lesson}`, 20, 120);
                    });
                    
                    pdf.save(`${currentStoryData.name}_${currentStoryData.theme}_StoryBook.pdf`);
                };
                
                img.src = currentStoryData.imageUrl;
                
            } catch (error) {
                console.error('PDF generation error:', error);
                alert('PDF generation failed. Please try again.');
            }
        }

        async function downloadImage() {
            if (!currentStoryData.imageUrl) {
                alert('Please generate a story first!');
                return;
            }

            try {
                // Download the image
                const link = document.createElement('a');
                link.href = currentStoryData.imageUrl;
                link.download = `${currentStoryData.name}_${currentStoryData.theme}_story.jpg`;
                link.click();
            } catch (error) {
                console.error('Image download error:', error);
                alert('Image download failed. Please right-click the image and save it manually.');
            }
        }

        // Update character preview when theme changes
        document.getElementById('storyTheme').addEventListener('change', function() {
            document.getElementById('characterPreview').textContent = getThemeEmoji(this.value);
        });

        // Add some interactive effects
        document.addEventListener('DOMContentLoaded', function() {
            // Add hover effects to form inputs
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    this.parentElement.style.transform = 'translateY(-2px)';
                });
                input.addEventListener('blur', function() {
                    this.parentElement.style.transform = 'translateY(0)';
                });
            });
        });
    </script>
</body>
</html>
